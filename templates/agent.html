<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Coachd</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#F5F5F7">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root{--color-bg:#F5F5F7;--color-glass:rgba(255,255,255,0.65);--color-glass-strong:rgba(255,255,255,0.85);--color-glass-border:rgba(255,255,255,0.4);--color-border:rgba(0,0,0,0.06);--color-text:#1A1A1A;--color-text-secondary:#6B7280;--color-text-muted:#9CA3AF;--color-accent:#3B82F6;--color-accent-soft:rgba(59,130,246,0.12);--color-success:#10B981;--color-success-soft:rgba(16,185,129,0.12);--color-error:#EF4444;--font-display:'Outfit',sans-serif;--font-body:'Inter',sans-serif;--blur:blur(24px);--blur-strong:blur(40px);--shadow-glass:0 8px 32px rgba(0,0,0,0.06);--radius-sm:12px;--radius-md:16px;--radius-lg:24px;--radius-full:9999px;--safe-bottom:env(safe-area-inset-bottom,0px);--sidebar-width:72px}
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}html,body{height:100%;overflow:hidden}body{background:var(--color-bg);color:var(--color-text);font-family:var(--font-body);-webkit-font-smoothing:antialiased}
        .screen{display:none;height:100%}.screen.active{display:flex}

        /* ===== AUTH SCREENS (Landing, Phone, Verify, Profile) ===== */
        .auth-screen{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 24px;position:relative}
        .auth-logo{margin-bottom:12px}
        .auth-tagline{font-size:1.05rem;font-weight:400;color:var(--color-text-secondary);margin-bottom:48px}
        .auth-title{font-family:var(--font-display);font-size:1.5rem;font-weight:600;margin-bottom:8px;text-align:center}
        .auth-subtitle{font-size:0.95rem;color:var(--color-text-secondary);margin-bottom:32px;text-align:center;max-width:300px}
        
        .input-wrapper{margin-bottom:24px;width:100%;max-width:280px}
        .input-label{display:block;font-size:0.8rem;font-weight:500;color:var(--color-text-secondary);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.05em}
        .auth-input{width:100%;padding:18px 24px;background:transparent;border:1.5px solid var(--color-border);border-radius:var(--radius-md);font-family:var(--font-body);font-size:1rem;font-weight:500;text-align:center;letter-spacing:0.05em;color:var(--color-text);transition:all 0.2s}
        .auth-input::placeholder{color:var(--color-text-muted);font-weight:400}
        .auth-input:focus{outline:none;border-color:var(--color-accent);box-shadow:0 0 0 3px var(--color-accent-soft)}
        .auth-input.error{border-color:var(--color-error);box-shadow:0 0 0 3px rgba(239,68,68,0.1);animation:shake 0.4s}
        .auth-input.code-input{text-transform:uppercase;letter-spacing:0.15em}
        .auth-input.phone-input{letter-spacing:0.02em}
        .auth-input.name-input{text-align:left;text-transform:capitalize}
        
        @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-8px)}75%{transform:translateX(8px)}}
        
        .btn-primary{display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:16px 40px;background:var(--color-text);color:white;font-family:var(--font-display);font-size:0.95rem;font-weight:600;letter-spacing:0.01em;border:none;border-radius:var(--radius-full);cursor:pointer;transition:all 0.2s;min-height:54px;box-shadow:0 2px 8px rgba(0,0,0,0.12),0 1px 3px rgba(0,0,0,0.08)}
        .btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
        .btn-primary:disabled{opacity:0.5;cursor:not-allowed;transform:none;box-shadow:none}
        .btn-primary svg{width:18px;height:18px;opacity:0.9}
        
        .btn-secondary{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 24px;background:transparent;color:var(--color-text-secondary);font-family:var(--font-body);font-size:0.9rem;font-weight:500;border:none;cursor:pointer;transition:all 0.2s}
        .btn-secondary:hover{color:var(--color-text)}
        .btn-secondary:disabled{opacity:0.5;cursor:not-allowed}
        
        .auth-footer{position:absolute;bottom:24px;left:0;right:0;text-align:center}
        .auth-footer-text{font-size:0.75rem;color:var(--color-text-muted);margin-bottom:8px}
        .auth-footer-links{display:flex;justify-content:center;gap:16px}
        .auth-footer-links a{font-size:0.7rem;color:var(--color-text-muted);text-decoration:none}
        .auth-footer-links a:hover{color:var(--color-text-secondary)}
        
        /* Back button */
        .back-btn{position:absolute;top:24px;left:24px;width:44px;height:44px;display:flex;align-items:center;justify-content:center;background:var(--color-glass);backdrop-filter:var(--blur);border:1px solid var(--color-glass-border);border-radius:var(--radius-sm);color:var(--color-text-secondary);cursor:pointer;transition:all 0.2s}
        .back-btn:hover{background:var(--color-glass-strong);color:var(--color-text)}
        .back-btn svg{width:20px;height:20px}
        
        /* Verification code input */
        .verify-code-input{font-size:1.5rem;letter-spacing:0.3em;font-weight:600}
        
        /* Resend button */
        .resend-wrapper{margin-top:16px;text-align:center}
        .resend-btn{font-size:0.85rem;color:var(--color-accent);background:none;border:none;cursor:pointer;padding:8px 16px}
        .resend-btn:disabled{color:var(--color-text-muted);cursor:not-allowed}
        
        /* Loading spinner */
        .spinner{width:20px;height:20px;border:2px solid rgba(255,255,255,0.3);border-top-color:white;border-radius:50%;animation:spin 0.8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        
        /* Success checkmark */
        .success-icon{width:64px;height:64px;background:var(--color-success-soft);border-radius:50%;display:flex;align-items:center;justify-content:center;margin-bottom:24px}
        .success-icon svg{width:32px;height:32px;color:var(--color-success)}
        
        /* Name inputs row */
        .name-row{display:flex;gap:12px;width:100%;max-width:320px;margin-bottom:24px}
        .name-row .input-wrapper{flex:1;margin-bottom:0}
        
        /* Inline error text */
        .input-error{font-size:0.8rem;color:var(--color-error);margin-top:8px;text-align:center;opacity:0;height:0;overflow:hidden;transition:all 0.2s}
        .input-error.show{opacity:1;height:auto;margin-top:10px}

        /* ===== DASHBOARD SCREEN ===== */
        .dashboard-screen{flex-direction:row;position:relative}

        /* ===== SIDEBAR (Desktop) ===== */
        .sidebar{width:var(--sidebar-width);background:var(--color-glass);backdrop-filter:var(--blur-strong);border-right:1px solid var(--color-border);display:flex;flex-direction:column;align-items:center;padding:20px 0;position:fixed;top:0;left:0;height:100vh;z-index:100}
        .sidebar-logo{width:40px;height:40px;margin-bottom:32px}
        .sidebar-logo img{width:100%;height:100%}
        .sidebar-nav{flex:1;display:flex;flex-direction:column;align-items:center;gap:8px;padding:0 12px}
        .nav-item{width:48px;height:48px;display:flex;align-items:center;justify-content:center;border:none;border-radius:var(--radius-sm);background:transparent;color:var(--color-text-muted);cursor:pointer;transition:all 0.15s;text-decoration:none;position:relative}
        .nav-item:hover{background:rgba(255,255,255,0.5);color:var(--color-text)}
        .nav-item.active{background:var(--color-accent-soft);color:var(--color-accent)}
        .nav-item svg{width:22px;height:22px}
        .nav-item::after{content:attr(data-tooltip);position:absolute;left:calc(100% + 12px);padding:8px 12px;background:var(--color-text);color:white;font-size:0.8rem;font-weight:500;border-radius:8px;white-space:nowrap;opacity:0;visibility:hidden;transition:all 0.15s;pointer-events:none}
        .nav-item:hover::after{opacity:1;visibility:visible}
        .sidebar-footer{padding:0 12px;display:flex;flex-direction:column;align-items:center;gap:8px}
        .user-avatar{width:40px;height:40px;border-radius:50%;background:var(--color-accent-soft);color:var(--color-accent);display:flex;align-items:center;justify-content:center;font-weight:600;font-size:0.85rem}

        /* ===== MAIN CONTENT ===== */
        .main-content{flex:1;margin-left:var(--sidebar-width);height:100vh;overflow-y:auto;padding:32px 40px 120px}
        .dashboard{max-width:1200px;margin:0 auto}
        .page-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:32px}
        .page-title{font-family:var(--font-display);font-size:2rem;font-weight:600;letter-spacing:-0.02em;margin-bottom:4px}
        .page-subtitle{font-size:0.95rem;color:var(--color-text-secondary)}
        .day-badge{display:flex;align-items:center;gap:8px;padding:10px 18px;background:var(--color-glass-strong);backdrop-filter:var(--blur);border:1px solid var(--color-glass-border);border-radius:var(--radius-full);font-size:0.85rem;font-weight:600;color:var(--color-accent);box-shadow:var(--shadow-glass)}
        .day-badge svg{width:16px;height:16px}

        /* ===== GLASS CARDS ===== */
        .glass-card{background:var(--color-glass);backdrop-filter:var(--blur);border:1px solid var(--color-glass-border);border-radius:var(--radius-lg);box-shadow:var(--shadow-glass);overflow:hidden}
        .progress-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:28px}
        .progress-card{padding:24px}
        .progress-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .progress-label{font-size:0.9rem;font-weight:500;color:var(--color-text-secondary)}
        .progress-icon{width:36px;height:36px;border-radius:var(--radius-sm);background:rgba(255,255,255,0.5);display:flex;align-items:center;justify-content:center;color:var(--color-text-muted)}
        .progress-icon svg{width:18px;height:18px}
        .progress-value{display:flex;align-items:baseline;gap:2px;margin-bottom:12px}
        .progress-current{font-family:var(--font-display);font-size:2.5rem;font-weight:700;letter-spacing:-0.02em}
        .progress-total{font-size:1.25rem;color:var(--color-text-muted)}
        .progress-bar{height:6px;background:rgba(0,0,0,0.06);border-radius:3px;overflow:hidden}
        .progress-fill{height:100%;background:var(--color-accent);border-radius:3px;transition:width 0.5s ease}

        /* ===== SCHEDULE ===== */
        .schedule-section{margin-bottom:28px}
        .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .section-title{font-family:var(--font-display);font-size:1.1rem;font-weight:600}
        .current-time{font-size:0.85rem;color:var(--color-text-secondary)}
        .schedule-list{display:flex;flex-direction:column;gap:12px}
        .schedule-item{display:flex;align-items:center;gap:16px;padding:20px 24px;background:var(--color-glass);backdrop-filter:var(--blur);border:1px solid var(--color-glass-border);border-radius:var(--radius-md);transition:all 0.2s}
        .schedule-item.active{background:var(--color-accent-soft);border-color:var(--color-accent)}
        .schedule-icon{width:44px;height:44px;border-radius:var(--radius-sm);background:rgba(255,255,255,0.5);display:flex;align-items:center;justify-content:center;color:var(--color-text-muted);flex-shrink:0}
        .schedule-item.active .schedule-icon{background:var(--color-accent);color:white}
        .schedule-icon svg{width:20px;height:20px}
        .schedule-info{flex:1;min-width:0}
        .schedule-time{font-size:0.8rem;font-weight:500;color:var(--color-text-muted);margin-bottom:2px}
        .schedule-item.active .schedule-time{color:var(--color-accent)}
        .schedule-title{font-weight:600;margin-bottom:2px}
        .schedule-desc{font-size:0.85rem;color:var(--color-text-secondary)}
        .schedule-action{flex-shrink:0}
        .start-btn{display:flex;align-items:center;gap:6px;padding:10px 20px;background:var(--color-accent);color:white;font-size:0.85rem;font-weight:600;border:none;border-radius:var(--radius-full);cursor:pointer;transition:all 0.2s}
        .start-btn:hover{transform:scale(1.02)}
        .start-btn svg{width:16px;height:16px}

        /* ===== FLOATING SEARCH ===== */
        .floating-search{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);width:calc(100% - 48px - var(--sidebar-width));max-width:600px;margin-left:calc(var(--sidebar-width)/2);z-index:50}
        .search-bar{display:flex;align-items:center;gap:12px;padding:16px 24px;background:var(--color-glass-strong);backdrop-filter:var(--blur-strong);border:1px solid var(--color-glass-border);border-radius:var(--radius-full);box-shadow:0 8px 32px rgba(0,0,0,0.12)}
        .search-bar svg{width:20px;height:20px;color:var(--color-text-muted);flex-shrink:0}
        .search-bar input{flex:1;background:none;border:none;font-size:0.95rem;color:var(--color-text);outline:none}
        .search-bar input::placeholder{color:var(--color-text-muted)}

        /* ===== BOTTOM NAV (Mobile) ===== */
        .bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--color-glass-strong);backdrop-filter:var(--blur-strong);border-top:1px solid var(--color-border);padding:8px 16px calc(8px + var(--safe-bottom));z-index:100}
        .bottom-nav-inner{display:flex;justify-content:space-around;max-width:400px;margin:0 auto}
        .bottom-nav-item{display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px 16px;background:none;border:none;color:var(--color-text-muted);text-decoration:none;cursor:pointer;transition:color 0.15s}
        .bottom-nav-item.active{color:var(--color-accent)}
        .bottom-nav-item svg{width:24px;height:24px}
        .bottom-nav-item span{font-size:0.7rem;font-weight:500}

        /* ===== MOBILE HEADER ===== */
        .mobile-header{display:none;position:fixed;top:0;left:0;right:0;height:60px;background:var(--color-glass-strong);backdrop-filter:var(--blur-strong);border-bottom:1px solid var(--color-border);z-index:100;padding:0 20px}
        .mobile-header-left{height:100%;display:flex;align-items:center}
        .mobile-header-logo{height:28px}

        /* ===== CHAT DRAWER ===== */
        .chat-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.3);opacity:0;visibility:hidden;transition:all 0.3s;z-index:200}
        .chat-overlay.open{opacity:1;visibility:visible}
        .chat-drawer{position:fixed;top:0;right:0;bottom:0;width:100%;max-width:480px;background:var(--color-bg);transform:translateX(100%);transition:transform 0.3s ease;z-index:201;display:flex;flex-direction:column}
        .chat-overlay.open .chat-drawer{transform:translateX(0)}
        .chat-header{display:flex;align-items:center;justify-content:space-between;padding:20px 24px;border-bottom:1px solid var(--color-border)}
        .chat-title{font-family:var(--font-display);font-size:1.1rem;font-weight:600}
        .chat-close{width:40px;height:40px;display:flex;align-items:center;justify-content:center;background:var(--color-glass);border:1px solid var(--color-border);border-radius:var(--radius-sm);cursor:pointer}
        .chat-close svg{width:20px;height:20px}
        .chat-messages{flex:1;overflow-y:auto;padding:24px}
        .chat-input-area{padding:16px 24px;border-top:1px solid var(--color-border);background:var(--color-glass)}
        .chat-input-wrapper{display:flex;gap:12px}
        .chat-input{flex:1;padding:14px 20px;background:white;border:1px solid var(--color-border);border-radius:var(--radius-full);font-size:0.95rem;outline:none}
        .chat-input:focus{border-color:var(--color-accent)}
        .chat-send{width:48px;height:48px;background:var(--color-accent);color:white;border:none;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .chat-send svg{width:20px;height:20px}

        /* ===== RESPONSIVE ===== */
        @media(max-width:768px){
            .sidebar{display:none}
            .main-content{margin-left:0;padding:80px 20px 180px}
            .mobile-header{display:block}
            .bottom-nav{display:block}
            .floating-search{width:calc(100% - 40px);margin-left:0;bottom:90px}
            .progress-grid{grid-template-columns:1fr;gap:12px}
            .progress-card{padding:20px}
            .progress-current{font-size:2rem}
            .page-header{flex-direction:column;gap:16px}
            .day-badge{align-self:flex-start}
            .schedule-item{flex-wrap:wrap}
            .schedule-action{width:100%;margin-top:12px}
            .start-btn{width:100%;justify-content:center}
            .back-btn{top:16px;left:16px}
        }
    </style>
</head>
<body>
    <!-- SCREEN 1: AGENCY CODE -->
    <div class="screen active" id="agencyCodeScreen">
        <div class="auth-screen">
            <img src="/static/logo.png" alt="Coachd" height="52" class="auth-logo">
            <p class="auth-tagline">Coaching on call.</p>
            <div class="input-wrapper">
                <input type="text" class="auth-input code-input" id="agencyCodeInput" placeholder="AGENCY CODE" autocomplete="off" autocapitalize="characters">
                <p class="input-error" id="agencyCodeError"></p>
            </div>
            <button class="btn-primary" id="agencyCodeBtn" onclick="validateAgencyCode()">
                Continue 
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
            </button>
            <footer class="auth-footer">
                <p class="auth-footer-text">© 2026 Coachd</p>
                <div class="auth-footer-links"><a href="/terms">Terms</a><a href="/privacy">Privacy</a></div>
            </footer>
        </div>
    </div>

    <!-- SCREEN 2: PHONE NUMBER -->
    <div class="screen" id="phoneScreen">
        <div class="auth-screen">
            <button class="back-btn" onclick="goBack('agencyCodeScreen')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
            </button>
            <h1 class="auth-title">Welcome to <span id="agencyNameDisplay">Coachd</span></h1>
            <p class="auth-subtitle">Enter your phone number to sign in or create your account</p>
            <div class="input-wrapper">
                <input type="tel" class="auth-input phone-input" id="phoneInput" placeholder="(555) 123-4567" autocomplete="tel">
                <p class="input-error" id="phoneError"></p>
            </div>
            <button class="btn-primary" id="phoneBtn" onclick="submitPhone()">
                Send Code
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
            </button>
        </div>
    </div>

    <!-- SCREEN 3: VERIFY CODE -->
    <div class="screen" id="verifyScreen">
        <div class="auth-screen">
            <button class="back-btn" onclick="goBack('phoneScreen')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
            </button>
            <h1 class="auth-title">Enter Code</h1>
            <p class="auth-subtitle">We sent a 5-digit code to <span id="phoneDisplay"></span></p>
            <div class="input-wrapper">
                <input type="text" class="auth-input verify-code-input" id="verifyCodeInput" placeholder="•••••" maxlength="5" inputmode="numeric" autocomplete="one-time-code">
                <p class="input-error" id="verifyError"></p>
            </div>
            <button class="btn-primary" id="verifyBtn" onclick="verifyCode()" disabled>
                Verify
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
            </button>
            <div class="resend-wrapper">
                <button class="resend-btn" id="resendBtn" onclick="resendCode()" disabled>Resend (60s)</button>
            </div>
        </div>
    </div>

    <!-- SCREEN 4: COMPLETE PROFILE (First time only) -->
    <div class="screen" id="profileScreen">
        <div class="auth-screen">
            <div class="success-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
            </div>
            <h1 class="auth-title">You're verified!</h1>
            <p class="auth-subtitle">Let's set up your profile so your team knows who you are</p>
            <div class="name-row">
                <div class="input-wrapper">
                    <label class="input-label">First Name</label>
                    <input type="text" class="auth-input name-input" id="firstNameInput" placeholder="John" autocomplete="given-name">
                </div>
                <div class="input-wrapper">
                    <label class="input-label">Last Name</label>
                    <input type="text" class="auth-input name-input" id="lastNameInput" placeholder="Smith" autocomplete="family-name">
                </div>
            </div>
            <p class="input-error" id="profileError"></p>
            <button class="btn-primary" id="profileBtn" onclick="completeProfile()">
                Get Started
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
            </button>
        </div>
    </div>

    <!-- SCREEN 5: DASHBOARD -->
    <div class="screen dashboard-screen" id="dashboardScreen">
        <!-- Mobile Branded Header -->
        <header class="mobile-header">
            <div class="mobile-header-left">
                <img src="/static/logo.png" alt="Coachd" class="mobile-header-logo">
            </div>
        </header>
        <aside class="sidebar">
            <div class="sidebar-logo"><img src="/static/favicon.svg" alt=""></div>
            <nav class="sidebar-nav">
                <a href="/" class="nav-item active" data-tooltip="Dashboard"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg></a>
                <a href="/call" class="nav-item" data-tooltip="Live Call"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg></a>
                <button class="nav-item" data-tooltip="Ask" onclick="Chat.open()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg></button>
                <a href="#" class="nav-item" data-tooltip="Resources"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/></svg></a>
            </nav>
            <div class="sidebar-footer">
                <a href="#" class="nav-item" data-tooltip="Settings" onclick="logout()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg></a>
                <div class="user-avatar" id="userAvatar">A</div>
            </div>
        </aside>
        <main class="main-content">
            <div class="dashboard">
                <header class="page-header">
                    <div>
                        <h1 class="page-title" id="greeting">Good morning, Agent</h1>
                        <p class="page-subtitle">Week <span id="weekNum">1</span> · Focus on training & observation</p>
                    </div>
                    <div class="day-badge">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
                        <span id="dayBadge">Day 1 of 14</span>
                    </div>
                </header>
                <section class="progress-grid">
                    <div class="glass-card progress-card">
                        <div class="progress-card-header">
                            <span class="progress-label">Modules</span>
                            <div class="progress-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg></div>
                        </div>
                        <div class="progress-value"><span class="progress-current" id="modulesCount">0</span><span class="progress-total">/5</span></div>
                        <div class="progress-bar"><div class="progress-fill" id="modulesFill" style="width:0%"></div></div>
                    </div>
                    <div class="glass-card progress-card">
                        <div class="progress-card-header">
                            <span class="progress-label">Calls Today</span>
                            <div class="progress-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg></div>
                        </div>
                        <div class="progress-value"><span class="progress-current" id="callsCount">0</span><span class="progress-total">/15</span></div>
                        <div class="progress-bar"><div class="progress-fill" id="callsFill" style="width:0%"></div></div>
                    </div>
                    <div class="glass-card progress-card">
                        <div class="progress-card-header">
                            <span class="progress-label">Appointments</span>
                            <div class="progress-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg></div>
                        </div>
                        <div class="progress-value"><span class="progress-current" id="appointmentsCount">0</span><span class="progress-total">/3</span></div>
                        <div class="progress-bar"><div class="progress-fill" id="appointmentsFill" style="width:0%"></div></div>
                    </div>
                </section>
                <section class="schedule-section">
                    <div class="section-header">
                        <h2 class="section-title">Today's Schedule</h2>
                        <span class="current-time" id="currentTime"></span>
                    </div>
                    <div class="schedule-list" id="scheduleList"></div>
                </section>
            </div>
        </main>
        <div class="floating-search">
            <div class="search-bar" onclick="Chat.open()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
                <input type="text" placeholder="Ask Coachd anything..." readonly>
            </div>
        </div>
        <nav class="bottom-nav">
            <div class="bottom-nav-inner">
                <a href="/" class="bottom-nav-item active"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg><span>Home</span></a>
                <a href="/call" class="bottom-nav-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg><span>Call</span></a>
                <button class="bottom-nav-item" onclick="Chat.open()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg><span>Ask</span></button>
                <a href="#" class="bottom-nav-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/></svg><span>Learn</span></a>
            </div>
        </nav>
    </div>

    <!-- Chat Overlay -->
    <div class="chat-overlay" id="chatOverlay" onclick="Chat.close()">
        <div class="chat-drawer" onclick="event.stopPropagation()">
            <div class="chat-header">
                <span class="chat-title">Ask Coachd</span>
                <button class="chat-close" onclick="Chat.close()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
            </div>
            <div class="chat-messages" id="chatMessages">
                <p style="color:var(--color-text-secondary);text-align:center;margin-top:40px">Ask me anything about sales, objections, or your training.</p>
            </div>
            <div class="chat-input-area">
                <div class="chat-input-wrapper">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Type your question...">
                    <button class="chat-send" onclick="Chat.send()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg></button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== STATE ====================
        const state = {
            agencyCode: null,
            agencyName: null,
            phone: null,
            token: null,
            agent: null,
            resendCountdown: 0,
            resendInterval: null
        };

        // Schedule data
        const schedule = [
            {time:'11 AM – 1 PM',title:'Training Block',desc:'TopNotch modules + scripts',icon:'book',hours:[11,13]},
            {time:'1 – 3 PM',title:'Lunch & Study',desc:'ExamFX prep, review scripts',icon:'coffee',hours:[13,15]},
            {time:'3 – 4 PM',title:'Observation',desc:'Join senior agent calls',icon:'users',hours:[15,16]},
            {time:'4 – 7 PM',title:'Calling Block',desc:'Goal: 15 dials, 3 appointments',icon:'phone',hours:[16,19]}
        ];
        
        const icons = {
            book:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>',
            coffee:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8h1a4 4 0 010 8h-1"/><path d="M2 8h16v9a4 4 0 01-4 4H6a4 4 0 01-4-4V8z"/></svg>',
            users:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>',
            phone:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg>',
            play:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>'
        };

        // ==================== INLINE ERROR HELPERS ====================
        function showError(elementId, message) {
            const el = document.getElementById(elementId);
            if (el) {
                el.textContent = message;
                el.classList.add('show');
            }
        }
        
        function clearError(elementId) {
            const el = document.getElementById(elementId);
            if (el) {
                el.classList.remove('show');
            }
        }
        
        function clearAllErrors() {
            document.querySelectorAll('.input-error').forEach(el => el.classList.remove('show'));
            document.querySelectorAll('.auth-input').forEach(el => el.classList.remove('error'));
        }

        // ==================== SCREEN NAVIGATION ====================
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }
        
        function goBack(screenId) {
            clearAllErrors();
            showScreen(screenId);
        }

        // ==================== AUTH FLOW ====================
        
        // Check for existing session on load
        async function checkExistingSession() {
            const token = localStorage.getItem('coachd_token');
            const savedAgency = localStorage.getItem('coachd_agency');
            
            if (!token || !savedAgency) {
                return false;
            }
            
            try {
                const agency = JSON.parse(savedAgency);
                const response = await fetch('/api/auth/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    state.token = token;
                    state.agencyCode = agency.code;
                    state.agencyName = agency.name;
                    state.agent = data.agent;
                    
                    // Check if profile is complete
                    if (data.agent.needs_profile) {
                        showScreen('profileScreen');
                    } else {
                        showDashboard();
                    }
                    return true;
                } else {
                    // Token expired or invalid
                    localStorage.removeItem('coachd_token');
                    return false;
                }
            } catch (e) {
                console.error('Session check failed:', e);
                return false;
            }
        }

        // Step 1: Validate agency code
        async function validateAgencyCode() {
            const input = document.getElementById('agencyCodeInput');
            const btn = document.getElementById('agencyCodeBtn');
            const code = input.value.trim().toUpperCase();
            
            input.classList.remove('error');
            clearError('agencyCodeError');
            
            if (!code) {
                input.classList.add('error');
                return;
            }
            
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div>';
            
            try {
                const res = await fetch('/api/agency/validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });
                const data = await res.json();
                
                if (res.ok && data.valid) {
                    state.agencyCode = data.code;
                    state.agencyName = data.name;
                    localStorage.setItem('coachd_agency', JSON.stringify({ code: data.code, name: data.name }));
                    
                    document.getElementById('agencyNameDisplay').textContent = data.name;
                    showScreen('phoneScreen');
                    btn.disabled = false;
                    btn.innerHTML = 'Continue <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>';
                    return;
                } else {
                    input.classList.add('error');
                    showError('agencyCodeError', 'Agency not found. Check your code and try again.');
                }
            } catch (e) {
                // Fallback - accept any code (for development/demo)
                state.agencyCode = code;
                state.agencyName = code;
                localStorage.setItem('coachd_agency', JSON.stringify({ code, name: code }));
                document.getElementById('agencyNameDisplay').textContent = code;
                showScreen('phoneScreen');
            }
            
            btn.disabled = false;
            btn.innerHTML = 'Continue <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>';
        }

        // Step 2: Submit phone number
        async function submitPhone() {
            const input = document.getElementById('phoneInput');
            const btn = document.getElementById('phoneBtn');
            const phone = input.value.trim();
            
            input.classList.remove('error');
            clearError('phoneError');
            
            if (!phone || phone.replace(/\D/g, '').length < 10) {
                input.classList.add('error');
                if (phone) showError('phoneError', 'Please enter a valid 10-digit phone number.');
                return;
            }
            
            state.phone = phone;
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div>';
            
            try {
                // Initiate login (checks if agent exists)
                await fetch('/api/auth/login/initiate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone, agency_code: state.agencyCode })
                });
                
                // Send verification code
                const verifyRes = await fetch('/api/verify/initiate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone_number: phone, method: 'sms' })
                });
                
                const verifyData = await verifyRes.json();
                
                if (verifyData.already_verified) {
                    // Skip verification, complete login
                    await completeLogin();
                    btn.disabled = false;
                    btn.innerHTML = 'Send Code <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>';
                    return;
                }
                
                // Show verification screen
                document.getElementById('phoneDisplay').textContent = formatPhone(phone);
                showScreen('verifyScreen');
                startResendCountdown();
                document.getElementById('verifyCodeInput').focus();
                
            } catch (e) {
                console.error('Phone submit failed:', e);
                input.classList.add('error');
                showError('phoneError', 'Could not send code. Please try again.');
            }
            
            btn.disabled = false;
            btn.innerHTML = 'Send Code <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>';
        }

        // Step 3: Verify code
        async function verifyCode() {
            const input = document.getElementById('verifyCodeInput');
            const btn = document.getElementById('verifyBtn');
            const code = input.value.trim();
            
            if (code.length !== 5) return;
            
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div>';
            clearError('verifyError');
            
            try {
                const res = await fetch('/api/verify/confirm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone_number: state.phone, code })
                });
                
                if (res.ok) {
                    await completeLogin();
                } else {
                    const data = await res.json();
                    input.classList.add('error');
                    showError('verifyError', data.detail || 'Invalid or expired code. Tap resend below.');
                }
            } catch (e) {
                console.error('Verify failed:', e);
                input.classList.add('error');
                showError('verifyError', 'Connection error. Please try again.');
            }
            
            btn.disabled = false;
            btn.innerHTML = 'Verify <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>';
        }

        // Complete login after verification
        async function completeLogin() {
            try {
                const res = await fetch('/api/auth/login/complete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone: state.phone,
                        agency_code: state.agencyCode,
                        code: '' // Code already verified
                    })
                });
                
                const data = await res.json();
                
                if (res.ok && data.success) {
                    state.token = data.token;
                    state.agent = data.agent;
                    localStorage.setItem('coachd_token', data.token);
                    
                    if (data.agent.needs_profile) {
                        showScreen('profileScreen');
                    } else {
                        showDashboard();
                    }
                } else {
                    showError('verifyError', data.detail || 'Login failed. Please try again.');
                }
            } catch (e) {
                console.error('Login complete failed:', e);
                showError('verifyError', 'Connection error. Please try again.');
            }
        }

        // Step 4: Complete profile (first time only)
        async function completeProfile() {
            const firstName = document.getElementById('firstNameInput').value.trim();
            const lastName = document.getElementById('lastNameInput').value.trim();
            const btn = document.getElementById('profileBtn');
            
            clearError('profileError');
            document.getElementById('firstNameInput').classList.remove('error');
            document.getElementById('lastNameInput').classList.remove('error');
            
            if (!firstName || !lastName) {
                if (!firstName) document.getElementById('firstNameInput').classList.add('error');
                if (!lastName) document.getElementById('lastNameInput').classList.add('error');
                return;
            }
            
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div>';
            
            try {
                const res = await fetch('/api/auth/profile/complete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${state.token}`
                    },
                    body: JSON.stringify({ first_name: firstName, last_name: lastName })
                });
                
                const data = await res.json();
                
                if (res.ok && data.success) {
                    state.agent = data.agent;
                    showDashboard();
                    return; // Success - don't reset button
                } else {
                    showError('profileError', data.detail || 'Could not save profile. Please try again.');
                }
            } catch (e) {
                console.error('Profile complete failed:', e);
                showError('profileError', 'Connection error. Please try again.');
            }
            
            btn.disabled = false;
            btn.innerHTML = 'Get Started <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>';
        }

        // Resend code
        async function resendCode() {
            if (state.resendCountdown > 0) return;
            
            try {
                await fetch('/api/verify/initiate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone_number: state.phone, method: 'sms' })
                });
                startResendCountdown();
            } catch (e) {
                console.error('Resend failed:', e);
            }
        }

        function startResendCountdown() {
            state.resendCountdown = 60;
            updateResendButton();
            
            if (state.resendInterval) clearInterval(state.resendInterval);
            state.resendInterval = setInterval(() => {
                state.resendCountdown--;
                updateResendButton();
                if (state.resendCountdown <= 0) {
                    clearInterval(state.resendInterval);
                }
            }, 1000);
        }

        function updateResendButton() {
            const btn = document.getElementById('resendBtn');
            if (state.resendCountdown > 0) {
                btn.disabled = true;
                btn.textContent = `Resend (${state.resendCountdown}s)`;
            } else {
                btn.disabled = false;
                btn.textContent = 'Resend Code';
            }
        }

        // Logout
        async function logout() {
            if (!confirm('Sign out of Coachd?')) return;
            
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${state.token}` }
                });
            } catch (e) {}
            
            localStorage.removeItem('coachd_token');
            localStorage.removeItem('coachd_agency');
            state.token = null;
            state.agent = null;
            showScreen('agencyCodeScreen');
        }

        // ==================== DASHBOARD ====================
        function showDashboard() {
            showScreen('dashboardScreen');
            
            const hour = new Date().getHours();
            const greeting = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
            const name = state.agent?.first_name || 'Agent';
            
            document.getElementById('greeting').textContent = `${greeting}, ${name}`;
            document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
            
            // Update progress from agent data
            if (state.agent) {
                const modules = state.agent.modules_completed?.length || 0;
                const calls = state.agent.total_calls || 0;
                const appointments = state.agent.total_appointments || 0;
                
                document.getElementById('modulesCount').textContent = modules;
                document.getElementById('modulesFill').style.width = `${(modules/5)*100}%`;
                
                document.getElementById('callsCount').textContent = calls;
                document.getElementById('callsFill').style.width = `${Math.min((calls/15)*100, 100)}%`;
                
                document.getElementById('appointmentsCount').textContent = appointments;
                document.getElementById('appointmentsFill').style.width = `${Math.min((appointments/3)*100, 100)}%`;
                
                document.getElementById('dayBadge').textContent = `Day ${state.agent.onboarding_day} of 14`;
                document.getElementById('weekNum').textContent = state.agent.current_week;
            }
            
            renderSchedule();
            updateTime();
            setInterval(updateTime, 60000);
        }

        function renderSchedule() {
            const hour = new Date().getHours();
            document.getElementById('scheduleList').innerHTML = schedule.map((item) => {
                const isActive = hour >= item.hours[0] && hour < item.hours[1];
                return `
                    <div class="schedule-item ${isActive ? 'active' : ''}">
                        <div class="schedule-icon">${icons[item.icon]}</div>
                        <div class="schedule-info">
                            <div class="schedule-time">${item.time}</div>
                            <div class="schedule-title">${item.title}</div>
                            <div class="schedule-desc">${item.desc}</div>
                        </div>
                        ${item.icon === 'phone' ? `
                            <div class="schedule-action">
                                <a href="/call" class="start-btn">${icons.play} Start Calling</a>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
        }

        // ==================== UTILITIES ====================
        function formatPhone(phone) {
            const digits = phone.replace(/\D/g, '');
            if (digits.length === 10) {
                return `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
            }
            return phone;
        }

        // Handle verify code input
        document.getElementById('verifyCodeInput')?.addEventListener('input', function(e) {
            this.value = this.value.replace(/\D/g, '');
            document.getElementById('verifyBtn').disabled = this.value.length !== 5;
            this.classList.remove('error');
            clearError('verifyError');
        });

        // Enter key handlers
        document.getElementById('agencyCodeInput')?.addEventListener('keypress', e => { if (e.key === 'Enter') validateAgencyCode(); });
        document.getElementById('phoneInput')?.addEventListener('keypress', e => { if (e.key === 'Enter') submitPhone(); });
        document.getElementById('verifyCodeInput')?.addEventListener('keypress', e => { if (e.key === 'Enter' && e.target.value.length === 5) verifyCode(); });
        document.getElementById('firstNameInput')?.addEventListener('keypress', e => { if (e.key === 'Enter') document.getElementById('lastNameInput').focus(); });
        document.getElementById('lastNameInput')?.addEventListener('keypress', e => { if (e.key === 'Enter') completeProfile(); });
        
        // Clear error state when typing
        document.getElementById('agencyCodeInput')?.addEventListener('input', function() { 
            this.classList.remove('error'); 
            clearError('agencyCodeError');
        });
        document.getElementById('phoneInput')?.addEventListener('input', function() { 
            this.classList.remove('error'); 
            clearError('phoneError');
        });
        document.getElementById('firstNameInput')?.addEventListener('input', function() { 
            this.classList.remove('error'); 
            clearError('profileError');
        });
        document.getElementById('lastNameInput')?.addEventListener('input', function() { 
            this.classList.remove('error'); 
            clearError('profileError');
        });

        // ==================== CHAT MODULE ====================
        const Chat = {
            agencyCodeGetter: null,
            setAgencyCodeGetter(fn) { this.agencyCodeGetter = fn; },
            open() { document.getElementById('chatOverlay').classList.add('open'); document.getElementById('chatInput').focus(); },
            close() { document.getElementById('chatOverlay').classList.remove('open'); },
            async send() {
                const input = document.getElementById('chatInput');
                const msg = input.value.trim();
                if (!msg) return;
                
                const messages = document.getElementById('chatMessages');
                messages.innerHTML += `<div style="margin-bottom:16px"><strong>You:</strong> ${msg}</div>`;
                input.value = '';
                
                try {
                    const res = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${state.token}`
                        },
                        body: JSON.stringify({ 
                            message: msg, 
                            agency: state.agencyCode,
                            context: {}
                        })
                    });
                    const data = await res.json();
                    messages.innerHTML += `<div style="margin-bottom:16px"><strong>Coachd:</strong> ${data.response || data.message || 'I can help with that.'}</div>`;
                    messages.scrollTop = messages.scrollHeight;
                } catch (e) {
                    messages.innerHTML += `<div style="margin-bottom:16px;color:var(--color-error)">Error: Could not get response</div>`;
                }
            }
        };
        
        Chat.setAgencyCodeGetter(() => state.agencyCode);
        
        document.getElementById('chatInput')?.addEventListener('keypress', e => { if (e.key === 'Enter') Chat.send(); });

        // ==================== INIT ====================
        (async function init() {
            console.log('🚀 Coachd.ai Agent Dashboard - Auth Enabled');
            
            // Check for existing session
            const hasSession = await checkExistingSession();
            
            if (!hasSession) {
                // Check if we have a saved agency (returning user who got logged out)
                const savedAgency = localStorage.getItem('coachd_agency');
                if (savedAgency) {
                    try {
                        const agency = JSON.parse(savedAgency);
                        state.agencyCode = agency.code;
                        state.agencyName = agency.name;
                        document.getElementById('agencyCodeInput').value = agency.code;
                    } catch (e) {}
                }
            }
        })();
    </script>
</body>
</html>
