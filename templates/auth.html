<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Sign In | Coachd</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#F5F5F7">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root{--color-bg:#F5F5F7;--color-glass:rgba(255,255,255,0.65);--color-glass-strong:rgba(255,255,255,0.85);--color-glass-border:rgba(255,255,255,0.4);--color-border:rgba(0,0,0,0.06);--color-text:#1A1A1A;--color-text-secondary:#6B7280;--color-text-muted:#9CA3AF;--color-accent:#3B82F6;--color-accent-soft:rgba(59,130,246,0.12);--color-error:#EF4444;--font-display:'Outfit',sans-serif;--font-body:'Inter',sans-serif;--blur:blur(24px);--blur-strong:blur(40px);--shadow-glass:0 8px 32px rgba(0,0,0,0.06);--radius-sm:12px;--radius-md:16px;--radius-lg:24px;--radius-full:9999px}
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}html,body{height:100%;overflow:hidden}body{background:var(--color-bg);color:var(--color-text);font-family:var(--font-body);-webkit-font-smoothing:antialiased}
        .screen{display:none;height:100%}.screen.active{display:flex}

        /* ===== LANDING SCREEN ===== */
        .landing-screen{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 24px;position:relative}
        .landing-logo{margin-bottom:12px}
        .landing-tagline{font-size:1.05rem;font-weight:400;color:var(--color-text-secondary);margin-bottom:48px}
        .code-input-wrapper{margin-bottom:24px;width:100%;max-width:280px}
        .code-input{width:100%;padding:18px 24px;background:transparent;border:1.5px solid var(--color-border);border-radius:var(--radius-md);font-family:var(--font-body);font-size:1rem;font-weight:500;text-align:center;text-transform:uppercase;letter-spacing:0.15em;color:var(--color-text);transition:all 0.2s}
        .code-input::placeholder{color:var(--color-text-muted);font-weight:400;letter-spacing:0.1em}
        .code-input:focus{outline:none;border-color:var(--color-accent);box-shadow:0 0 0 3px var(--color-accent-soft)}
        .code-input.error{animation:shakeAndRevert 0.5s ease-out forwards}
        
        /* ===== AUTH SCREENS (Phone, Verify, Profile) ===== */
        .auth-screen{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 24px;position:relative}
        .auth-card{position:relative;background:var(--color-glass-strong);backdrop-filter:var(--blur-strong);-webkit-backdrop-filter:var(--blur-strong);border:1px solid var(--color-glass-border);border-radius:var(--radius-lg);padding:48px 40px 40px;box-shadow:var(--shadow-glass);display:flex;flex-direction:column;align-items:center;min-width:340px;max-width:420px}
        .auth-title{font-family:var(--font-display);font-size:1.5rem;font-weight:600;margin-bottom:8px;text-align:center}
        .auth-subtitle{font-size:0.95rem;color:var(--color-text-secondary);margin-bottom:32px;text-align:center;max-width:300px}
        .auth-input{width:100%;max-width:280px;padding:18px 24px;background:transparent;border:1.5px solid var(--color-border);border-radius:var(--radius-md);font-family:var(--font-body);font-size:1rem;font-weight:500;text-align:center;color:var(--color-text);transition:all 0.2s;margin-bottom:0}
        .auth-input::placeholder{color:var(--color-text-muted);font-weight:400}
        .auth-input:focus{outline:none;border-color:var(--color-accent);box-shadow:0 0 0 3px var(--color-accent-soft)}
        .auth-input.error{animation:shakeAndRevert 0.5s ease-out forwards}
        @keyframes shakeAndRevert{0%{border-color:var(--color-error);box-shadow:0 0 0 3px rgba(239,68,68,0.15);transform:translateX(0)}20%{transform:translateX(-8px)}40%{transform:translateX(8px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px);border-color:var(--color-error);box-shadow:0 0 0 3px rgba(239,68,68,0.15)}100%{transform:translateX(0);border-color:var(--color-accent);box-shadow:0 0 0 3px var(--color-accent-soft)}}
        .auth-input.verify-code{font-size:1.5rem;letter-spacing:0.3em;font-weight:600}
        .back-btn{position:absolute;top:12px;left:12px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;background:transparent;border:none;border-radius:var(--radius-sm);color:var(--color-text-muted);cursor:pointer;transition:all 0.2s}
        .back-btn:hover{background:rgba(0,0,0,0.05);color:var(--color-text)}
        .back-btn svg{width:20px;height:20px}
        .resend-btn{margin-top:16px;font-size:0.85rem;color:var(--color-accent);background:none;border:none;cursor:pointer;padding:8px 16px}
        .resend-btn:disabled{color:var(--color-text-muted);cursor:not-allowed}
        .success-icon{width:64px;height:64px;background:rgba(16,185,129,0.12);border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;margin-bottom:24px}
        .success-icon svg{width:32px;height:32px;color:#10B981}
        .name-row{display:flex;gap:12px;width:100%;max-width:320px;margin-bottom:24px}
        .name-input-wrapper{flex:1}
        .name-label{display:block;font-size:0.75rem;font-weight:600;color:var(--color-text-secondary);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.05em}
        .name-input{width:100%;padding:16px 20px;background:transparent;border:1.5px solid var(--color-border);border-radius:var(--radius-md);font-family:var(--font-body);font-size:1rem;color:var(--color-text);transition:all 0.2s;text-align:left}
        .name-input::placeholder{color:var(--color-text-muted)}
        .name-input:focus{outline:none;border-color:var(--color-accent);box-shadow:0 0 0 3px var(--color-accent-soft)}
        .name-input.error{animation:shakeAndRevert 0.5s ease-out forwards}
        .input-error{font-size:0.8rem;color:var(--color-error);margin-top:8px;margin-bottom:16px;min-height:20px;text-align:center;opacity:0;transition:all 0.2s}
        .input-error.show{opacity:1}
        .spinner{width:20px;height:20px;border:2px solid rgba(255,255,255,0.3);border-top-color:white;border-radius:50%;animation:spin 0.8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .btn-primary{display:inline-flex;align-items:center;justify-content:center;gap:10px;padding:16px 40px;background:var(--color-text);color:white;font-family:var(--font-display);font-size:0.95rem;font-weight:600;letter-spacing:0.01em;border:none;border-radius:var(--radius-full);cursor:pointer;transition:all 0.2s;min-height:54px;box-shadow:0 2px 8px rgba(0,0,0,0.12),0 1px 3px rgba(0,0,0,0.08)}
        .btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
        .btn-primary:disabled{opacity:0.5;cursor:not-allowed;transform:none;box-shadow:none}
        .btn-primary svg{width:18px;height:18px;opacity:0.9}
        .landing-footer{position:absolute;bottom:24px;left:0;right:0;text-align:center}
        .landing-footer-text{font-size:0.75rem;color:var(--color-text-muted);margin-bottom:8px}
        .landing-footer-links{display:flex;justify-content:center;gap:16px}
        .landing-footer-links a{font-size:0.7rem;color:var(--color-text-muted);text-decoration:none}
        .landing-footer-links a:hover{color:var(--color-text-secondary)}

        /* Mobile adjustments */
        @media(max-width:768px){
            .auth-card{min-width:auto;width:calc(100% - 32px);max-width:380px;padding:40px 24px 32px}
            .name-row{flex-direction:column;gap:16px}
        }
    </style>
</head>
<body>
    <!-- LANDING SCREEN -->
    <div class="screen active" id="landingScreen">
        <div class="landing-screen">
            <div class="auth-card">
                <img src="/static/logo.png" alt="Coachd" height="52" class="landing-logo">
                <p class="landing-tagline">Coaching on call.</p>
                <div class="code-input-wrapper">
                    <input type="text" class="code-input" id="agencyCode" placeholder="AGENCY CODE" autocomplete="off" autocapitalize="characters">
                    <p class="input-error" id="agencyError"></p>
                </div>
                <button class="btn-primary" id="continueBtn" onclick="validateAgencyCode()">Continue <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button>
            </div>
            <footer class="landing-footer">
                <p class="landing-footer-text">© 2026 Coachd</p>
                <div class="landing-footer-links"><a href="/terms">Terms</a><a href="/privacy">Privacy</a></div>
            </footer>
        </div>
    </div>

    <!-- PHONE SCREEN -->
    <div class="screen" id="phoneScreen">
        <div class="auth-screen">
            <div class="auth-card">
                <button class="back-btn" onclick="showScreen('landingScreen')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg></button>
                <h1 class="auth-title">Welcome to <span id="agencyNameDisplay">Coachd</span></h1>
                <p class="auth-subtitle">Enter your phone number to sign in or create your account</p>
                <input type="tel" class="auth-input" id="phoneInput" placeholder="(555) 123-4567" autocomplete="tel">
                <p class="input-error" id="phoneError"></p>
                <button class="btn-primary" id="phoneBtn" onclick="submitPhone()">Continue <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button>
            </div>
        </div>
    </div>

    <!-- VERIFY SCREEN -->
    <div class="screen" id="verifyScreen">
        <div class="auth-screen">
            <div class="auth-card">
                <button class="back-btn" onclick="showScreen('phoneScreen')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg></button>
                <h1 class="auth-title">Enter Code</h1>
                <p class="auth-subtitle">We sent a 5-digit code to <span id="phoneDisplay"></span></p>
                <input type="text" class="auth-input verify-code" id="verifyCodeInput" placeholder="•••••" maxlength="5" inputmode="numeric" autocomplete="one-time-code">
                <p class="input-error" id="verifyError"></p>
                <button class="btn-primary" id="verifyBtn" onclick="verifyCode()" disabled>Continue <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button>
                <button class="resend-btn" id="resendBtn" onclick="resendCode()" disabled>Resend code (60s)</button>
            </div>
        </div>
    </div>

    <!-- PROFILE SCREEN (first time only) -->
    <div class="screen" id="profileScreen">
        <div class="auth-screen">
            <div class="auth-card">
                <div class="success-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg></div>
                <h1 class="auth-title">You're verified!</h1>
                <p class="auth-subtitle">Let's set up your profile so your team knows who you are</p>
                <div class="name-row">
                    <div class="name-input-wrapper"><label class="name-label">First Name</label><input type="text" class="name-input" id="firstNameInput" placeholder="John" autocomplete="given-name"></div>
                    <div class="name-input-wrapper"><label class="name-label">Last Name</label><input type="text" class="name-input" id="lastNameInput" placeholder="Smith" autocomplete="family-name"></div>
                </div>
                <p class="input-error" id="profileError"></p>
                <button class="btn-primary" id="profileBtn" onclick="completeProfile()">Get Started <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button>
            </div>
        </div>
    </div>

    <script>
        // ==================== STATE ====================
        let currentAgency = null;
        const authState = { phone: null, token: null, agent: null, resendCountdown: 0 };

        // ==================== HELPERS ====================
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.input-error').forEach(el => el.classList.remove('show'));
            document.querySelectorAll('.auth-input, .name-input, .code-input').forEach(el => el.classList.remove('error'));
        }
        
        function showError(id, msg) { const el = document.getElementById(id); if (el) { el.textContent = msg; el.classList.add('show'); } }
        function clearError(id) { const el = document.getElementById(id); if (el) el.classList.remove('show'); }
        function formatPhone(p) { const d = p.replace(/\D/g, ''); return d.length === 10 ? `(${d.slice(0,3)}) ${d.slice(3,6)}-${d.slice(6)}` : p; }

        // ==================== AUTH FLOW ====================
        async function checkExistingSession() {
            const token = localStorage.getItem('coachd_token');
            if (!token) return false;
            try {
                const res = await fetch('/api/auth/me', { headers: { 'Authorization': `Bearer ${token}` } });
                if (res.ok) {
                    const data = await res.json();
                    if (data.success) {
                        // Already logged in - redirect to dashboard
                        try{localStorage.setItem('coachd_agent_cache',JSON.stringify({first_name:data.agent.first_name,last_name:data.agent.last_name,agency_code:data.agent.agency_code,onboarding_day:data.agent.onboarding_day}));}catch(e){}
                        window.location.href = '/dashboard';
                        return true;
                    }
                }
            } catch (e) {}
            localStorage.removeItem('coachd_token');
            return false;
        }

        async function validateAgencyCode() {
            const input = document.getElementById('agencyCode'), btn = document.getElementById('continueBtn');
            const errorEl = document.getElementById('agencyError');
            const code = input.value.trim().toUpperCase();
            input.classList.remove('error');
            if (errorEl) { errorEl.classList.remove('show'); errorEl.textContent = ''; }
            if (!code) { 
                input.classList.add('error'); 
                if (errorEl) { errorEl.textContent = 'Please enter an agency code'; errorEl.classList.add('show'); }
                setTimeout(() => input.classList.remove('error'), 500);
                return; 
            }
            
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div>';
            
            try {
                const res = await fetch('/api/agency/validate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ code }) });
                const data = await res.json();
                if (res.ok && data.valid) {
                    currentAgency = { code: data.code, name: data.name };
                    localStorage.setItem('coachd_agency', JSON.stringify(currentAgency));
                    document.getElementById('agencyNameDisplay').textContent = data.name;
                    showScreen('phoneScreen');
                } else {
                    input.classList.add('error');
                    if (errorEl) { errorEl.textContent = 'Invalid agency code'; errorEl.classList.add('show'); }
                    setTimeout(() => input.classList.remove('error'), 500);
                }
            } catch (e) {
                currentAgency = { code, name: code };
                localStorage.setItem('coachd_agency', JSON.stringify(currentAgency));
                document.getElementById('agencyNameDisplay').textContent = code;
                showScreen('phoneScreen');
            }
            
            btn.disabled = false;
            btn.innerHTML = 'Continue <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>';
        }

        async function submitPhone() {
            const input = document.getElementById('phoneInput'), btn = document.getElementById('phoneBtn');
            const phone = input.value.trim();
            input.classList.remove('error'); clearError('phoneError');
            
            if (!phone || phone.replace(/\D/g, '').length < 10) {
                input.classList.add('error');
                if (phone) showError('phoneError', 'Please enter a valid 10-digit number');
                setTimeout(() => input.classList.remove('error'), 500);
                return;
            }
            
            authState.phone = phone;
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div>';
            
            try {
                const loginRes = await fetch('/api/auth/login/initiate', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ phone, agency_code: currentAgency.code }) 
                });
                const loginData = await loginRes.json();
                
                if (loginData.already_authenticated && loginData.token) {
                    authState.token = loginData.token;
                    authState.agent = loginData.agent;
                    localStorage.setItem('coachd_token', loginData.token);
                    try{localStorage.setItem('coachd_agent_cache',JSON.stringify({first_name:loginData.agent.first_name,last_name:loginData.agent.last_name,agency_code:loginData.agent.agency_code,onboarding_day:loginData.agent.onboarding_day}));}catch(e){}
                    
                    if (loginData.agent?.needs_profile) {
                        showScreen('profileScreen');
                    } else {
                        window.location.href = '/dashboard';
                    }
                    btn.disabled = false;
                    btn.innerHTML = 'Continue <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>';
                    return;
                }
                
                const verifyRes = await fetch('/api/verify/initiate', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ phone_number: phone, method: 'sms' }) 
                });
                const verifyData = await verifyRes.json();
                
                if (verifyData.already_verified) { 
                    await completeLogin(); 
                } else {
                    document.getElementById('phoneDisplay').textContent = formatPhone(phone);
                    showScreen('verifyScreen');
                    startResendCountdown();
                    document.getElementById('verifyCodeInput').focus();
                }
            } catch (e) {
                input.classList.add('error');
                showError('phoneError', 'Could not send code. Try again.');
                setTimeout(() => input.classList.remove('error'), 500);
            }
            
            btn.disabled = false;
            btn.innerHTML = 'Continue <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>';
        }

        async function verifyCode() {
            const input = document.getElementById('verifyCodeInput'), btn = document.getElementById('verifyBtn');
            const code = input.value.trim();
            if (code.length !== 5) return;
            
            input.classList.remove('error'); clearError('verifyError');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div>';
            
            try {
                const res = await fetch('/api/verify/confirm', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ phone_number: authState.phone, code }) });
                if (res.ok) { await completeLogin(); }
                else {
                    const data = await res.json();
                    input.classList.add('error');
                    showError('verifyError', data.detail || 'Invalid or expired code');
                    setTimeout(() => input.classList.remove('error'), 500);
                }
            } catch (e) {
                input.classList.add('error');
                showError('verifyError', 'Connection error. Try again.');
                setTimeout(() => input.classList.remove('error'), 500);
            }
            
            btn.disabled = false;
            btn.innerHTML = 'Continue <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>';
        }

        async function completeLogin() {
            try {
                const res = await fetch('/api/auth/login/complete', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ phone: authState.phone, agency_code: currentAgency.code, code: '' }) });
                const data = await res.json();
                if (res.ok && data.success) {
                    authState.token = data.token;
                    authState.agent = data.agent;
                    localStorage.setItem('coachd_token', data.token);
                    try{localStorage.setItem('coachd_agent_cache',JSON.stringify({first_name:data.agent.first_name,last_name:data.agent.last_name,agency_code:data.agent.agency_code,onboarding_day:data.agent.onboarding_day}));}catch(e){}
                    if (data.agent.needs_profile) showScreen('profileScreen');
                    else window.location.href = '/dashboard';
                } else { showError('verifyError', data.detail || 'Login failed'); }
            } catch (e) { showError('verifyError', 'Connection error'); }
        }

        async function completeProfile() {
            const first = document.getElementById('firstNameInput'), last = document.getElementById('lastNameInput'), btn = document.getElementById('profileBtn');
            const firstName = first.value.trim(), lastName = last.value.trim();
            first.classList.remove('error'); last.classList.remove('error'); clearError('profileError');
            
            if (!firstName || !lastName) {
                if (!firstName) first.classList.add('error');
                if (!lastName) last.classList.add('error');
                setTimeout(() => { first.classList.remove('error'); last.classList.remove('error'); }, 500);
                return;
            }
            
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div>';
            
            try {
                const res = await fetch('/api/auth/profile/complete', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authState.token}` }, body: JSON.stringify({ first_name: firstName, last_name: lastName }) });
                const data = await res.json();
                if (res.ok && data.success) { 
                    authState.agent = data.agent; 
                    try{localStorage.setItem('coachd_agent_cache',JSON.stringify({first_name:data.agent.first_name,last_name:data.agent.last_name,agency_code:data.agent.agency_code,onboarding_day:data.agent.onboarding_day}));}catch(e){}
                    window.location.href = '/dashboard';
                    return; 
                }
                else showError('profileError', data.detail || 'Could not save profile');
            } catch (e) { showError('profileError', 'Connection error'); }
            
            btn.disabled = false;
            btn.innerHTML = 'Get Started <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>';
        }

        function resendCode() {
            if (authState.resendCountdown > 0) return;
            fetch('/api/verify/initiate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ phone_number: authState.phone, method: 'sms' }) });
            startResendCountdown();
        }

        function startResendCountdown() {
            authState.resendCountdown = 60;
            const btn = document.getElementById('resendBtn');
            btn.disabled = true;
            const interval = setInterval(() => {
                authState.resendCountdown--;
                btn.textContent = authState.resendCountdown > 0 ? `Resend code (${authState.resendCountdown}s)` : 'Resend code';
                if (authState.resendCountdown <= 0) { btn.disabled = false; clearInterval(interval); }
            }, 1000);
        }

        // ==================== EVENT LISTENERS ====================
        document.getElementById('agencyCode').addEventListener('keypress', e => { if (e.key === 'Enter') validateAgencyCode(); });
        document.getElementById('phoneInput')?.addEventListener('keypress', e => { if (e.key === 'Enter') submitPhone(); });
        document.getElementById('phoneInput')?.addEventListener('input', function() { this.classList.remove('error'); clearError('phoneError'); });
        document.getElementById('verifyCodeInput')?.addEventListener('input', function() { this.value = this.value.replace(/\D/g, ''); document.getElementById('verifyBtn').disabled = this.value.length !== 5; this.classList.remove('error'); clearError('verifyError'); });
        document.getElementById('verifyCodeInput')?.addEventListener('keypress', e => { if (e.key === 'Enter' && e.target.value.length === 5) verifyCode(); });
        document.getElementById('firstNameInput')?.addEventListener('input', function() { this.classList.remove('error'); clearError('profileError'); });
        document.getElementById('lastNameInput')?.addEventListener('input', function() { this.classList.remove('error'); clearError('profileError'); });
        document.getElementById('lastNameInput')?.addEventListener('keypress', e => { if (e.key === 'Enter') completeProfile(); });

        // ==================== INIT ====================
        (async function init() {
            const hasSession = await checkExistingSession();
            if (!hasSession) {
                const saved = localStorage.getItem('coachd_agency');
                if (saved) { try { currentAgency = JSON.parse(saved); document.getElementById('agencyCode').value = currentAgency.code; } catch (e) {} }
            }
        })();
    </script>
</body>
</html>
