{% extends "base_app.html" %}
{% set active_page = 'dashboard' %}

{% block title %}Dashboard | Coachd{% endblock %}

{% block styles %}
/* ===== DASHBOARD STYLES ===== */
.dashboard { max-width: 1200px; margin: 0 auto; }
.day-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 18px;
    background: var(--color-glass-strong);
    backdrop-filter: var(--blur);
    -webkit-backdrop-filter: var(--blur);
    border: 1px solid var(--color-glass-border);
    border-radius: var(--radius-full);
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--color-accent);
    box-shadow: var(--shadow-glass);
}
.day-badge svg { width: 16px; height: 16px; }

/* Progress Cards */
.progress-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 28px; }
.progress-card { padding: 24px; }
.progress-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.progress-label { font-size: 0.9rem; font-weight: 500; color: var(--color-text-secondary); }
.progress-icon {
    width: 36px;
    height: 36px;
    border-radius: var(--radius-sm);
    background: rgba(255,255,255,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-text-muted);
}
.progress-icon svg { width: 18px; height: 18px; }
.progress-value { margin-bottom: 16px; }
.progress-current { font-family: var(--font-display); font-size: 2.5rem; font-weight: 600; line-height: 1; }
.progress-total { font-size: 1.25rem; color: var(--color-text-muted); }
.progress-track { height: 6px; background: var(--color-border); border-radius: 3px; overflow: hidden; }
.progress-bar { height: 100%; border-radius: 3px; background: var(--color-accent); transition: width 0.5s; }

/* Schedule */
.content-grid { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 28px; }
.card-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid var(--color-border); }
.card-title { font-family: var(--font-display); font-size: 1.1rem; font-weight: 600; }
.time-badge { display: flex; align-items: center; gap: 6px; font-size: 0.8rem; color: var(--color-text-muted); }
.time-badge svg { width: 14px; height: 14px; }
.schedule-list { padding: 16px; }
.schedule-item { display: flex; align-items: center; gap: 16px; padding: 16px; border-radius: var(--radius-md); margin-bottom: 8px; }
.schedule-item:last-child { margin-bottom: 0; }
.schedule-item.active { background: var(--color-accent-soft); }
.schedule-icon {
    width: 48px;
    height: 48px;
    min-width: 48px;
    border-radius: var(--radius-md);
    background: rgba(255,255,255,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-text-muted);
}
.schedule-icon svg { width: 22px; height: 22px; }
.schedule-item.active .schedule-icon { background: var(--color-accent); color: white; }
.schedule-content { flex: 1; }
.schedule-time { font-size: 0.7rem; font-weight: 600; color: var(--color-text-muted); text-transform: uppercase; letter-spacing: 0.04em; }
.schedule-title { font-family: var(--font-display); font-size: 1rem; font-weight: 600; }
.schedule-item.active .schedule-title { color: var(--color-accent); }
.schedule-desc { font-size: 0.85rem; color: var(--color-text-secondary); }
.schedule-action {
    padding: 10px 18px;
    background: var(--color-accent);
    color: white;
    border: none;
    border-radius: var(--radius-full);
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
}
.schedule-action:hover { background: #2563EB; }
.schedule-action svg { width: 16px; height: 16px; }

@media (max-width: 1024px) { .progress-grid { grid-template-columns: repeat(2, 1fr); } .content-grid { grid-template-columns: 1fr; } }
@media (max-width: 768px) { .progress-grid { grid-template-columns: 1fr; gap: 16px; } }
{% endblock %}

{% block content %}
<div class="dashboard">
    <header class="page-header">
        <div>
            <h1 class="page-title" id="greeting">Good morning, Agent</h1>
            <p class="page-subtitle">Week 1 · Focus on training & observation</p>
        </div>
        <div class="day-badge">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
            <span id="dayBadge">Day 1 of 14</span>
        </div>
    </header>
    
    <section class="progress-grid">
        <div class="glass-card progress-card">
            <div class="progress-card-header">
                <span class="progress-label">Modules</span>
                <div class="progress-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg></div>
            </div>
            <div class="progress-value"><span class="progress-current">3</span><span class="progress-total">/5</span></div>
            <div class="progress-track"><div class="progress-bar" style="width:60%"></div></div>
        </div>
        <div class="glass-card progress-card">
            <div class="progress-card-header">
                <span class="progress-label">Calls Today</span>
                <div class="progress-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg></div>
            </div>
            <div class="progress-value"><span class="progress-current">8</span><span class="progress-total">/15</span></div>
            <div class="progress-track"><div class="progress-bar" style="width:53%"></div></div>
        </div>
        <div class="glass-card progress-card">
            <div class="progress-card-header">
                <span class="progress-label">Appointments</span>
                <div class="progress-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg></div>
            </div>
            <div class="progress-value"><span class="progress-current">1</span><span class="progress-total">/3</span></div>
            <div class="progress-track"><div class="progress-bar" style="width:33%"></div></div>
        </div>
    </section>
    
    <div class="content-grid">
        <section class="glass-card">
            <div class="card-header">
                <h2 class="card-title">Today's Schedule</h2>
                <div class="time-badge">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                    <span id="currentTime">--:--</span>
                </div>
            </div>
            <div class="schedule-list" id="scheduleList"></div>
        </section>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Dashboard state
    let currentAgency = null;
    let currentAgent = null;
    
    const schedule = [
        { time: '11 AM – 1 PM', title: 'Training Block', desc: 'TopNotch modules + scripts', icon: 'book', hours: [11, 13] },
        { time: '1 – 3 PM', title: 'Lunch & Study', desc: 'ExamFX prep, review scripts', icon: 'coffee', hours: [13, 15] },
        { time: '3 – 4 PM', title: 'Observation', desc: 'Join senior agent calls', icon: 'users', hours: [15, 16] },
        { time: '4 – 7 PM', title: 'Calling Block', desc: 'Goal: 15 dials, 3 appointments', icon: 'phone', hours: [16, 19] }
    ];
    
    const icons = {
        book: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>',
        coffee: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8h1a4 4 0 010 8h-1"/><path d="M2 8h16v9a4 4 0 01-4 4H6a4 4 0 01-4-4V8z"/></svg>',
        users: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>',
        phone: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg>',
        play: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>'
    };
    
    Chat.setAgencyCodeGetter(() => currentAgency?.code);

    function initDashboard(agent) {
        currentAgent = agent;
        currentAgency = { code: agent.agency_code, name: agent.agency_code };
        
        const hour = new Date().getHours();
        const name = agent?.first_name || 'Agent';
        
        document.getElementById('greeting').textContent = `${hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening'}, ${name}`;
        document.getElementById('dayBadge').textContent = `Day ${agent.onboarding_day || 1} of 14`;
        
        updateAvatar(agent);
        renderSchedule();
        updateTime();
        setInterval(updateTime, 60000);
        
        if (new URLSearchParams(window.location.search).get('chat') === 'open') { 
            setTimeout(() => Chat.open(), 100); 
            history.replaceState(null, '', window.location.pathname); 
        }
    }

    function renderSchedule() { 
        const hour = new Date().getHours(); 
        document.getElementById('scheduleList').innerHTML = schedule.map((item) => { 
            const isActive = hour >= item.hours[0] && hour < item.hours[1]; 
            return `<div class="schedule-item ${isActive ? 'active' : ''}"><div class="schedule-icon">${icons[item.icon]}</div><div class="schedule-content"><div class="schedule-time">${item.time}</div><div class="schedule-title">${item.title}</div><div class="schedule-desc">${item.desc}</div></div>${isActive && item.icon === 'phone' ? `<button class="schedule-action" onclick="startCall()">${icons.play} Start</button>` : ''}</div>`; 
        }).join(''); 
    }
    
    function updateTime() { 
        const el = document.getElementById('currentTime');
        if (el) el.textContent = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }); 
    }
    
    function startCall() { 
        sessionStorage.setItem('coachd_agency', JSON.stringify(currentAgency)); 
        window.location.href = '/call'; 
    }

    // Initialize on page load
    (async function() {
        const agent = await checkAuth();
        if (agent) initDashboard(agent);
    })();
</script>
{% endblock %}
