<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Dashboard | Coachd</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#F5F5F7">
    <script type="module" src="https://cdn.jsdelivr.net/npm/@hotwired/turbo@8.0.4/dist/turbo.es2017-esm.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* Turbo progress bar */
        .turbo-progress-bar{position:fixed;top:0;left:0;height:3px;background:var(--color-accent,#3B82F6);z-index:9999;transition:width 0.3s ease}
        
        :root{--color-bg:#F5F5F7;--color-glass:rgba(255,255,255,0.65);--color-glass-strong:rgba(255,255,255,0.85);--color-glass-border:rgba(255,255,255,0.4);--color-border:rgba(0,0,0,0.06);--color-text:#1A1A1A;--color-text-secondary:#6B7280;--color-text-muted:#9CA3AF;--color-accent:#3B82F6;--color-accent-soft:rgba(59,130,246,0.12);--color-error:#EF4444;--font-display:'Outfit',sans-serif;--font-body:'Inter',sans-serif;--blur:blur(24px);--blur-strong:blur(40px);--shadow-glass:0 8px 32px rgba(0,0,0,0.06);--radius-sm:12px;--radius-md:16px;--radius-lg:24px;--radius-full:9999px;--safe-bottom:env(safe-area-inset-bottom,0px);--sidebar-width:72px}
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}html,body{height:100%;overflow:hidden}body{background:var(--color-bg);color:var(--color-text);font-family:var(--font-body);-webkit-font-smoothing:antialiased}

        /* ===== APP SHELL ===== */
        .app{display:flex;height:100%}

        /* ===== SIDEBAR (Desktop) ===== */
        .sidebar{width:var(--sidebar-width);background:var(--color-glass);backdrop-filter:var(--blur-strong);border-right:1px solid var(--color-border);display:flex;flex-direction:column;align-items:center;padding:20px 0;position:fixed;top:0;left:0;height:100vh;z-index:100}
        .sidebar-logo{width:40px;height:40px;margin-bottom:32px}
        .sidebar-logo img{width:100%;height:100%}
        .sidebar-nav{flex:1;display:flex;flex-direction:column;align-items:center;gap:8px;padding:0 12px}
        .sidebar-nav-normal{display:flex;flex-direction:column;gap:8px}
        .nav-item{width:48px;height:48px;display:flex;align-items:center;justify-content:center;border:none;border-radius:var(--radius-sm);background:transparent;color:var(--color-text-muted);cursor:pointer;transition:all 0.15s;text-decoration:none;position:relative}
        .nav-item:hover{background:rgba(255,255,255,0.5);color:var(--color-text)}
        .nav-item.active{background:var(--color-accent-soft);color:var(--color-accent)}
        .nav-item svg{width:22px;height:22px}
        .nav-item::after{content:attr(data-tooltip);position:absolute;left:calc(100% + 12px);padding:8px 12px;background:var(--color-text);color:white;font-size:0.8rem;font-weight:500;border-radius:8px;white-space:nowrap;opacity:0;visibility:hidden;transition:all 0.15s;pointer-events:none}
        .nav-item:hover::after{opacity:1;visibility:visible}
        .sidebar-footer{padding:0 12px;display:flex;flex-direction:column;align-items:center;gap:8px}
        .sidebar-footer-normal{display:flex;flex-direction:column;gap:8px;align-items:center}
        .user-avatar{width:40px;height:40px;border-radius:50%;background:var(--color-accent-soft);color:var(--color-accent);display:flex;align-items:center;justify-content:center;font-weight:600;font-size:0.85rem}

        /* ===== MAIN CONTENT ===== */
        .main-content{flex:1;margin-left:var(--sidebar-width);height:100vh;overflow-y:auto;padding:32px 40px 120px}
        .dashboard{max-width:1200px;margin:0 auto}
        .page-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:32px}
        .page-title{font-family:var(--font-display);font-size:2rem;font-weight:600;letter-spacing:-0.02em;margin-bottom:4px}
        .page-subtitle{font-size:0.95rem;color:var(--color-text-secondary)}
        .day-badge{display:flex;align-items:center;gap:8px;padding:10px 18px;background:var(--color-glass-strong);backdrop-filter:var(--blur);border:1px solid var(--color-glass-border);border-radius:var(--radius-full);font-size:0.85rem;font-weight:600;color:var(--color-accent);box-shadow:var(--shadow-glass)}
        .day-badge svg{width:16px;height:16px}

        /* ===== GLASS CARDS ===== */
        .glass-card{background:var(--color-glass);backdrop-filter:var(--blur);border:1px solid var(--color-glass-border);border-radius:var(--radius-lg);box-shadow:var(--shadow-glass);overflow:hidden}
        .progress-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:28px}
        .progress-card{padding:24px}
        .progress-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .progress-label{font-size:0.9rem;font-weight:500;color:var(--color-text-secondary)}
        .progress-icon{width:36px;height:36px;border-radius:var(--radius-sm);background:rgba(255,255,255,0.5);display:flex;align-items:center;justify-content:center;color:var(--color-text-muted)}
        .progress-icon svg{width:18px;height:18px}
        .progress-value{margin-bottom:16px}
        .progress-current{font-family:var(--font-display);font-size:2.5rem;font-weight:600;line-height:1}
        .progress-total{font-size:1.25rem;color:var(--color-text-muted)}
        .progress-track{height:6px;background:var(--color-border);border-radius:3px;overflow:hidden}
        .progress-bar{height:100%;border-radius:3px;background:var(--color-accent);transition:width 0.5s}
        .content-grid{display:grid;grid-template-columns:1fr;gap:20px;margin-bottom:28px}
        .card-header{display:flex;justify-content:space-between;align-items:center;padding:20px 24px;border-bottom:1px solid var(--color-border)}
        .card-title{font-family:var(--font-display);font-size:1.1rem;font-weight:600}
        .time-badge{display:flex;align-items:center;gap:6px;font-size:0.8rem;color:var(--color-text-muted)}
        .time-badge svg{width:14px;height:14px}

        /* ===== SCHEDULE ===== */
        .schedule-list{padding:16px}
        .schedule-item{display:flex;align-items:center;gap:16px;padding:16px;border-radius:var(--radius-md);margin-bottom:8px}
        .schedule-item:last-child{margin-bottom:0}
        .schedule-item.active{background:var(--color-accent-soft)}
        .schedule-icon{width:48px;height:48px;min-width:48px;border-radius:var(--radius-md);background:rgba(255,255,255,0.5);display:flex;align-items:center;justify-content:center;color:var(--color-text-muted)}
        .schedule-icon svg{width:22px;height:22px}
        .schedule-item.active .schedule-icon{background:var(--color-accent);color:white}
        .schedule-content{flex:1}
        .schedule-time{font-size:0.7rem;font-weight:600;color:var(--color-text-muted);text-transform:uppercase;letter-spacing:0.04em}
        .schedule-title{font-family:var(--font-display);font-size:1rem;font-weight:600}
        .schedule-item.active .schedule-title{color:var(--color-accent)}
        .schedule-desc{font-size:0.85rem;color:var(--color-text-secondary)}
        .schedule-action{padding:10px 18px;background:var(--color-accent);color:white;border:none;border-radius:var(--radius-full);font-size:0.85rem;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:6px}
        .schedule-action:hover{background:#2563EB}
        .schedule-action svg{width:16px;height:16px}

        /* Chat styles loaded from partial */
        {% include 'partials/chat_styles.css' %}

        /* ===== FLOATING GLASS PILL NAV (Mobile) ===== */
        .bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;z-index:400;padding:8px 12px calc(8px + var(--safe-bottom))}
        .bottom-nav-pill{background:var(--color-glass-strong);backdrop-filter:var(--blur-strong);border:1px solid var(--color-glass-border);border-radius:var(--radius-full);padding:6px 8px;box-shadow:0 4px 24px rgba(0,0,0,0.1)}
        .bottom-nav-items{display:flex;justify-content:space-around}
        .bottom-nav-normal{display:contents}
        .bottom-nav-item{display:flex;flex-direction:column;align-items:center;gap:3px;padding:8px 12px;background:transparent;border:none;color:var(--color-text-muted);text-decoration:none;border-radius:var(--radius-md);transition:color 0.15s}
        .bottom-nav-item.active{color:var(--color-accent)}
        .bottom-nav-item svg{width:20px;height:20px}
        .bottom-nav-label{font-size:0.6rem;font-weight:600}

        /* ===== TOAST ===== */
        .toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(100px);padding:14px 28px;background:var(--color-text);color:white;border-radius:var(--radius-full);font-size:0.9rem;font-weight:500;opacity:0;transition:all 0.3s;z-index:2000}
        .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
        .toast.error{background:var(--color-error)}

        /* ===== MOBILE BRANDED HEADER ===== */
        .mobile-header{display:none;position:fixed;top:0;left:0;right:0;height:44px;padding:0 20px;z-index:300;align-items:center;justify-content:space-between;background:transparent}
        .mobile-header-left{display:flex;align-items:center}
        .mobile-header-logo{height:20px;opacity:0.9}

        /* ===== RESPONSIVE ===== */
        @media(max-width:1024px){.progress-grid{grid-template-columns:repeat(2,1fr)}.content-grid{grid-template-columns:1fr}}
        @media(max-width:768px){
            .sidebar{display:none}
            .mobile-header{display:flex}
            .bottom-nav{display:block}
            .main-content{margin-left:0;padding:calc(44px + 24px) 20px calc(140px + var(--safe-bottom))}
            .page-header{flex-direction:column;gap:16px}
            .page-title{font-size:1.6rem}
            .progress-grid{grid-template-columns:1fr;gap:16px}
        }
    </style>
</head>
{% set active_page = 'dashboard' %}
<body>
    {% include 'partials/nav_hydrate.html' %}
    <div class="app">
        {% include 'partials/mobile_header.html' %}
        {% include 'partials/sidebar.html' %}
        
        <main class="main-content" id="main-content">
            <div class="dashboard">
                <header class="page-header">
                    <div>
                        <h1 class="page-title" id="greeting">Good morning, Agent</h1>
                        <p class="page-subtitle">Week 1 · Focus on training & observation</p>
                    </div>
                    <div class="day-badge">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
                        <span id="dayBadge">Day 1 of 14</span>
                    </div>
                </header>
                <section class="progress-grid">
                    <div class="glass-card progress-card">
                        <div class="progress-card-header">
                            <span class="progress-label">Modules</span>
                            <div class="progress-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg></div>
                        </div>
                        <div class="progress-value"><span class="progress-current">3</span><span class="progress-total">/5</span></div>
                        <div class="progress-track"><div class="progress-bar" style="width:60%"></div></div>
                    </div>
                    <div class="glass-card progress-card">
                        <div class="progress-card-header">
                            <span class="progress-label">Calls Today</span>
                            <div class="progress-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg></div>
                        </div>
                        <div class="progress-value"><span class="progress-current">8</span><span class="progress-total">/15</span></div>
                        <div class="progress-track"><div class="progress-bar" style="width:53%"></div></div>
                    </div>
                    <div class="glass-card progress-card">
                        <div class="progress-card-header">
                            <span class="progress-label">Appointments</span>
                            <div class="progress-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg></div>
                        </div>
                        <div class="progress-value"><span class="progress-current">1</span><span class="progress-total">/3</span></div>
                        <div class="progress-track"><div class="progress-bar" style="width:33%"></div></div>
                    </div>
                </section>
                <div class="content-grid">
                    <section class="glass-card">
                        <div class="card-header">
                            <h2 class="card-title">Today's Schedule</h2>
                            <div class="time-badge">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                                <span id="currentTime">--:--</span>
                            </div>
                        </div>
                        <div class="schedule-list" id="scheduleList"></div>
                    </section>
                </div>
            </div>
        </main>
        {% include 'partials/mobile_nav.html' %}
    </div>

    <!-- CHAT MODAL -->
    {% include 'partials/chat.html' %}
    <div class="toast" id="toast"></div>

    <script>
        // Chat module (loaded from partial)
        {% include 'partials/chat.js' %}
        
        // ==================== STATE ====================
        let currentAgency = null;
        let currentAgent = null;
        
        const schedule=[{time:'11 AM – 1 PM',title:'Training Block',desc:'TopNotch modules + scripts',icon:'book',hours:[11,13]},{time:'1 – 3 PM',title:'Lunch & Study',desc:'ExamFX prep, review scripts',icon:'coffee',hours:[13,15]},{time:'3 – 4 PM',title:'Observation',desc:'Join senior agent calls',icon:'users',hours:[15,16]},{time:'4 – 7 PM',title:'Calling Block',desc:'Goal: 15 dials, 3 appointments',icon:'phone',hours:[16,19]}];
        const icons={book:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>',coffee:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8h1a4 4 0 010 8h-1"/><path d="M2 8h16v9a4 4 0 01-4 4H6a4 4 0 01-4-4V8z"/></svg>',users:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>',phone:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg>',play:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>'};
        
        Chat.setAgencyCodeGetter(() => currentAgency?.code);

        // ==================== HELPERS ====================
        function showToast(msg, type='info') { const t = document.getElementById('toast'); t.textContent = msg; t.className = 'toast show' + (type === 'error' ? ' error' : ''); setTimeout(() => t.classList.remove('show'), 3000); }

        // ==================== AUTH CHECK ====================
        async function checkAuth() {
            const token = localStorage.getItem('coachd_token');
            if (!token) {
                window.location.href = '/auth';
                return false;
            }
            try {
                const res = await fetch('/api/auth/me', { headers: { 'Authorization': `Bearer ${token}` } });
                if (res.ok) {
                    const data = await res.json();
                    if (data.success) {
                        currentAgent = data.agent;
                        currentAgency = { code: data.agent.agency_code, name: data.agent.agency_code };
                        // Update cache for nav hydration
                        try{localStorage.setItem('coachd_agent_cache',JSON.stringify({first_name:data.agent.first_name,last_name:data.agent.last_name,agency_code:data.agent.agency_code,onboarding_day:data.agent.onboarding_day}));}catch(e){}
                        return true;
                    }
                }
            } catch (e) {}
            localStorage.removeItem('coachd_token');
            window.location.href = '/auth';
            return false;
        }

        // ==================== DASHBOARD ====================
        function showDashboard() {
            const hour = new Date().getHours();
            const name = currentAgent?.first_name || 'Agent';
            const initials = ((currentAgent?.first_name?.[0] || '') + (currentAgent?.last_name?.[0] || '')).toUpperCase() || 'A';
            document.getElementById('greeting').textContent = `${hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening'}, ${name}`;
            const avatar = document.getElementById('userAvatar');
            if (avatar) avatar.textContent = initials;
            if (currentAgent) document.getElementById('dayBadge').textContent = `Day ${currentAgent.onboarding_day || 1} of 14`;
            renderSchedule();
            updateTime();
            setInterval(updateTime, 60000);
            if (new URLSearchParams(window.location.search).get('chat') === 'open') { setTimeout(() => Chat.open(), 100); history.replaceState(null, '', window.location.pathname); }
        }

        function renderSchedule() { 
            const hour = new Date().getHours(); 
            document.getElementById('scheduleList').innerHTML = schedule.map((item) => { 
                const isActive = hour >= item.hours[0] && hour < item.hours[1]; 
                return `<div class="schedule-item ${isActive ? 'active' : ''}"><div class="schedule-icon">${icons[item.icon]}</div><div class="schedule-content"><div class="schedule-time">${item.time}</div><div class="schedule-title">${item.title}</div><div class="schedule-desc">${item.desc}</div></div>${isActive && item.icon === 'phone' ? `<button class="schedule-action" onclick="startCall()">${icons.play} Start</button>` : ''}</div>`; 
            }).join(''); 
        }
        
        function updateTime() { document.getElementById('currentTime').textContent = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }); }
        function startCall() { sessionStorage.setItem('coachd_agency', JSON.stringify(currentAgency)); window.location.href = '/call'; }

        // ==================== INIT ====================
        (async function init() {
            const isAuth = await checkAuth();
            if (isAuth) showDashboard();
        })();

        // Re-init on Turbo navigation
        document.addEventListener('turbo:load', async () => {
            const isAuth = await checkAuth();
            if (isAuth) showDashboard();
        });
    </script>
</body>
</html>
