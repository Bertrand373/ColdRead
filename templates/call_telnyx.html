<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Live Call | Coachd</title>
    
        <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="icon" type="image/png" sizes="96x96" href="/static/favicon-96x96.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
    <link rel="shortcut icon" href="/static/favicon.ico">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#FFFFFF">
    
    <!-- SEO -->
    <meta name="description" content="AI-powered sales coaching for life insurance agents.">
    
    <!-- VERSION: 2025-01-16-v14-premium-guidance-redesign -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #FFFFFF;
            --surface: #F5F5F5;
            --border: #E5E5E5;
            --text: #1A1A1A;
            --text-secondary: #666666;
            --text-muted: #999999;
            --accent: #60A5FA;
            --accent-dark: #3B82F6;
            --accent-soft: rgba(96, 165, 250, 0.1);
            --success: #10B981;
            --success-soft: rgba(16, 185, 129, 0.1);
            --danger: #EF4444;
            --danger-soft: rgba(239, 68, 68, 0.1);
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            min-height: 100dvh;
            overflow: hidden;
        }
        
        /* ========== LANDSCAPE BLOCKER (PREMIUM) ========== */
        .landscape-blocker {
            display: none;
            position: fixed;
            inset: 0;
            background: linear-gradient(180deg, #FAFAFA 0%, #F5F5F5 100%);
            z-index: 99999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 24px;
            gap: 28px;
        }
        
        .landscape-blocker::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            opacity: 0.025;
            pointer-events: none;
        }

        .landscape-logo {
            height: 22px;
            opacity: 0.9;
        }

        .phone-wrapper {
            width: 160px;
            height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .phone-shadow {
            position: absolute;
            width: 40px;
            height: 10px;
            background: radial-gradient(ellipse, rgba(0,0,0,0.18) 0%, transparent 70%);
            bottom: 4px;
            border-radius: 50%;
            animation: shadowPulse 7s ease-in-out infinite;
        }
        
        @keyframes shadowPulse {
            0%, 7%, 43%, 50%, 57%, 93%, 100% {
                transform: scaleX(2);
                opacity: 0.2;
            }
            25%, 75% {
                transform: scaleX(1);
                opacity: 0.6;
            }
        }

        .phone-device {
            position: absolute;
            width: 48px;
            height: 100px;
            animation: rotatePhoneAnim 7s cubic-bezier(0.33, 1, 0.68, 1) infinite;
            filter: drop-shadow(0 10px 30px rgba(0, 0, 0, 0.2)) drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
        }
        
        @keyframes rotatePhoneAnim {
            0%, 7% { transform: rotate(90deg); }
            25%, 43% { transform: rotate(0deg); }
            50%, 57% { transform: rotate(-90deg); }
            75%, 93% { transform: rotate(0deg); }
            100% { transform: rotate(90deg); }
        }

        .phone-device svg {
            width: 100%;
            height: 100%;
        }

        .landscape-text {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .landscape-title {
            font-family: 'Outfit', sans-serif;
            font-size: 1.5rem;
            font-weight: 600;
            color: #1A1A1A;
            letter-spacing: -0.02em;
        }
        
        .landscape-subtitle {
            font-size: 0.85rem;
            color: #9CA3AF;
        }

        /* Landscape blocker - but NOT during active calls */
        @media (orientation: landscape) and (max-height: 500px) {
            body:not(.call-active) .landscape-blocker { display: flex; }
            body:not(.call-active) .app { display: none !important; }
        }
        
        .app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
            padding-top: var(--safe-top);
            padding-bottom: var(--safe-bottom);
        }
        
        /* ========== HEADER ========== */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            flex-shrink: 0;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .back-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: var(--surface);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.15s ease;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }
        
        .back-btn:hover { background: var(--border); }
        .back-btn:active { transform: scale(0.95); }
        .back-btn svg { width: 20px; height: 20px; color: var(--text); }
        
        .logo {
            display: block;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .agent-badge {
            display: none;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--surface);
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-secondary);
            max-width: 140px;
            overflow: hidden;
        }
        
        .agent-badge.show { display: flex; }
        
        /* End Session Button - Header version (during calls) */
        .end-session-btn {
            display: none;
            align-items: center;
            justify-content: center;
            padding: 8px 14px;
            background: var(--surface);
            color: var(--text-secondary);
            font-family: 'Outfit', sans-serif;
            font-size: 0.8rem;
            font-weight: 500;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
            -webkit-tap-highlight-color: transparent;
        }
        
        .end-session-btn:hover {
            background: var(--border);
            color: var(--text);
        }
        
        .end-session-btn:active {
            transform: scale(0.98);
        }
        
        .end-session-btn.show {
            display: flex;
        }
        
        .agent-badge svg {
            width: 14px;
            height: 14px;
            flex-shrink: 0;
        }
        
        .agent-badge span {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .timer {
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
            min-width: 45px;
            text-align: right;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--surface);
            transition: all 0.2s ease;
        }
        
        .status-indicator svg {
            width: 16px;
            height: 16px;
            color: var(--text-muted);
        }
        
        .status-indicator.listening {
            background: var(--success-soft);
        }
        
        .status-indicator.listening svg {
            color: var(--success);
        }
        
        .status-indicator.connecting {
            background: rgba(245, 158, 11, 0.1);
        }
        
        .status-indicator.connecting svg {
            color: #F59E0B;
            animation: spin 1s linear infinite;
        }
        
        .status-indicator.ringing {
            background: var(--accent-soft);
        }
        
        .status-indicator.ringing svg {
            color: var(--accent-dark);
            animation: pulse 1s ease-in-out infinite;
        }
        
        .status-indicator.error {
            background: var(--danger-soft);
        }
        
        .status-indicator.error svg {
            color: var(--danger);
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* ========== SCREENS ========== */
        .screen {
            display: none;
            flex: 1;
            flex-direction: column;
        }
        
        .screen.active { 
            display: flex;
            flex-direction: column;
        }
        
        /* ========== IDENTIFY SCREEN ========== */
        .identify-screen {
            justify-content: center;
            align-items: center;
            padding: 40px 24px;
        }
        
        .identify-screen.active {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .identify-card {
            width: 100%;
            max-width: 300px;
        }
        
        .identify-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .identify-icon {
            width: 56px;
            height: 56px;
            background: var(--accent-soft);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }
        
        .identify-icon svg {
            width: 28px;
            height: 28px;
            color: var(--accent-dark);
        }
        
        .identify-title {
            font-family: 'Outfit', sans-serif;
            font-size: 1.5rem;
            font-weight: 600;
            letter-spacing: -0.02em;
            text-align: center;
            margin-bottom: 8px;
        }
        
        .identify-subtitle {
            font-size: 0.9rem;
            color: var(--text-muted);
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            color: var(--text);
            background: transparent;
            border: 1.5px solid var(--border);
            border-radius: 12px;
            transition: all 0.2s ease;
            min-height: 50px;
            text-align: center;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-soft);
        }
        
        .form-input::placeholder {
            color: var(--text-muted);
        }
        
        .form-input.error {
            border-color: var(--danger);
            animation: shake 0.5s ease-in-out;
        }
        
        /* Hide number spinners */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        input[type="tel"] {
            font-variant-numeric: tabular-nums;
        }
        
        .form-select {
            width: 100%;
            padding: 14px 40px 14px 16px;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            color: var(--text);
            background: transparent;
            border: 1.5px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23999' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 20px;
            min-height: 50px;
            transition: all 0.2s ease;
            text-align: center;
        }
        
        .form-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-soft);
        }
        
        .form-optional {
            font-size: 0.65rem;
            color: var(--text-muted);
            font-weight: 400;
            text-transform: none;
            letter-spacing: 0;
            margin-left: 4px;
        }
        
        .identify-btn {
            width: 100%;
            padding: 16px 24px;
            margin-top: 12px;
            background: var(--text);
            color: white;
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12), 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        
        .identify-btn:hover:not(:disabled) { 
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .identify-btn:active:not(:disabled) { 
            transform: translateY(0);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        }
        .identify-btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .form-error {
            color: var(--danger);
            font-size: 0.75rem;
            margin-top: 8px;
            text-align: center;
            display: none;
        }
        
        .form-error.show { display: block; }
        
        /* ========== START SCREEN ========== */
        .start-screen {
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 40px 24px;
        }
        
        .start-screen.active {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .start-icon {
            width: 80px;
            height: 80px;
            margin-bottom: 24px;
            background: var(--accent-soft);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .start-icon svg {
            width: 40px;
            height: 40px;
            color: var(--accent-dark);
        }
        
        .start-title {
            font-family: 'Outfit', sans-serif;
            font-size: 1.5rem;
            font-weight: 600;
            letter-spacing: -0.02em;
            margin-bottom: 8px;
        }
        
        .start-subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 32px;
            max-width: 280px;
            line-height: 1.5;
        }
        
        .start-phone-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px 20px;
            background: var(--surface);
            border-radius: 12px;
            margin-bottom: 24px;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text);
        }
        
        .start-phone-display svg {
            width: 18px;
            height: 18px;
            min-width: 18px;
            flex-shrink: 0;
            color: var(--accent-dark);
        }
        
        .start-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 16px 24px;
            background: var(--text);
            color: white;
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            max-width: 300px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12), 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        
        .start-btn:hover:not(:disabled) { transform: translateY(-2px); }
        .start-btn:active:not(:disabled) { transform: scale(0.98); }
        .start-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .start-btn svg { width: 22px; height: 22px; }
        
        .change-agent {
            margin-top: 16px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 0.85rem;
            cursor: pointer;
            text-decoration: underline;
        }
        
        .change-agent:hover { color: var(--text-secondary); }
        
        /* ========== CALL TYPE SELECTOR ========== */
        .call-type-selector {
            width: 100%;
            max-width: 280px;
            margin-bottom: 24px;
        }

        .call-type-label {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .call-type-buttons {
            display: flex;
            background: var(--surface);
            border-radius: 12px;
            padding: 4px;
            gap: 4px;
        }

        .call-type-btn {
            flex: 1;
            padding: 12px 8px;
            background: transparent;
            border: none;
            border-radius: 10px;
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .call-type-btn.active {
            background: var(--bg);
            color: var(--text);
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .call-type-btn:hover:not(.active) { color: var(--text); }

        .call-type-hint {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 8px;
            text-align: center;
        }
        
        /* ========== CLIENT PHONE INPUT ========== */
        .client-phone-section {
            width: 100%;
            max-width: 300px;
            margin-bottom: 24px;
        }
        
        .client-phone-section .form-label {
            display: block;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 8px;
            text-align: center;
        }
        
        .client-phone-section .form-input {
            width: 100%;
            padding: 14px 16px;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            font-variant-numeric: tabular-nums;
            color: var(--text);
            background: transparent;
            border: 1.5px solid var(--border);
            border-radius: 12px;
            transition: all 0.2s ease;
            text-align: center;
        }
        
        .client-phone-section .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-soft);
        }
        
        .client-phone-section .form-input.error {
            border-color: var(--danger);
            animation: shake 0.5s ease-in-out;
        }
        
        .client-phone-error {
            font-size: 0.75rem;
            color: var(--danger);
            margin-top: 8px;
            text-align: center;
            display: none;
        }
        
        .client-phone-error.visible {
            display: block;
        }
        
        /* Hide hint when error is showing */
        .client-phone-error.visible + .client-phone-hint {
            display: none;
        }
        
        .client-phone-hint {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 8px;
            text-align: center;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-8px); }
            40% { transform: translateX(8px); }
            60% { transform: translateX(-6px); }
            80% { transform: translateX(6px); }
        }
        
        /* ========== CONNECTING SCREEN ========== */
        .connecting-screen {
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 40px 24px;
        }
        
        .connecting-screen.active {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .connecting-title {
            font-family: 'Outfit', sans-serif;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text);
        }
        
        .connecting-subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 32px;
            max-width: 260px;
            line-height: 1.5;
        }
        
        /* Connection Steps - Refined Minimal */
        .connection-steps {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 32px;
            width: 100%;
            max-width: 300px;
        }
        
        .connection-step {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 18px;
            background: var(--bg);
            border: 1.5px solid var(--border);
            border-radius: 12px;
            opacity: 0.5;
            transition: all 0.3s ease;
        }
        
        .connection-step.active {
            opacity: 1;
            border-color: var(--text);
        }
        
        .connection-step.complete {
            opacity: 1;
            border-color: var(--border);
        }
        
        .step-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--surface);
            font-family: 'Outfit', sans-serif;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
            flex-shrink: 0;
            transition: all 0.3s ease;
        }
        
        .connection-step.active .step-number {
            background: var(--text);
            color: white;
            animation: stepPulse 1.5s ease-in-out infinite;
        }
        
        .connection-step.complete .step-number {
            background: var(--success);
            color: white;
        }
        
        .connection-step.complete .step-number svg {
            width: 14px;
            height: 14px;
        }
        
        @keyframes stepPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }
        
        .step-text {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-muted);
            transition: color 0.3s ease;
        }
        
        .connection-step.active .step-text {
            color: var(--text);
        }
        
        .connection-step.complete .step-text {
            color: var(--text-secondary);
        }
        
        .connecting-cancel {
            padding: 12px 24px;
            background: transparent;
            color: var(--text-muted);
            font-family: 'Outfit', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            border: 1px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .connecting-cancel:hover {
            background: var(--surface);
            color: var(--text);
        }
        
        /* ========== CALL SCREEN ========== */
        .call-screen { 
            position: relative;
            overflow: hidden;
            background: var(--bg);  /* Explicit white to prevent any rendering differences */
        }
        
        /* FLEX LAYOUT for sidebar + main content */
        .call-screen.active {
            display: flex;
            flex-direction: column;
        }
        
        .teleprompter {
            /* Flex child - fills available space */
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;  /* Start from top for scroll support */
            width: 100%;
            max-width: 100%;
            padding: 48px;
            text-align: center;
            cursor: pointer;
            transition: opacity 0.3s ease;
            box-sizing: border-box;
            /* Enable scrolling */
            min-height: 0;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            
            /* Pure white - premium doesn't need effects */
            background: var(--bg);
        }
        
        /* When guidance is shown - smart centering with scroll support */
        .teleprompter.has-guidance {
            justify-content: flex-start;
            padding: 48px;
        }
        
        .teleprompter:active { 
            /* No visual feedback needed - tap dismisses guidance */
        }
        
        .listening-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 100%;
            /* Smart centering - stays centered in flex-start container */
            margin: auto 0;
        }
        
        /* Branded Waveform - replaces ring */
        .listening-waveform {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            height: 48px;
            margin-bottom: 20px;
        }
        
        .waveform-bar {
            width: 4px;
            background: var(--accent);
            border-radius: 2px;
            animation: waveBreath 2s ease-in-out infinite;
        }
        
        .waveform-bar:nth-child(1) { height: 20px; animation-delay: 0s; }
        .waveform-bar:nth-child(2) { height: 32px; animation-delay: 0.15s; }
        .waveform-bar:nth-child(3) { height: 40px; animation-delay: 0.3s; }
        .waveform-bar:nth-child(4) { height: 32px; animation-delay: 0.45s; }
        .waveform-bar:nth-child(5) { height: 20px; animation-delay: 0.6s; }
        
        @keyframes waveBreath {
            0%, 100% { 
                transform: scaleY(0.5); 
                opacity: 0.4; 
            }
            50% { 
                transform: scaleY(1); 
                opacity: 0.8; 
            }
        }
        
        /* Legacy ring - hidden but kept for fallback */
        .listening-ring {
            display: none;
            width: 48px;
            height: 48px;
            border: 2px solid var(--accent);
            border-radius: 50%;
            margin-bottom: 20px;
            animation: ringPulse 2.5s ease-in-out infinite;
        }
        
        @keyframes ringPulse {
            0%, 100% { opacity: 0.35; transform: scale(0.95); }
            50% { opacity: 0.7; transform: scale(1); }
        }
        
        .listening-text {
            font-family: 'Outfit', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }
        
        /* Remove the subtitle - just "Listening" is enough */
        .listening-hint {
            display: none;
        }
        
        /* ========== SENTIMENT INDICATOR ========== */
        .sentiment-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            margin-top: 24px;
            padding: 12px 20px;
            background: var(--surface);
            border-radius: 12px;
            min-width: 180px;
            transition: all 0.4s ease;
            opacity: 0.9;
        }
        
        .sentiment-indicator.hidden {
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
        }
        
        .sentiment-main {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sentiment-emoji {
            font-size: 1.4rem;
            transition: transform 0.3s ease;
        }
        
        .sentiment-indicator.warming .sentiment-emoji {
            animation: bounceUp 0.5s ease;
        }
        
        .sentiment-indicator.cooling .sentiment-emoji {
            animation: bounceDown 0.5s ease;
        }
        
        @keyframes bounceUp {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }
        
        @keyframes bounceDown {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(4px); }
        }
        
        .sentiment-label {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }
        
        .sentiment-trajectory {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-left: 4px;
        }
        
        .sentiment-trajectory.warming {
            color: var(--success);
        }
        
        .sentiment-trajectory.cooling {
            color: var(--danger);
        }
        
        .sentiment-tip {
            font-size: 0.75rem;
            color: var(--accent-dark);
            text-align: center;
            max-width: 200px;
            line-height: 1.4;
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .sentiment-tip.visible {
            opacity: 1;
            max-height: 50px;
            margin-top: 4px;
        }
        
        /* Sentiment level colors */
        .sentiment-indicator[data-level="hot"] {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }
        
        .sentiment-indicator[data-level="hot"] .sentiment-label {
            color: var(--success);
        }
        
        .sentiment-indicator[data-level="warming"] {
            background: rgba(96, 165, 250, 0.1);
            border: 1px solid rgba(96, 165, 250, 0.2);
        }
        
        .sentiment-indicator[data-level="warming"] .sentiment-label {
            color: var(--accent-dark);
        }
        
        .sentiment-indicator[data-level="neutral"] {
            background: var(--surface);
            border: 1px solid var(--border);
        }
        
        .sentiment-indicator[data-level="cooling"] {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.2);
        }
        
        .sentiment-indicator[data-level="cooling"] .sentiment-label {
            color: #D97706;
        }
        
        .sentiment-indicator[data-level="cold"] {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }
        
        .sentiment-indicator[data-level="cold"] .sentiment-label {
            color: var(--danger);
        }
        
        /* Hard Exit State - subtle but clear */
        .sentiment-indicator[data-hard-exit="true"] {
            background: rgba(239, 68, 68, 0.08) !important;
            border: 1px solid rgba(239, 68, 68, 0.3) !important;
        }
        
        .sentiment-indicator[data-hard-exit="true"] .sentiment-emoji {
            color: var(--danger);
            animation: subtlePulse 1.5s ease-in-out infinite;
        }
        
        .sentiment-indicator[data-hard-exit="true"] .sentiment-label {
            color: var(--danger) !important;
            font-weight: 600;
        }
        
        @keyframes subtlePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Strike (Buying Signal) State - professional urgency */
        .sentiment-indicator[data-action="strike"] {
            background: rgba(16, 185, 129, 0.08) !important;
            border: 1px solid rgba(16, 185, 129, 0.3) !important;
        }
        
        .sentiment-indicator[data-action="strike"] .sentiment-emoji {
            color: var(--success);
            animation: subtlePulse 1.2s ease-in-out infinite;
        }
        
        .sentiment-indicator[data-action="strike"] .sentiment-label {
            color: var(--success) !important;
            font-weight: 600;
        }
        
        /* Exit action styling */
        .sentiment-indicator[data-action="exit"] {
            background: rgba(239, 68, 68, 0.06) !important;
            border: 1px solid rgba(239, 68, 68, 0.25) !important;
        }
        
        .sentiment-indicator[data-action="exit"] .sentiment-emoji {
            color: var(--danger);
        }
        
        .sentiment-indicator[data-action="exit"] .sentiment-label {
            color: var(--danger) !important;
        }
        
        /* Dot indicator colors based on temperature */
        .sentiment-indicator[data-level="hot"] .sentiment-emoji {
            color: var(--success);
        }
        
        .sentiment-indicator[data-level="warming"] .sentiment-emoji {
            color: var(--accent-dark);
        }
        
        .sentiment-indicator[data-level="neutral"] .sentiment-emoji {
            color: var(--text-muted);
        }
        
        .sentiment-indicator[data-level="cooling"] .sentiment-emoji {
            color: #D97706;
        }
        
        .sentiment-indicator[data-level="cold"] .sentiment-emoji {
            color: var(--danger);
        }
        
        /* Mobile adjustments */
        @media (max-width: 768px) {
            .sentiment-indicator {
                margin-top: 20px;
                padding: 10px 16px;
                min-width: 160px;
            }
            
            .sentiment-emoji {
                font-size: 1.2rem;
            }
            
            .sentiment-label {
                font-size: 0.7rem;
            }
        }
        
        .guidance-state {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            width: 100%;
            max-width: 900px;
            padding: 16px;
            box-sizing: border-box;
            position: relative;
            /* Smart centering: margin auto centers when content is short,
               but allows natural scroll when content is tall */
            margin: auto 0;
        }
        
        .guidance-state.active { 
            display: flex;
            animation: guidanceReveal 0.35s ease-out;
        }
        
        /* Premium reveal animation - scale + blur */
        @keyframes guidanceReveal {
            0% { 
                opacity: 0; 
                transform: scale(0.98);
                filter: blur(4px);
            }
            100% { 
                opacity: 1; 
                transform: scale(1);
                filter: blur(0);
            }
        }
        
        /* STRIKE action - subtle green tint on reveal */
        .guidance-state.strike {
            animation: guidanceRevealStrike 0.35s ease-out;
        }
        
        @keyframes guidanceRevealStrike {
            0% { 
                opacity: 0; 
                transform: scale(0.98);
                filter: blur(4px);
                background: rgba(16, 185, 129, 0.1);
            }
            100% { 
                opacity: 1; 
                transform: scale(1);
                filter: blur(0);
                background: transparent;
            }
        }
        
        /* EXIT action - subtle red tint on reveal */
        .guidance-state.exit {
            animation: guidanceRevealExit 0.35s ease-out;
        }
        
        @keyframes guidanceRevealExit {
            0% { 
                opacity: 0; 
                transform: scale(0.98);
                filter: blur(4px);
                background: rgba(239, 68, 68, 0.08);
            }
            100% { 
                opacity: 1; 
                transform: scale(1);
                filter: blur(0);
                background: transparent;
            }
        }
        
        /* WARN action - subtle amber tint */
        .guidance-state.warn {
            animation: guidanceRevealWarn 0.35s ease-out;
        }
        
        @keyframes guidanceRevealWarn {
            0% { 
                opacity: 0; 
                transform: scale(0.98);
                filter: blur(4px);
                background: rgba(217, 119, 6, 0.08);
            }
            100% { 
                opacity: 1; 
                transform: scale(1);
                filter: blur(0);
                background: transparent;
            }
        }
        
        /* Dismiss hint - fades in after 3s */
        .dismiss-hint {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            
            font-size: 0.75rem;
            color: var(--text-muted);
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
        }
        
        .guidance-state.show-hint .dismiss-hint {
            opacity: 1;
        }
        
        .guidance-text {
            width: 100%;
            max-width: 100%;
            font-size: clamp(1.4rem, 3.5vw, 2.5rem);
            line-height: 1.6;
            font-weight: 500;
            color: var(--text);
            text-align: center;
            overflow-wrap: break-word;
            word-wrap: break-word;
            padding-bottom: 24px; /* Buffer for dismiss hint */
            letter-spacing: -0.01em;
        }
        
        /* Numbers and prices stay bold - no special color for quotes anymore */
        .guidance-text .say-this {
            /* Removed blue color - just inherit normal text */
            font-weight: 500;
        }
        
        .guidance-text .cursor {
            display: inline-block;
            width: 3px;
            height: 1.3em;
            background: var(--accent);
            margin-left: 3px;
            animation: blink 0.6s infinite;
            vertical-align: text-bottom;
        }
        
        @keyframes blink {
            0%, 45% { opacity: 1; }
            50%, 100% { opacity: 0; }
        }
        
        /* Bridge phrase + loading indicator */
        .bridge-text {
            color: var(--text);
        }
        
        .loading-dots {
            color: var(--accent);
            animation: loadingPulse 1.2s ease-in-out infinite;
            margin-left: 8px;
        }
        
        .guidance-loading {
            font-size: 2rem;
            color: var(--accent);
            animation: loadingPulse 1.2s ease-in-out infinite;
            letter-spacing: 8px;
        }
        
        @keyframes loadingPulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        
        .guidance-text strong { font-weight: 700; }
        
        /* ========== CALL FOOTER ========== */
        /* Footer is now hidden - end button moved to header */
        .call-footer {
            display: none;
        }
        
        /* Legacy styles kept for reference */
        .end-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 28px;
            background: var(--surface);
            color: var(--text-secondary);
            font-family: 'Outfit', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            border: 1px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .end-btn:hover {
            background: var(--danger-soft);
            border-color: var(--danger);
            color: var(--danger);
        }
        
        .end-btn svg { width: 18px; height: 18px; }
        
        /* ========== TRANSCRIPT PANEL (Floating) ========== */
        .call-content-wrapper {
            display: flex;
            flex: 1;
            min-height: 0;
            overflow: hidden;
            position: relative;
            background: var(--bg);  /* Explicit white to prevent any subtle differences */
        }
        
        /* Collapsed state - just a pill */
        .transcript-pill {
            position: absolute;
            left: 24px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 10;
            
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            
            background: var(--surface);
            border-radius: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }
        
        .transcript-pill:hover {
            background: var(--border);
        }
        
        .transcript-pill:active {
            transform: translateY(-50%) scale(0.98);
        }
        
        .transcript-pill.hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateY(-50%) translateX(-20px);
        }
        
        .transcript-pill .pill-dot {
            width: 6px;
            height: 6px;
            background: var(--success);
            border-radius: 50%;
            animation: pillPulse 2s ease-in-out infinite;
        }
        
        @keyframes pillPulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        .transcript-pill .pill-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }
        
        /* Expanded state - floating panel */
        .transcript-panel {
            position: absolute;
            left: 24px;
            top: 24px;
            bottom: 24px;
            width: 300px;
            z-index: 20;
            
            display: flex;
            flex-direction: column;
            
            /* Premium glass effect */
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            
            border-radius: 16px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.08),
                0 2px 8px rgba(0, 0, 0, 0.04);
            /* No border - shadow defines edges */
            
            overflow: hidden;
            
            /* Hidden by default */
            opacity: 0;
            pointer-events: none;
            transform: translateX(-20px);
            transition: all 0.25s ease-out;
        }
        
        .transcript-panel.expanded {
            opacity: 1;
            pointer-events: auto;
            transform: translateX(0);
        }
        
        .transcript-panel-header {
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(to bottom, 
                rgba(255,255,255,1) 0%, 
                rgba(250,250,250,1) 100%
            );
            flex-shrink: 0;
        }
        
        .transcript-panel-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .transcript-panel-header .panel-dot {
            width: 6px;
            height: 6px;
            background: var(--success);
            border-radius: 50%;
            animation: pillPulse 2s ease-in-out infinite;
        }
        
        .transcript-panel-header .panel-title {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }
        
        .transcript-panel-close {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-muted);
            transition: all 0.15s ease;
        }
        
        .transcript-panel-close:hover {
            background: var(--surface);
            color: var(--text);
        }
        
        .transcript-panel-close svg {
            width: 16px;
            height: 16px;
        }
        
        .transcript-panel-feed {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 16px;
            padding-bottom: 32px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            
            /* Hidden scrollbar - premium */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .transcript-panel-feed::-webkit-scrollbar {
            display: none;
        }
        
        /* Fade at bottom */
        .transcript-panel::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 32px;
            background: linear-gradient(to top, rgba(255,255,255,0.92), transparent);
            pointer-events: none;
            z-index: 1;
            border-radius: 0 0 16px 16px;
        }
        
        /* LEGACY - keep for compatibility but hidden */
        .transcript-sidebar {
            display: none;
        }
        
        .transcript-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--surface);
        }
        
        .transcript-header-icon {
            width: 6px;
            height: 6px;
            background: var(--success);
            border-radius: 50%;
            animation: transcriptPulse 2s ease-in-out infinite;
        }
        
        @keyframes transcriptPulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        .transcript-header-text {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }
        
        .transcript-feed {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 16px;
            padding-bottom: 32px; /* Extra space at bottom for fade */
            display: flex;
            flex-direction: column;
            gap: 16px;
            
            /* Hidden scrollbar - premium */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .transcript-feed::-webkit-scrollbar {
            display: none;
        }
        
        /* Top fade when scrolled */
        .transcript-sidebar::before {
            content: '';
            position: absolute;
            top: 53px; /* Below header (padding + content + border) */
            left: 0;
            right: 0;
            height: 32px;
            background: linear-gradient(to bottom, var(--surface), transparent);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 2;
        }
        
        .transcript-sidebar.has-scroll::before {
            opacity: 1;
        }
        
        /* Bottom fade - always visible for polish */
        .transcript-sidebar::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 32px;
            background: linear-gradient(to top, var(--surface), transparent);
            pointer-events: none;
            z-index: 1;
        }
        
        .transcript-msg {
            display: flex;
            flex-direction: column;
            gap: 4px;
            animation: msgFadeIn 0.2s ease;
        }
        
        @keyframes msgFadeIn {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .transcript-label {
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }
        
        .transcript-text {
            font-size: 0.8125rem;
            line-height: 1.5;
        }
        
        .transcript-msg.agent .transcript-text {
            color: var(--text-muted);
        }
        
        .transcript-msg.client .transcript-text {
            color: var(--text);
            font-weight: 500;
        }
        
        /* Live typing cursor */
        .transcript-text .cursor {
            display: inline-block;
            width: 2px;
            height: 0.9em;
            background: var(--accent);
            margin-left: 2px;
            animation: cursorBlink 0.8s infinite;
            vertical-align: text-bottom;
        }
        
        .transcript-empty {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 0.8rem;
            font-style: italic;
        }
        
        .call-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            min-height: 0;  /* Critical for flex shrinking */
            overflow: hidden;
            background: var(--bg);
        }
        
        /* Guidance area: teleprompter + temp meter side by side */
        .guidance-area {
            flex: 1;
            display: flex;
            flex-direction: row;
            min-height: 0;
            overflow: hidden;
            background: var(--bg);  /* Explicit white */
        }
        
        .guidance-area .teleprompter {
            flex: 1;
            min-width: 0;
        }
        
        /* ========== TEMPERATURE METER ========== */
        .temp-meter {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 24px 16px;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        
        .temp-meter.visible {
            opacity: 1;
        }
        
        /* Fade temp meter when guidance is showing - guidance is the star */
        .teleprompter.has-guidance ~ .temp-meter {
            opacity: 0.5;
        }
        
        .temp-label {
            font-size: 0.65rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: var(--text-muted);
            transition: color 0.3s ease;
        }
        
        .temp-label.temp-top {
            color: rgba(16, 185, 129, 0.6);
        }
        
        .temp-label.temp-bottom {
            color: rgba(96, 165, 250, 0.6);
        }
        
        /* Active state labels */
        .temp-meter[data-zone="close"] .temp-label.temp-top {
            color: var(--success);
        }
        
        .temp-meter[data-zone="exit"] .temp-label.temp-bottom {
            color: var(--accent-dark);
        }
        
        .temp-track {
            position: relative;
            width: 6px;
            flex: 1;
            min-height: 120px;
            border-radius: 3px;
            /* Premium gradient: green (top) to blue (bottom) */
            background: linear-gradient(
                to bottom,
                #10B981 0%,      /* Emerald - Close */
                #34D399 20%,     /* Light green */
                #5EEAD4 40%,     /* Teal */
                #7DD3FC 60%,     /* Light blue */
                #60A5FA 80%,     /* Blue */
                #3B82F6 100%    /* Deep blue - Exit */
            );
            overflow: visible;
        }
        
        .temp-fill {
            /* Not using fill approach - using indicator instead */
            display: none;
        }
        
        .temp-indicator {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--bg);
            border: 3px solid var(--text);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: top 0.5s cubic-bezier(0.4, 0, 0.2, 1), 
                        border-color 0.3s ease,
                        box-shadow 0.3s ease;
            top: 50%; /* Default: neutral */
            margin-top: -7px; /* Center the indicator */
        }
        
        /* Indicator color based on position */
        .temp-meter[data-level="hot"] .temp-indicator {
            border-color: #10B981;
            box-shadow: 0 2px 12px rgba(16, 185, 129, 0.4);
        }
        
        .temp-meter[data-level="warming"] .temp-indicator {
            border-color: #34D399;
            box-shadow: 0 2px 10px rgba(52, 211, 153, 0.3);
        }
        
        .temp-meter[data-level="neutral"] .temp-indicator {
            border-color: #5EEAD4;
            box-shadow: 0 2px 8px rgba(94, 234, 212, 0.3);
        }
        
        .temp-meter[data-level="cooling"] .temp-indicator {
            border-color: #60A5FA;
            box-shadow: 0 2px 10px rgba(96, 165, 250, 0.3);
        }
        
        .temp-meter[data-level="cold"] .temp-indicator {
            border-color: #3B82F6;
            box-shadow: 0 2px 12px rgba(59, 130, 246, 0.4);
        }
        
        /* Critical states: subtle pulse */
        .temp-meter[data-action="strike"] .temp-indicator {
            animation: meterPulse 1.5s ease-in-out infinite;
            border-color: #10B981;
        }
        
        .temp-meter[data-action="exit"] .temp-indicator {
            animation: meterPulse 1.5s ease-in-out infinite;
            border-color: #3B82F6;
        }
        
        @keyframes meterPulse {
            0%, 100% { 
                transform: translateX(-50%) scale(1);
                opacity: 1;
            }
            50% { 
                transform: translateX(-50%) scale(1.15);
                opacity: 0.85;
            }
        }
        
        /* Mobile: meter on right edge, more compact */
        @media (max-width: 768px) {
            .temp-meter {
                padding: 16px 10px;
            }
            
            .temp-track {
                width: 5px;
                min-height: 100px;
            }
            
            .temp-indicator {
                width: 12px;
                height: 12px;
                border-width: 2px;
                margin-top: -6px;
            }
            
            .temp-label {
                font-size: 0.6rem;
            }
        }
        
        /* Footer now inside call-main */
        .call-main .call-footer {
            flex-shrink: 0;
        }
        
        /* Mobile: Floating transcript as bottom sheet */
        @media (max-width: 768px) {
            .call-content-wrapper {
                flex-direction: column;
            }
            
            /* Hide desktop transcript pill on mobile */
            .transcript-pill {
                display: none;
            }
            
            /* Mobile transcript panel - bottom sheet style */
            .transcript-panel {
                position: fixed;
                left: 16px;
                right: 16px;
                bottom: 16px;
                top: auto;
                width: auto;
                max-height: 40vh;
                
                /* Start collapsed */
                transform: translateY(calc(100% - 52px));
                opacity: 1;
                pointer-events: auto;
            }
            
            .transcript-panel.expanded {
                transform: translateY(0);
            }
            
            .transcript-panel-header {
                cursor: pointer;
            }
            
            /* Show drag handle on mobile */
            .transcript-panel-header::before {
                content: '';
                position: absolute;
                top: 8px;
                left: 50%;
                transform: translateX(-50%);
                width: 32px;
                height: 4px;
                background: var(--border);
                border-radius: 2px;
            }
            
            /* Always show panel on mobile (collapsed by default) */
            .transcript-panel.mobile-visible {
                opacity: 1;
                pointer-events: auto;
                transform: translateY(calc(100% - 52px));
            }
            
            .transcript-panel.mobile-visible.expanded {
                transform: translateY(0);
            }
            
            /* Legacy sidebar - hidden on mobile */
            .transcript-sidebar {
                display: none;
            }
            
            .call-main {
                order: 1;
                flex: 1;
                min-height: 0;
                overflow: hidden;
            }
            
            /* Teleprompter is the scroll container on mobile */
            .call-main .teleprompter {
                flex: 1;
                min-height: 0;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                padding: 32px 24px;
                justify-content: flex-start;  /* Start from top for scroll */
            }
            
            /* Smart centering on mobile - margin auto handles it */
            .call-main .teleprompter.has-guidance {
                justify-content: flex-start;
                padding: 32px 24px;
            }
            
            /* Guidance with smart centering */
            .call-main .guidance-state {
                flex-shrink: 0;
                padding-bottom: 24px; /* Buffer for dismiss hint */
                margin: auto 0;  /* Centers when short, scrolls when tall */
            }
            
            .call-main .guidance-text {
                /* Slightly smaller on mobile for better fit */
                font-size: clamp(1.2rem, 5vw, 1.6rem);
                line-height: 1.55;
            }
            
            /* Temp meter on mobile */
            .temp-meter {
                padding: 16px 12px;
            }
        }
        
        /* ========== SESSION COMPLETE SCREEN ========== */
        .complete-screen {
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 40px 24px;
        }
        
        .complete-screen.active {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .complete-icon {
            width: 72px;
            height: 72px;
            background: var(--success-soft);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
        }
        
        .complete-icon svg {
            width: 36px;
            height: 36px;
            color: var(--success);
        }
        
        .complete-title {
            font-family: 'Outfit', sans-serif;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 24px;
        }
        
        .complete-stats {
            margin-bottom: 40px;
        }
        
        .complete-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        
        .complete-stat-value {
            font-family: 'Outfit', sans-serif;
            font-size: 2rem;
            font-weight: 700;
            color: var(--text);
        }
        
        .complete-stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .complete-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
            max-width: 280px;
        }
        
        .complete-btn {
            padding: 16px 24px;
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }
        
        .complete-btn:active {
            transform: scale(0.97);
        }
        
        .complete-btn.primary {
            background: var(--text);
            color: white;
            border: none;
        }
        
        .complete-btn.secondary {
            background: var(--surface);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }
        
        .complete-btn.primary:hover { transform: translateY(-2px); }
        .complete-btn.primary:active { transform: scale(0.98); }
        .complete-btn.secondary:hover { background: var(--bg); }

        /* ========== ERROR MODAL ========== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            padding: 20px;
            padding-top: max(20px, env(safe-area-inset-top));
            padding-bottom: max(20px, env(safe-area-inset-bottom));
        }
        
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background: var(--bg);
            border-radius: 16px;
            padding: 24px;
            width: 100%;
            max-width: 340px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
            transform: scale(0.95);
            transition: transform 0.2s ease;
        }
        
        .modal-overlay.visible .modal {
            transform: scale(1);
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 6px;
        }
        
        .modal-icon {
            width: 36px;
            height: 36px;
            background: var(--danger-soft);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .modal-icon svg {
            width: 18px;
            height: 18px;
            color: var(--danger);
        }
        
        .modal-title {
            font-family: 'Outfit', sans-serif;
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text);
        }
        
        .modal-desc {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            margin-bottom: 16px;
            line-height: 1.5;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
        }
        
        .modal-btn {
            flex: 1;
            padding: 12px 16px;
            border-radius: 10px;
            font-family: 'Inter', sans-serif;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .modal-btn-cancel {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }
        
        .modal-btn-cancel:hover {
            background: var(--surface);
            color: var(--text);
        }
        
        .modal-btn-confirm {
            background: var(--text);
            border: none;
            color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12), 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        
        .modal-btn-confirm:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .modal-btn-confirm:active {
            transform: translateY(0);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        }
        
        /* ========== VERIFICATION MODAL ========== */
        .verify-modal .modal-icon {
            background: var(--accent-soft);
        }
        
        .verify-modal .modal-icon svg {
            color: var(--accent);
        }
        
        .method-toggle {
            display: flex;
            background: var(--surface);
            border-radius: 10px;
            padding: 4px;
            margin-bottom: 16px;
        }
        
        .method-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 12px;
            background: transparent;
            border: none;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .method-btn.active {
            background: var(--bg);
            color: var(--text);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .method-btn svg {
            width: 16px;
            height: 16px;
        }
        
        .code-input-wrapper {
            margin-bottom: 16px;
        }
        
        .code-input {
            width: 100%;
            padding: 16px;
            font-family: 'Inter', sans-serif;
            font-size: 1.5rem;
            font-weight: 600;
            letter-spacing: 0.5em;
            text-align: center;
            color: var(--text);
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 12px;
            transition: all 0.15s ease;
        }
        
        .code-input:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg);
        }
        
        .code-input::placeholder {
            letter-spacing: 0.3em;
            color: var(--text-muted);
        }
        
        .code-input.error {
            border-color: var(--danger);
            animation: shake 0.5s ease-in-out;
        }
        
        .resend-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            font-size: 0.8125rem;
            color: var(--text-muted);
            margin-bottom: 20px;
        }
        
        .resend-btn {
            background: none;
            border: none;
            color: var(--accent);
            font-family: 'Inter', sans-serif;
            font-size: 0.8125rem;
            font-weight: 500;
            cursor: pointer;
            padding: 0;
        }
        
        .resend-btn:disabled {
            color: var(--text-muted);
            cursor: not-allowed;
        }
        
        .verify-sending {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 24px 0;
        }
        
        .verify-waveform {
            display: flex;
            align-items: center;
            gap: 4px;
            height: 32px;
            margin-bottom: 16px;
        }
        
        .verify-waveform .bar {
            width: 5px;
            border-radius: 2.5px;
            background: var(--accent);
            animation: waveformPulse 1s ease-in-out infinite;
        }
        
        .verify-waveform .bar:nth-child(1) { height: 12px; animation-delay: 0s; }
        .verify-waveform .bar:nth-child(2) { height: 24px; animation-delay: 0.1s; }
        .verify-waveform .bar:nth-child(3) { height: 16px; animation-delay: 0.2s; }
        .verify-waveform .bar:nth-child(4) { height: 28px; animation-delay: 0.3s; }
        .verify-waveform .bar:nth-child(5) { height: 14px; animation-delay: 0.4s; }
        
        .verify-success {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
        }
        
        .verify-success-icon {
            width: 64px;
            height: 64px;
            background: var(--success-soft);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
        }
        
        .verify-success-icon svg {
            width: 32px;
            height: 32px;
            color: var(--success);
        }
        
        .verify-success-title {
            font-family: 'Outfit', sans-serif;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 4px;
        }
        
        .verify-success-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .verify-state { display: none; }
        .verify-state.active { display: block; }
        .verify-sending.active,
        .verify-success.active {
            display: flex;
        }
        
        .verify-error {
            font-size: 0.75rem;
            color: var(--danger);
            text-align: center;
            margin-bottom: 12px;
            display: none;
        }
        
        .verify-error.visible {
            display: block;
        }
        
        /* ========== RESPONSIVE ========== */
        @media (min-width: 768px) {
            .header { padding: 20px 32px; }
            .teleprompter { padding: 40px; }
            .review-screen, .outcome-screen, .noclose-screen, .identify-screen, .start-screen, .connecting-screen {
                max-width: 500px;
                margin: 0 auto;
            }
        }
        
        /* ========== PAGE LOADER ========== */
        .page-loader {
            position: fixed;
            inset: 0;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 1;
            visibility: visible;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .page-loader.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        
        .page-loader-waveform {
            display: flex;
            align-items: center;
            gap: 4px;
            height: 32px;
        }
        
        .page-loader-waveform .bar {
            width: 5px;
            border-radius: 2.5px;
            background: var(--accent);
            animation: waveformPulse 1s ease-in-out infinite;
        }
        
        .page-loader-waveform .bar:nth-child(1) { height: 12px; animation-delay: 0s; }
        .page-loader-waveform .bar:nth-child(2) { height: 24px; animation-delay: 0.1s; }
        .page-loader-waveform .bar:nth-child(3) { height: 16px; animation-delay: 0.2s; }
        .page-loader-waveform .bar:nth-child(4) { height: 28px; animation-delay: 0.3s; }
        .page-loader-waveform .bar:nth-child(5) { height: 14px; animation-delay: 0.4s; }
        
        @keyframes waveformPulse {
            0%, 100% { transform: scaleY(1); opacity: 0.7; }
            50% { transform: scaleY(0.5); opacity: 0.4; }
        }
    </style>
</head>
<body>
    <!-- Landscape Blocker -->
    <div class="landscape-blocker">
        <img src="/static/logo.png" alt="Coachd" class="landscape-logo">
        
        <div class="phone-wrapper">
            <div class="phone-shadow"></div>
            <div class="phone-device">
                <svg viewBox="0 0 48 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="titaniumFrame" x1="0" y1="0" x2="48" y2="0" gradientUnits="userSpaceOnUse">
                            <stop offset="0%" stop-color="#4A4A4C"/>
                            <stop offset="15%" stop-color="#2C2C2E"/>
                            <stop offset="50%" stop-color="#1F1F21"/>
                            <stop offset="85%" stop-color="#2C2C2E"/>
                            <stop offset="100%" stop-color="#4A4A4C"/>
                        </linearGradient>
                        <linearGradient id="frameDepth" x1="24" y1="0" x2="24" y2="100" gradientUnits="userSpaceOnUse">
                            <stop offset="0%" stop-color="#FFFFFF" stop-opacity="0.08"/>
                            <stop offset="50%" stop-color="#FFFFFF" stop-opacity="0"/>
                            <stop offset="100%" stop-color="#000000" stop-opacity="0.1"/>
                        </linearGradient>
                        <linearGradient id="edgeHighlight" x1="0" y1="50" x2="48" y2="50" gradientUnits="userSpaceOnUse">
                            <stop offset="0%" stop-color="#5A5A5C"/>
                            <stop offset="3%" stop-color="#3A3A3C"/>
                            <stop offset="97%" stop-color="#3A3A3C"/>
                            <stop offset="100%" stop-color="#5A5A5C"/>
                        </linearGradient>
                        <linearGradient id="screenOLED" x1="24" y1="3" x2="24" y2="97" gradientUnits="userSpaceOnUse">
                            <stop offset="0%" stop-color="#0A0A0A"/>
                            <stop offset="100%" stop-color="#000000"/>
                        </linearGradient>
                        <linearGradient id="glassReflectTop" x1="24" y1="3" x2="24" y2="20" gradientUnits="userSpaceOnUse">
                            <stop offset="0%" stop-color="#FFFFFF" stop-opacity="0.06"/>
                            <stop offset="100%" stop-color="#FFFFFF" stop-opacity="0"/>
                        </linearGradient>
                        <linearGradient id="glassReflectDiag" x1="5" y1="10" x2="40" y2="45" gradientUnits="userSpaceOnUse">
                            <stop offset="0%" stop-color="#FFFFFF" stop-opacity="0.04"/>
                            <stop offset="50%" stop-color="#FFFFFF" stop-opacity="0.01"/>
                            <stop offset="100%" stop-color="#FFFFFF" stop-opacity="0"/>
                        </linearGradient>
                        <linearGradient id="buttonMetal" x1="0" y1="0" x2="2" y2="0" gradientUnits="userSpaceOnUse">
                            <stop offset="0%" stop-color="#5A5A5C"/>
                            <stop offset="30%" stop-color="#3A3A3C"/>
                            <stop offset="70%" stop-color="#2A2A2C"/>
                            <stop offset="100%" stop-color="#1A1A1C"/>
                        </linearGradient>
                        <linearGradient id="islandDepth" x1="24" y1="6" x2="24" y2="13" gradientUnits="userSpaceOnUse">
                            <stop offset="0%" stop-color="#000000"/>
                            <stop offset="100%" stop-color="#0A0A0A"/>
                        </linearGradient>
                        <linearGradient id="homeIndicator" x1="14" y1="93" x2="34" y2="93" gradientUnits="userSpaceOnUse">
                            <stop offset="0%" stop-color="#3A3A3C"/>
                            <stop offset="50%" stop-color="#4A4A4C"/>
                            <stop offset="100%" stop-color="#3A3A3C"/>
                        </linearGradient>
                        <linearGradient id="antennaBand" x1="0" y1="0" x2="0" y2="4" gradientUnits="userSpaceOnUse">
                            <stop offset="0%" stop-color="#1A1A1C"/>
                            <stop offset="50%" stop-color="#252527"/>
                            <stop offset="100%" stop-color="#1A1A1C"/>
                        </linearGradient>
                    </defs>
                    <rect x="0.5" y="0.5" width="47" height="99" rx="10.5" fill="url(#titaniumFrame)"/>
                    <rect x="0.5" y="0.5" width="47" height="99" rx="10.5" fill="url(#frameDepth)"/>
                    <rect x="0.5" y="0.5" width="47" height="99" rx="10.5" fill="none" stroke="url(#edgeHighlight)" stroke-width="0.5"/>
                    <rect x="0" y="18" width="1" height="3" fill="url(#antennaBand)"/>
                    <rect x="47" y="18" width="1" height="3" fill="url(#antennaBand)"/>
                    <rect x="0" y="79" width="1" height="3" fill="url(#antennaBand)"/>
                    <rect x="47" y="79" width="1" height="3" fill="url(#antennaBand)"/>
                    <rect x="1.5" y="1.5" width="45" height="97" rx="9.5" fill="#050505"/>
                    <rect x="2.5" y="2.5" width="43" height="95" rx="8.5" fill="url(#screenOLED)"/>
                    <rect x="2.5" y="2.5" width="43" height="20" rx="8.5" fill="url(#glassReflectTop)"/>
                    <rect x="2.5" y="2.5" width="43" height="50" rx="8.5" fill="url(#glassReflectDiag)"/>
                    <rect x="13" y="6.5" width="22" height="7" rx="3.5" fill="url(#islandDepth)"/>
                    <rect x="13.5" y="7" width="21" height="6" rx="3" fill="none" stroke="#1A1A1A" stroke-width="0.5"/>
                    <circle cx="29" cy="9.5" r="2" fill="#0D0D0D"/>
                    <circle cx="29" cy="9.5" r="1.3" fill="#1A1A1A"/>
                    <circle cx="29" cy="9.5" r="0.8" fill="#0A0A0A"/>
                    <circle cx="28.5" cy="9" r="0.3" fill="#3A3A3A"/>
                    <circle cx="19" cy="9.5" r="1.2" fill="#0D0D0D"/>
                    <circle cx="22" cy="9.5" r="0.6" fill="#0D0D0D"/>
                    <rect x="46.5" y="26" width="1.5" height="13" rx="0.75" fill="url(#buttonMetal)"/>
                    <rect x="47.3" y="26.5" width="0.3" height="12" rx="0.15" fill="#5A5A5C" opacity="0.5"/>
                    <rect x="0" y="14" width="1.5" height="5" rx="0.75" fill="url(#buttonMetal)"/>
                    <rect x="0.3" y="14.5" width="0.3" height="4" rx="0.15" fill="#5A5A5C" opacity="0.5"/>
                    <rect x="0" y="23" width="1.5" height="9" rx="0.75" fill="url(#buttonMetal)"/>
                    <rect x="0.3" y="23.5" width="0.3" height="8" rx="0.15" fill="#5A5A5C" opacity="0.5"/>
                    <rect x="0" y="35" width="1.5" height="9" rx="0.75" fill="url(#buttonMetal)"/>
                    <rect x="0.3" y="35.5" width="0.3" height="8" rx="0.15" fill="#5A5A5C" opacity="0.5"/>
                    <rect x="14" y="92" width="20" height="4" rx="2" fill="url(#homeIndicator)"/>
                    <circle cx="14" cy="96.5" r="0.6" fill="#2A2A2C"/>
                    <circle cx="16" cy="96.5" r="0.6" fill="#2A2A2C"/>
                    <circle cx="18" cy="96.5" r="0.6" fill="#2A2A2C"/>
                    <rect x="21" y="95.5" width="6" height="2" rx="1" fill="#1A1A1C"/>
                    <circle cx="30" cy="96.5" r="0.6" fill="#2A2A2C"/>
                    <circle cx="32" cy="96.5" r="0.6" fill="#2A2A2C"/>
                    <circle cx="34" cy="96.5" r="0.6" fill="#2A2A2C"/>
                    <rect x="10" y="0.25" width="28" height="0.5" rx="0.25" fill="#5A5A5C" opacity="0.3"/>
                    <circle cx="10.5" cy="10.5" r="0.3" fill="#6A6A6C" opacity="0.2"/>
                    <circle cx="37.5" cy="10.5" r="0.3" fill="#6A6A6C" opacity="0.2"/>
                </svg>
            </div>
        </div>
        
        <div class="landscape-text">
            <h2 class="landscape-title">Rotate to portrait</h2>
            <p class="landscape-subtitle">For the best experience</p>
        </div>
    </div>
    
    <div class="app" id="app">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <button class="back-btn" onclick="handleBack()" aria-label="Go back">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                        <path d="M15 18l-6-6 6-6"/>
                    </svg>
                </button>
                <img src="/static/logo.png" alt="Coachd" height="24" class="logo">
            </div>
            <div class="header-right">
                <span class="timer" id="timer">0:00</span>
                <button class="end-session-btn" id="endSessionBtn" onclick="Coachd.endCall()">End</button>
            </div>
        </header>
        
        <!-- Identify Screen -->
        <div class="screen identify-screen active" id="identifyScreen">
            <div class="identify-card">
                <div class="identify-header">
                    <h1 class="identify-title">Agent Setup</h1>
                    <p class="identify-subtitle">One-time setup to get started</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Your Phone Number</label>
                    <input type="tel" class="form-input" id="agentPhone" placeholder="(404) 555-1234" autocomplete="tel">
                    <div class="form-error" id="identifyError">Please enter a valid phone number</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Agency</label>
                    <select class="form-select" id="agencySelect">
                        <option value="">Select your agency...</option>
                    </select>
                </div>
                
                <button class="identify-btn" onclick="Coachd.saveIdentity()">Continue</button>
            </div>
        </div>
        
        <!-- Start Screen -->
        <div class="screen start-screen" id="startScreen">
            <h1 class="start-title">Ready to Coach</h1>
            <p class="start-subtitle">Live coaching enabled</p>
            
            <div class="start-phone-display" id="phoneDisplay">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                </svg>
                <span id="phoneDisplayNumber">(404) 555-1234</span>
            </div>
            
            <!-- Client Phone Input for Click-to-Call -->
            <div class="client-phone-section">
                <label class="form-label">CLIENT PHONE NUMBER</label>
                <input type="tel" 
                       id="clientPhoneInput" 
                       class="form-input"
                       placeholder="(555) 123-4567"
                       autocomplete="tel">
                <p class="client-phone-error" id="clientPhoneError">Please enter a valid phone number</p>
                <div class="client-phone-hint">We'll dial your client after you answer</div>
            </div>
            
            <button class="start-btn" id="startBtn" onclick="Coachd.startCall()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                </svg>
                Start Coaching
            </button>
            <button class="change-agent" onclick="Coachd.changeAgent()">Not you? Change settings</button>
        </div>
        
        <!-- Connecting Screen -->
        <div class="screen connecting-screen" id="connectingScreen">
            <h1 class="connecting-title" id="connectingTitle">Calling Your Phone...</h1>
            <p class="connecting-subtitle" id="connectingSubtitle">Answer, then we'll dial your client</p>
            
            <div class="connection-steps">
                <div class="connection-step active" id="stepAgent">
                    <div class="step-number" id="stepAgentNumber">1</div>
                    <span class="step-text" id="stepAgentText">Calling your phone...</span>
                </div>
                
                <div class="connection-step" id="stepClient">
                    <div class="step-number" id="stepClientNumber">2</div>
                    <span class="step-text" id="stepClientText">Calling client...</span>
                </div>
                
                <div class="connection-step" id="stepReady">
                    <div class="step-number" id="stepReadyNumber">3</div>
                    <span class="step-text">Ready to coach!</span>
                </div>
            </div>
            
            <button class="connecting-cancel" onclick="Coachd.cancelCall()">Cancel</button>
        </div>
        
        <!-- Call Screen -->
        <div class="screen call-screen" id="callScreen">
            <div class="call-content-wrapper">
                <!-- Transcript Pill (Collapsed state) -->
                <div class="transcript-pill" id="transcriptPill" onclick="Coachd.toggleTranscript()">
                    <div class="pill-dot"></div>
                    <span class="pill-label">Live</span>
                </div>
                
                <!-- Transcript Panel (Expanded state) -->
                <div class="transcript-panel" id="transcriptPanel">
                    <div class="transcript-panel-header" onclick="Coachd.toggleTranscript()">
                        <div class="transcript-panel-header-left">
                            <div class="panel-dot"></div>
                            <span class="panel-title">Live Transcript</span>
                        </div>
                        <button class="transcript-panel-close" onclick="event.stopPropagation(); Coachd.toggleTranscript()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                                <path d="M18 6L6 18M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    <div class="transcript-panel-feed" id="transcriptFeed">
                        <div class="transcript-empty" id="transcriptEmpty">Waiting for conversation...</div>
                    </div>
                </div>
                
                <!-- Main Guidance Area -->
                <div class="call-main">
                    <div class="guidance-area">
                        <div class="teleprompter" id="teleprompter" onclick="Coachd.dismissGuidance()">
                            <div class="listening-state" id="listeningState">
                                <!-- Branded Waveform -->
                                <div class="listening-waveform">
                                    <div class="waveform-bar"></div>
                                    <div class="waveform-bar"></div>
                                    <div class="waveform-bar"></div>
                                    <div class="waveform-bar"></div>
                                    <div class="waveform-bar"></div>
                                </div>
                                <div class="listening-text">Listening</div>
                            </div>
                            
                            <div class="guidance-state" id="guidanceState">
                                <div class="guidance-text" id="guidanceText"></div>
                                <div class="dismiss-hint">Tap anywhere to dismiss</div>
                            </div>
                        </div>
                        
                        <!-- Temperature Meter -->
                        <div class="temp-meter" id="tempMeter">
                            <span class="temp-label temp-top">Close</span>
                            <div class="temp-track">
                                <div class="temp-fill" id="tempFill"></div>
                                <div class="temp-indicator" id="tempIndicator"></div>
                            </div>
                            <span class="temp-label temp-bottom">Exit</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Session Complete Screen -->
        <div class="screen complete-screen" id="completeScreen">
            <h1 class="complete-title">Session Complete</h1>
            <div class="complete-stats">
                <div class="complete-stat">
                    <span class="complete-stat-value" id="completeDuration">0:00</span>
                    <span class="complete-stat-label">Duration</span>
                </div>
            </div>
            <div class="complete-actions">
                <button class="complete-btn primary" onclick="Coachd.startNewCall()">New Call</button>
            </div>
        </div>
        
        <!-- Error Modal -->
        <div class="modal-overlay" id="errorModal">
            <div class="modal">
                <div class="modal-header">
                    <div class="modal-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                    </div>
                    <h3 class="modal-title" id="errorModalTitle">Connection Failed</h3>
                </div>
                <p class="modal-desc" id="errorModalMessage">Unable to start the call. Please try again.</p>
                <div class="modal-actions" id="errorModalActions">
                    <button class="modal-btn modal-btn-confirm" onclick="Coachd.closeErrorModal()">OK</button>
                </div>
            </div>
        </div>
        
        <!-- Verification Modal -->
        <div class="modal-overlay verify-modal" id="verifyModal">
            <div class="modal">
                <!-- State 1: Initial -->
                <div class="verify-state active" id="verifyStateInitial">
                    <div class="modal-header">
                        <div class="modal-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                                <polyline points="9 12 11 14 15 10"/>
                            </svg>
                        </div>
                        <h3 class="modal-title">Quick Verification</h3>
                    </div>
                    <p class="modal-desc">To display your caller ID, we need to verify your phone number once. This only takes a moment.</p>
                    
                    <div class="method-toggle">
                        <button class="method-btn active" data-method="sms" onclick="Coachd.setVerifyMethod('sms')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                            </svg>
                            Text SMS
                        </button>
                        <button class="method-btn" data-method="call" onclick="Coachd.setVerifyMethod('call')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                            </svg>
                            Phone Call
                        </button>
                    </div>
                    
                    <div class="modal-actions">
                        <button class="modal-btn modal-btn-cancel" onclick="Coachd.closeVerifyModal()">Cancel</button>
                        <button class="modal-btn modal-btn-confirm" onclick="Coachd.sendVerifyCode()">Send Code</button>
                    </div>
                </div>
                
                <!-- State 2: Sending -->
                <div class="verify-state verify-sending" id="verifyStateSending">
                    <div class="verify-waveform">
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                    </div>
                    <span class="modal-desc" style="margin-bottom:0">Sending verification code...</span>
                </div>
                
                <!-- State 3: Enter Code -->
                <div class="verify-state" id="verifyStateCode">
                    <div class="modal-header">
                        <div class="modal-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                            </svg>
                        </div>
                        <h3 class="modal-title">Enter Code</h3>
                    </div>
                    <p class="modal-desc" id="verifyCodeDesc">We sent a 5-digit code to your phone</p>
                    
                    <div class="code-input-wrapper">
                        <input type="text" 
                               class="code-input" 
                               id="verifyCodeInput"
                               inputmode="numeric" 
                               autocomplete="one-time-code"
                               maxlength="5"
                               placeholder=""
                               oninput="Coachd.handleCodeInput(this)">
                    </div>
                    
                    <div class="verify-error" id="verifyError">Invalid code. Please try again.</div>
                    
                    <div class="resend-row">
                        <span>Didn't receive it?</span>
                        <button class="resend-btn" id="resendBtn" disabled onclick="Coachd.resendCode()">Resend (60s)</button>
                    </div>
                    
                    <div class="modal-actions">
                        <button class="modal-btn modal-btn-cancel" onclick="Coachd.showVerifyState('verifyStateInitial')">Back</button>
                        <button class="modal-btn modal-btn-confirm" id="verifyConfirmBtn" disabled onclick="Coachd.confirmVerifyCode()">Verify</button>
                    </div>
                </div>
                
                <!-- State 4: Success -->
                <div class="verify-state verify-success" id="verifyStateSuccess">
                    <div class="verify-success-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    </div>
                    <h3 class="verify-success-title">Verified!</h3>
                    <p class="verify-success-subtitle">Connecting your call now...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Page Loader -->
    <div class="page-loader hidden" id="pageLoader">
        <div class="page-loader-waveform">
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
        </div>
    </div>
    
    <script>
    const Coachd = (function() {
        'use strict';
        
        // ==================== CONFIG ====================
        const CONFIG = {
            telnyxStartEndpoint: '/api/telnyx/start-call',
            telnyxEndEndpoint: '/api/telnyx/end-call',
            telnyxSessionEndpoint: '/api/telnyx/session',
            agenciesEndpoint: '/api/agencies',
            outcomeEndpoint: '/api/call-outcomes',
            captionFadeDelay: 4000,
            pollInterval: 2000
        };
        
        // ==================== STATE ====================
        const state = {
            sessionId: null,
            agentPhone: null,
            clientPhone: null,  // Client phone for click-to-call
            agency: null,
            // SECURITY: Validated agency from home page
            validatedAgencyCode: null,
            validatedAgencyName: null,
            callType: 'presentation',
            isInCall: false,
            seconds: 0,
            timerInterval: null,
            guidanceHistory: [],
            selectedTipIndex: null,
            callOutcome: null,
            ws: null,
            wsReconnectAttempts: 0,
            wsMaxReconnectAttempts: 5,
            wsReconnecting: false,
            agentFadeTimer: null,
            callerFadeTimer: null,
            clientFadeTimer: null,
            streamingGuidance: '',
            hasVibratedForCurrentGuidance: false,
            guidanceDismissTimer: null,  // Fallback auto-dismiss
            dismissHintTimer: null,       // Shows "tap to dismiss" after 3s
            // Transcript sidebar state
            transcriptUserScrolled: false,
            currentClientText: '',
            currentClientElement: null,
            clientContext: {
                product: 'whole_life',
                age: null,
                occupation: null,
                married: null,
                kids: null,
                kidsCount: null,
                tobacco: null,
                budget: null
            },
            // Sentiment tracking
            currentSentiment: {
                level: 'neutral',
                trajectory: 'stable',
                tip: ''
            },
            sentimentVisible: false,
            // Guidance validation
            guidanceValidated: false,
            // Phone verification
            verifyMethod: 'sms',
            verifyCountdown: 0,
            verifyCountdownInterval: null
        };
        
        // ==================== DOM ====================
        const dom = {
            get identifyScreen() { return document.getElementById('identifyScreen'); },
            get startScreen() { return document.getElementById('startScreen'); },
            get connectingScreen() { return document.getElementById('connectingScreen'); },
            get callScreen() { return document.getElementById('callScreen'); },
            get completeScreen() { return document.getElementById('completeScreen'); },
            get startBtn() { return document.getElementById('startBtn'); },
            get timer() { return document.getElementById('timer'); },
            get endSessionBtn() { return document.getElementById('endSessionBtn'); },
            get teleprompter() { return document.getElementById('teleprompter'); },
            get listeningState() { return document.getElementById('listeningState'); },
            get guidanceState() { return document.getElementById('guidanceState'); },
            get guidanceText() { return document.getElementById('guidanceText'); },
            get completeDuration() { return document.getElementById('completeDuration'); },
            get agentPhone() { return document.getElementById('agentPhone'); },
            get agencySelect() { return document.getElementById('agencySelect'); },
            get identifyError() { return document.getElementById('identifyError'); },
            get phoneDisplay() { return document.getElementById('phoneDisplay'); },
            get phoneDisplayNumber() { return document.getElementById('phoneDisplayNumber'); },
            get clientPhoneInput() { return document.getElementById('clientPhoneInput'); },
            get clientPhoneError() { return document.getElementById('clientPhoneError'); },
            get callTypeHint() { return document.getElementById('callTypeHint'); },
            get errorModal() { return document.getElementById('errorModal'); },
            get errorModalTitle() { return document.getElementById('errorModalTitle'); },
            get errorModalMessage() { return document.getElementById('errorModalMessage'); },
            // Transcript panel (new floating design)
            get transcriptPill() { return document.getElementById('transcriptPill'); },
            get transcriptPanel() { return document.getElementById('transcriptPanel'); },
            get transcriptFeed() { return document.getElementById('transcriptFeed'); },
            get transcriptEmpty() { return document.getElementById('transcriptEmpty'); },
            // Sentiment indicator
            get sentimentIndicator() { return document.getElementById('sentimentIndicator'); },
            get sentimentEmoji() { return document.getElementById('sentimentEmoji'); },
            get sentimentLabel() { return document.getElementById('sentimentLabel'); },
            get sentimentTrajectory() { return document.getElementById('sentimentTrajectory'); },
            get sentimentTip() { return document.getElementById('sentimentTip'); },
            // Verification modal
            get verifyModal() { return document.getElementById('verifyModal'); },
            get verifyCodeInput() { return document.getElementById('verifyCodeInput'); },
            get verifyConfirmBtn() { return document.getElementById('verifyConfirmBtn'); },
            get verifyError() { return document.getElementById('verifyError'); },
            get resendBtn() { return document.getElementById('resendBtn'); },
            get verifyCodeDesc() { return document.getElementById('verifyCodeDesc'); }
        };
        
        // ==================== INIT ====================
        
        // SECURITY: Check for validated agency code from home page
        function checkAgencyCode() {
            const savedAgency = localStorage.getItem('coachd_agency');
            if (!savedAgency) {
                console.log('[Security] No validated agency code - redirecting to home');
                const loader = document.getElementById('pageLoader');
                if (loader) loader.classList.remove('hidden');
                window.location.href = '/';
                return null;
            }
            try {
                const agency = JSON.parse(savedAgency);
                if (!agency.code) {
                    console.log('[Security] Invalid agency code format - redirecting to home');
                    const loader = document.getElementById('pageLoader');
                    if (loader) loader.classList.remove('hidden');
                    window.location.href = '/';
                    return null;
                }
                console.log('[Security] Validated agency code:', agency.code);
                return agency;
            } catch (e) {
                console.log('[Security] Failed to parse agency code - redirecting to home');
                localStorage.removeItem('coachd_agency');
                const loader = document.getElementById('pageLoader');
                if (loader) loader.classList.remove('hidden');
                window.location.href = '/';
                return null;
            }
        }
        
        async function init() {
            console.log(' Coachd.ai Live Call (Telnyx) - VERSION: 2025-01-11-transcript-sidebar');
            
            // SECURITY: Gate on validated agency code FIRST
            const validatedAgency = checkAgencyCode();
            if (!validatedAgency) {
                return; // Redirect is happening
            }
            
            // Store validated agency in state
            state.validatedAgencyCode = validatedAgency.code;
            state.validatedAgencyName = validatedAgency.name;
            
            await loadAgencies();
            loadClientContext();
            checkExistingIdentity();
            
            // Initialize transcript sidebar scroll tracking
            initTranscriptScroll();
            
            // Clear phone error when user starts typing
            if (dom.clientPhoneInput) {
                dom.clientPhoneInput.addEventListener('input', clearPhoneError);
            }
        }
        
        function loadClientContext() {
            const saved = sessionStorage.getItem('coachd_context');
            if (saved) {
                try {
                    const ctx = JSON.parse(saved);
                    Object.keys(ctx).forEach(key => {
                        if (ctx[key] !== null && ctx[key] !== undefined) {
                            state.clientContext[key] = ctx[key];
                        }
                    });
                    console.log('[Context] Loaded from Quick Prep:', state.clientContext);
                } catch (e) {
                    console.log('[Context] No saved context found');
                }
            }
        }
        
        async function loadAgencies() {
            try {
                const resp = await fetch(CONFIG.agenciesEndpoint);
                if (resp.ok) {
                    const data = await resp.json();
                    const agencies = data.agencies || [];
                    agencies.forEach(a => {
                        const opt = document.createElement('option');
                        opt.value = a.code;
                        opt.textContent = a.name;
                        dom.agencySelect.appendChild(opt);
                    });
                }
            } catch (e) {
                // Fallback agencies
                const fallback = [
                    { code: 'ADERHOLT', name: 'Aderholt Agency' },
                    { code: 'BROOKS', name: 'Brooks Agency' }
                ];
                fallback.forEach(a => {
                    const opt = document.createElement('option');
                    opt.value = a.code;
                    opt.textContent = a.name;
                    dom.agencySelect.appendChild(opt);
                });
            }
        }
        
        function checkExistingIdentity() {
            const saved = localStorage.getItem('coachd_agent');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    
                    // SECURITY: Only accept saved identity if it matches validated agency
                    if (data.agency !== state.validatedAgencyCode) {
                        console.log('[Security] Saved agent agency mismatch - showing identify screen');
                        localStorage.removeItem('coachd_agent');
                        prefillAgencyDropdown();
                        showScreen('identifyScreen');
                        return;
                    }
                    
                    state.agentPhone = data.phone;
                    state.agency = data.agency;
                    updatePhoneDisplay();
                    showScreen('startScreen');
                } catch (e) {
                    prefillAgencyDropdown();
                    showScreen('identifyScreen');
                }
            } else {
                prefillAgencyDropdown();
                showScreen('identifyScreen');
            }
        }
        
        // Pre-fill and lock agency dropdown to validated agency
        function prefillAgencyDropdown() {
            if (state.validatedAgencyCode && dom.agencySelect) {
                console.log('[Agency] Prefilling dropdown with:', state.validatedAgencyCode, state.validatedAgencyName);
                
                // Clear all options first
                dom.agencySelect.innerHTML = '';
                
                // Add the validated agency as the only option
                const opt = document.createElement('option');
                opt.value = state.validatedAgencyCode;
                opt.textContent = state.validatedAgencyName || state.validatedAgencyCode;
                opt.selected = true;
                dom.agencySelect.appendChild(opt);
                
                // Lock dropdown
                dom.agencySelect.disabled = true;
                dom.agencySelect.style.opacity = '0.7';
                dom.agencySelect.style.cursor = 'not-allowed';
                
                console.log('[Agency] Dropdown set to:', dom.agencySelect.value);
            } else {
                console.log('[Agency] Cannot prefill - validatedAgencyCode:', state.validatedAgencyCode, 'agencySelect:', !!dom.agencySelect);
            }
        }
        
        function formatPhoneDisplay(phone) {
            const digits = phone.replace(/\D/g, '').slice(-10);
            if (digits.length === 10) {
                return `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
            }
            return phone;
        }
        
        function updatePhoneDisplay() {
            if (state.agentPhone) {
                dom.phoneDisplayNumber.textContent = formatPhoneDisplay(state.agentPhone);
            }
        }
        
        function saveIdentity() {
            const phone = dom.agentPhone.value.trim();
            // SECURITY: Use validated agency code, not dropdown value
            const agency = state.validatedAgencyCode;
            
            // Validate phone number (at least 10 digits)
            const phoneDigits = phone.replace(/\D/g, '');
            if (!agency || phoneDigits.length < 10) {
                dom.identifyError.textContent = 'Please enter a valid phone number';
                dom.identifyError.classList.add('show');
                dom.agentPhone.classList.add('error');
                setTimeout(() => dom.agentPhone.classList.remove('error'), 500);
                return;
            }
            
            dom.identifyError.classList.remove('show');
            
            state.agentPhone = phone;
            state.agency = agency;
            
            localStorage.setItem('coachd_agent', JSON.stringify({
                phone: state.agentPhone,
                agency: state.agency
            }));
            
            updatePhoneDisplay();
            showScreen('startScreen');
        }
        
        function changeAgent() {
            localStorage.removeItem('coachd_agent');
            state.agentPhone = null;
            state.agency = null;
            dom.agentPhone.value = '';
            // Agency stays locked to validated agency
            prefillAgencyDropdown();
            showScreen('identifyScreen');
        }
        
        // ==================== CALL TYPE ====================
        function setCallType(type) {
            state.callType = type;
            document.querySelectorAll('.call-type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });
            const hints = {
                phone: 'Setting appointments (2-3 min)',
                presentation: 'Full sales presentation (30-45 min)'
            };
            dom.callTypeHint.textContent = hints[type];
        }
        
        // ==================== NOTIFICATION SOUND ====================
        let audioContext = null;
        
        // Initialize audio context on user gesture (iOS requirement)
        function warmUpAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }
        
        function playNotificationSound() {
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Soft, pleasant tone
                oscillator.frequency.value = 880; // A5 note
                oscillator.type = 'sine';
                
                // Quick fade in/out for smooth sound
                const now = audioContext.currentTime;
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(0.3, now + 0.02); // Fade in
                gainNode.gain.linearRampToValueAtTime(0, now + 0.15);   // Fade out
                
                oscillator.start(now);
                oscillator.stop(now + 0.15);
            } catch (e) {
                console.log('[Audio] Notification sound failed:', e);
            }
        }
        
        // ==================== UTILS ====================
        function formatTime(s) {
            const m = Math.floor(s / 60);
            const sec = s % 60;
            return `${m}:${sec.toString().padStart(2, '0')}`;
        }
        
        function setStatus(status) {
            // Status indicator removed - end button now in header
            // This function kept for compatibility but does nothing
            console.log('[Status]', status);
        }
        
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }
        
        function startTimer() {
            state.seconds = 0;
            state.timerInterval = setInterval(() => {
                state.seconds++;
                dom.timer.textContent = formatTime(state.seconds);
            }, 1000);
        }
        
        function stopTimer() {
            if (state.timerInterval) {
                clearInterval(state.timerInterval);
                state.timerInterval = null;
            }
        }
        
        // ==================== ERROR MODAL ====================
        function showErrorModal(title, message) {
            dom.errorModalTitle.textContent = title || 'Connection Failed';
            dom.errorModalMessage.textContent = message || 'Unable to start the call. Please try again.';
            dom.errorModal.classList.add('visible');
        }
        
        function closeErrorModal() {
            dom.errorModal.classList.remove('visible');
        }
        
        // ==================== PHONE VERIFICATION ====================
        function showVerifyModal() {
            showVerifyState('verifyStateInitial');
            dom.verifyModal.classList.add('visible');
        }
        
        function closeVerifyModal() {
            dom.verifyModal.classList.remove('visible');
            stopVerifyCountdown();
            // Reset state
            if (dom.verifyCodeInput) dom.verifyCodeInput.value = '';
            if (dom.verifyConfirmBtn) dom.verifyConfirmBtn.disabled = true;
            if (dom.verifyError) dom.verifyError.classList.remove('visible');
        }
        
        function showVerifyState(stateId) {
            document.querySelectorAll('.verify-state').forEach(s => s.classList.remove('active'));
            document.getElementById(stateId)?.classList.add('active');
        }
        
        function setVerifyMethod(method) {
            state.verifyMethod = method;
            document.querySelectorAll('.method-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.method === method);
            });
        }
        
        async function checkPhoneVerified(phone) {
            try {
                const digits = phone.replace(/\D/g, '');
                const response = await fetch(`/api/verify/check/${digits}`);
                const data = await response.json();
                return data.verified === true;
            } catch (e) {
                console.error('[Verify] Check failed:', e);
                // On error, assume not verified to be safe
                return false;
            }
        }
        
        async function sendVerifyCode() {
            showVerifyState('verifyStateSending');
            
            try {
                const response = await fetch('/api/verify/initiate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone_number: state.agentPhone,
                        method: state.verifyMethod
                    })
                });
                
                const data = await response.json();
                
                if (data.already_verified) {
                    // Already verified - proceed to call
                    showVerifyState('verifyStateSuccess');
                    setTimeout(() => {
                        closeVerifyModal();
                        proceedWithCall();
                    }, 1500);
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(data.detail || 'Failed to send code');
                }
                
                // Show code entry screen
                const methodText = state.verifyMethod === 'sms' ? 'texted' : 'called';
                if (dom.verifyCodeDesc) {
                    dom.verifyCodeDesc.textContent = `We ${methodText} a 5-digit code to your phone`;
                }
                showVerifyState('verifyStateCode');
                startVerifyCountdown();
                
                // Focus the input
                setTimeout(() => dom.verifyCodeInput?.focus(), 100);
                
            } catch (e) {
                console.error('[Verify] Send code failed:', e);
                showVerifyState('verifyStateInitial');
                showErrorModal('Verification Failed', e.message || 'Unable to send verification code. Please try again.');
                closeVerifyModal();
            }
        }
        
        function handleCodeInput(input) {
            // Strip non-digits
            input.value = input.value.replace(/\D/g, '');
            
            // Clear error on input
            if (dom.verifyError) dom.verifyError.classList.remove('visible');
            if (dom.verifyCodeInput) dom.verifyCodeInput.classList.remove('error');
            
            // Enable/disable verify button (Telnyx sends 5-digit codes)
            if (dom.verifyConfirmBtn) {
                dom.verifyConfirmBtn.disabled = input.value.length !== 5;
            }
        }
        
        async function confirmVerifyCode() {
            const code = dom.verifyCodeInput?.value?.trim();
            if (!code || code.length !== 5) return;
            
            dom.verifyConfirmBtn.disabled = true;
            
            try {
                const response = await fetch('/api/verify/confirm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone_number: state.agentPhone,
                        code: code
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || 'Invalid code');
                }
                
                // Success!
                stopVerifyCountdown();
                showVerifyState('verifyStateSuccess');
                
                // Auto-proceed to call
                setTimeout(() => {
                    closeVerifyModal();
                    proceedWithCall();
                }, 1500);
                
            } catch (e) {
                console.error('[Verify] Confirm failed:', e);
                // Show error
                if (dom.verifyError) {
                    dom.verifyError.textContent = e.message || 'Invalid code. Please try again.';
                    dom.verifyError.classList.add('visible');
                }
                if (dom.verifyCodeInput) {
                    dom.verifyCodeInput.classList.add('error');
                    dom.verifyCodeInput.select();
                }
                dom.verifyConfirmBtn.disabled = false;
            }
        }
        
        function startVerifyCountdown() {
            state.verifyCountdown = 60;
            updateResendButton();
            
            state.verifyCountdownInterval = setInterval(() => {
                state.verifyCountdown--;
                updateResendButton();
                
                if (state.verifyCountdown <= 0) {
                    stopVerifyCountdown();
                }
            }, 1000);
        }
        
        function stopVerifyCountdown() {
            if (state.verifyCountdownInterval) {
                clearInterval(state.verifyCountdownInterval);
                state.verifyCountdownInterval = null;
            }
        }
        
        function updateResendButton() {
            if (!dom.resendBtn) return;
            
            if (state.verifyCountdown > 0) {
                dom.resendBtn.disabled = true;
                dom.resendBtn.textContent = `Resend (${state.verifyCountdown}s)`;
            } else {
                dom.resendBtn.disabled = false;
                dom.resendBtn.textContent = 'Resend Code';
            }
        }
        
        async function resendCode() {
            if (state.verifyCountdown > 0) return;
            await sendVerifyCode();
        }
        
        // ==================== TELNYX CALL FLOW ====================
        
        // Helper to validate phone number
        function validatePhoneNumber(phone) {
            // Strip non-digits
            const digits = phone.replace(/\D/g, '');
            // US numbers: 10 digits, or 11 starting with 1
            return digits.length === 10 || (digits.length === 11 && digits.startsWith('1'));
        }
        
        // Helper to show phone validation error
        function showPhoneError(message) {
            const input = dom.clientPhoneInput;
            const error = dom.clientPhoneError;
            
            if (input) {
                input.classList.add('error');
                // Remove error class after animation
                setTimeout(() => input.classList.remove('error'), 500);
            }
            
            if (error) {
                error.textContent = message;
                error.classList.add('visible');
            }
        }
        
        // Helper to clear phone validation error
        function clearPhoneError() {
            const input = dom.clientPhoneInput;
            const error = dom.clientPhoneError;
            
            if (input) input.classList.remove('error');
            if (error) error.classList.remove('visible');
        }
        
        async function startCall() {
            // Warm up audio on user gesture (iOS requirement)
            warmUpAudio();
            
            // Clear any previous error
            clearPhoneError();
            
            // Get client phone - now mandatory
            const clientPhone = dom.clientPhoneInput?.value?.trim() || '';
            
            // Validate phone number
            if (!clientPhone) {
                showPhoneError('Client phone number is required');
                dom.clientPhoneInput?.focus();
                return;
            }
            
            if (!validatePhoneNumber(clientPhone)) {
                showPhoneError('Please enter a valid 10-digit phone number');
                dom.clientPhoneInput?.focus();
                return;
            }
            
            state.clientPhone = clientPhone;
            dom.startBtn.disabled = true;
            
            // Check if agent phone is verified for caller ID
            const isVerified = await checkPhoneVerified(state.agentPhone);
            
            if (!isVerified) {
                // Show verification modal
                dom.startBtn.disabled = false;
                showVerifyModal();
                return;
            }
            
            // Phone is verified, proceed with call
            proceedWithCall();
        }
        
        async function proceedWithCall() {
            dom.startBtn.disabled = true;
            
            // Reset reconnection state for new call
            state.wsReconnectAttempts = 0;
            state.wsReconnecting = false;
            
            setStatus('connecting');
            showScreen('connectingScreen');
            resetConnectionSteps();
            
            // Update connecting screen message based on mode
            const connectingTitle = document.querySelector('.connecting-title');
            const connectingSubtitle = document.querySelector('.connecting-subtitle');
            if (state.clientPhone) {
                if (connectingTitle) connectingTitle.textContent = 'Calling Your Phone...';
                if (connectingSubtitle) connectingSubtitle.textContent = 'Answer, then we\'ll dial your client';
            } else {
                if (connectingTitle) connectingTitle.textContent = 'Calling Your Phone...';
                if (connectingSubtitle) connectingSubtitle.textContent = 'Answer, then we\'ll dial your client';
            }
            
            try {
                // Call the Telnyx API - include client_phone and context for click-to-call
                const response = await fetch(CONFIG.telnyxStartEndpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        agent_phone: state.agentPhone,
                        client_phone: state.clientPhone || null,  // null triggers legacy 3-way mode
                        client_context: state.clientContext  // Quick Prep context for personalized coaching
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok || !data.success) {
                    throw new Error(data.detail || data.error || 'Failed to start call');
                }
                
                state.sessionId = data.session_id;
                console.log('[Telnyx] Call initiated, session:', state.sessionId);
                
                setStatus('ringing');
                
                // Connect WebSocket for real-time updates
                await connectWebSocket();
                
            } catch (e) {
                console.error('Start call failed:', e);
                setStatus('error');
                showScreen('startScreen');
                showErrorModal('Connection Failed', e.message || 'Unable to start the call. Please try again.');
            }
            
            dom.startBtn.disabled = false;
        }
        
        async function connectWebSocket() {
            return new Promise((resolve, reject) => {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/telnyx/session/${state.sessionId}`;
                
                console.log('[WS] Connecting to:', wsUrl);
                state.ws = new WebSocket(wsUrl);
                
                state.ws.onopen = () => {
                    console.log('[WS] Connected');
                    state.wsReconnectAttempts = 0;  // Reset on successful connect
                    state.wsReconnecting = false;
                    startKeepAlive();  // Keep mobile Safari alive
                    resolve();
                };
                
                state.ws.onclose = (event) => {
                    console.log('[WS] Disconnected, code:', event.code, 'reason:', event.reason);
                    
                    // Don't reconnect if we intentionally closed (code 1000) or no session
                    if (event.code === 1000 || !state.sessionId) {
                        handleIntentionalClose();
                        return;
                    }
                    
                    // Try to reconnect if we still have an active session
                    if (state.sessionId && state.wsReconnectAttempts < state.wsMaxReconnectAttempts) {
                        attemptReconnect();
                    } else {
                        handleIntentionalClose();
                    }
                };
                
                state.ws.onerror = (err) => {
                    console.error('[WS] Error:', err);
                    // Don't reject on error if reconnecting - let onclose handle it
                    if (!state.wsReconnecting) {
                        reject(err);
                    }
                };
                
                state.ws.onmessage = (e) => {
                    try {
                        const msg = JSON.parse(e.data);
                        handleMessage(msg);
                    } catch (err) {
                        console.error('[WS] Parse error:', err);
                    }
                };
                
                setTimeout(() => {
                    if (state.ws.readyState !== WebSocket.OPEN) {
                        reject(new Error('WebSocket timeout'));
                    }
                }, 10000);
            });
        }
        
        function handleIntentionalClose() {
            stopKeepAlive();
            
            // If we're on the connecting screen, call was rejected/ended before answering
            if (dom.connectingScreen.classList.contains('active')) {
                console.log('[WS] Call ended while connecting');
                state.sessionId = null;
                setStatus('');
                showScreen('startScreen');
            }
            // If we're in an active call, show outcome screen
            else if (state.isInCall) {
                console.log('[WS] Call ended during active session');
                endCall();
            }
        }
        
        function attemptReconnect() {
            state.wsReconnectAttempts++;
            state.wsReconnecting = true;
            
            // Show reconnecting status
            setStatus(`Reconnecting... (${state.wsReconnectAttempts}/${state.wsMaxReconnectAttempts})`);
            
            // Exponential backoff: 1s, 2s, 4s, 8s, 16s
            const delay = Math.min(1000 * Math.pow(2, state.wsReconnectAttempts - 1), 16000);
            console.log(`[WS] Reconnecting in ${delay}ms (attempt ${state.wsReconnectAttempts}/${state.wsMaxReconnectAttempts})`);
            
            setTimeout(async () => {
                if (!state.sessionId) {
                    console.log('[WS] Session cleared, aborting reconnect');
                    state.wsReconnecting = false;
                    return;
                }
                
                try {
                    await connectWebSocket();
                    console.log('[WS] Reconnected successfully');
                    setStatus('');  // Clear reconnecting message
                } catch (err) {
                    console.error('[WS] Reconnect failed:', err);
                    // onclose will handle next attempt
                }
            }, delay);
        }
        
        // Mobile Safari keepalive - ping every 15 seconds to prevent connection timeout
        let keepAliveInterval = null;
        
        function startKeepAlive() {
            stopKeepAlive();
            keepAliveInterval = setInterval(() => {
                if (state.ws && state.ws.readyState === WebSocket.OPEN) {
                    state.ws.send(JSON.stringify({ type: 'ping' }));
                }
            }, 15000);
        }
        
        function stopKeepAlive() {
            if (keepAliveInterval) {
                clearInterval(keepAliveInterval);
                keepAliveInterval = null;
            }
        }
        
        function handleMessage(msg) {
            console.log('[MSG]', msg.type);
            
            switch (msg.type) {
                case 'session_state':
                    handleSessionState(msg.data);
                    break;
                case 'status_update':
                    handleStatusUpdate(msg.data);
                    break;
                case 'session_update':
                    // Backend sends this on session changes
                    handleStatusUpdate(msg.data);
                    break;
                case 'ready':
                    // Agent connected, call is live
                    onCallConnected();
                    break;
                case 'transcript':
                    handleTranscript(msg);
                    break;
                case 'client_transcript':
                    handleClientTranscript(msg);
                    break;
                case 'agent_transcript':
                    handleAgentTranscript(msg);
                    break;
                case 'speakers_identified':
                    // Agent intro detected - roles are now locked
                    console.log(' Speakers identified:', msg.message);
                    setStatus('Coaching active');
                    break;
                case 'session_update':
                    handleSessionUpdate(msg.data || msg);
                    break;
                case 'client_connected':
                    // Click-to-call: Client answered - all connected!
                    console.log(' Client connected!');
                    updateConnectionStep('client', 'complete');
                    updateConnectionStep('ready', 'complete');
                    document.getElementById('stepClientText').textContent = 'Client connected!';
                    document.getElementById('connectingTitle').textContent = 'All Connected!';
                    document.getElementById('connectingSubtitle').textContent = 'Starting coaching...';
                    // Brief pause to show success, then transition
                    setTimeout(() => onCallConnected(), 800);
                    break;
                case 'guidance':
                    handleGuidance(msg);
                    break;
                case 'guidance_start':
                    handleGuidanceStart(msg);
                    break;
                case 'guidance_chunk':
                    handleGuidanceChunk(msg);
                    break;
                case 'guidance_complete':
                    handleGuidanceComplete(msg);
                    break;
                case 'guidance_dismiss':
                    dismissGuidance();
                    break;
                case 'sentiment_update':
                    handleSentimentUpdate(msg);
                    break;
                case 'veteran_update':
                    handleVeteranUpdate(msg);
                    break;
                case 'bridge':
                    handleBridge(msg);
                    break;
                case 'redialing':
                    // Auto-redial in progress (first attempt failed)
                    console.log(' Redialing client, attempt', msg.attempt || 2);
                    document.getElementById('connectingTitle').textContent = 'Redialing...';
                    document.getElementById('connectingSubtitle').textContent = 'Client didn\'t answer, trying again';
                    document.getElementById('stepClientText').textContent = 'Redialing...';
                    break;
                case 'client_dialing':
                    // Client is being dialed (could be initial or redial)
                    console.log(' Dialing client, attempt', msg.attempt || 1);
                    updateConnectionStep('agent', 'complete');
                    updateConnectionStep('client', 'active');
                    document.getElementById('stepAgentText').textContent = 'You\'re connected!';
                    document.getElementById('connectingTitle').textContent = 'Calling Client...';
                    document.getElementById('connectingSubtitle').textContent = msg.attempt > 1 
                        ? 'Second attempt...' 
                        : 'Waiting for them to answer';
                    break;
                case 'client_unavailable':
                    // Client couldn't be reached after 2 attempts
                    console.log(' Client unavailable after 2 attempts');
                    cancelCall();
                    showErrorModal('Client Unavailable', msg.message || 'Couldn\'t reach client after 2 attempts.');
                    break;
                case 'call_ended':
                    // Call ended by server (agent or client hung up, or timeout)
                    console.log(' Call ended by server:', msg.party || 'unknown', msg.cause || '');
                    
                    // If we're still on connecting screen, show appropriate message
                    if (dom.connectingScreen.classList.contains('active')) {
                        const cause = msg.cause || 'normal';
                        let title = 'Call Ended';
                        let message = 'The call was disconnected.';
                        
                        // Agent-side failures (user declined our call, etc)
                        if (msg.party === 'agent') {
                            if (cause === 'timeout' || cause === 'no_answer') {
                                title = 'No Answer';
                                message = 'Please answer your phone to start coaching.';
                            } else if (cause === 'rejected' || cause === 'call_rejected') {
                                title = 'Call Declined';
                                message = 'You declined the call.';
                            }
                        }
                        // Note: Client failures are handled by auto-redial + client_unavailable
                        
                        cancelCall();
                        showErrorModal(title, message);
                    } else {
                        // Normal end during active call
                        endCall(true);  // true = from server, don't call backend again
                    }
                    break;
                case 'call_hangup':
                    // Phone hung up (from Telnyx webhook)
                    console.log(' Call hangup:', msg.party, msg.cause);
                    handleCallHangup(msg);
                    break;
                case 'error':
                    console.error('Server error:', msg.message, msg.code);
                    // If we're on the connecting screen, show appropriate error
                    if (dom.connectingScreen.classList.contains('active')) {
                        const errorCode = msg.code || '';
                        let title = 'Connection Failed';
                        let message = msg.message || 'Unable to complete the call.';
                        
                        if (errorCode === 'client_dial_failed') {
                            title = 'Couldn\'t Reach Client';
                            message = 'Unable to connect to the client. Please check the number.';
                        }
                        
                        // Return to start screen and show error
                        cancelCall();
                        showErrorModal(title, message);
                    }
                    break;
            }
        }
        
        function handleSessionState(data) {
            console.log('[Session State]', data.status);
            
            if (data.status === 'in_progress') {
                // Client is connected - ready for coaching
                onCallConnected();
            } else if (data.status === 'agent_connected') {
                // Agent connected - only go to coaching if NO client phone was provided
                // (native 3-way mode where agent manually adds client)
                if (!state.clientPhone) {
                    onCallConnected();
                }
                // If client phone was provided, wait for client_connected message
            } else if (data.status === 'ended' || data.status === 'failed') {
                endCall(true);  // Server indicated call ended
            }
        }
        
        function handleStatusUpdate(data) {
            console.log('[Status Update]', data.status);
            
            if (data.status === 'in_progress') {
                // Client is connected - ready for coaching
                onCallConnected();
            } else if (data.status === 'agent_connected') {
                // Agent connected - only go to coaching if NO client phone was provided
                if (!state.clientPhone) {
                    onCallConnected();
                }
                // If client phone was provided, the client_dialing message handler
                // will update the UI, and client_connected will trigger onCallConnected
            } else if (data.status === 'client_ringing') {
                // Client is ringing - update UI
                updateConnectionStep('agent', 'complete');
                updateConnectionStep('client', 'active');
                document.getElementById('stepAgentText').textContent = 'You\'re connected!';
                document.getElementById('connectingTitle').textContent = 'Calling Client...';
                document.getElementById('connectingSubtitle').textContent = 'Waiting for them to answer';
            }
        }
        
        function updateConnectionStep(step, status) {
            const stepEl = document.getElementById('step' + step.charAt(0).toUpperCase() + step.slice(1));
            if (!stepEl) return;
            
            stepEl.classList.remove('active', 'complete');
            if (status === 'active') {
                stepEl.classList.add('active');
            } else if (status === 'complete') {
                stepEl.classList.add('complete');
                // Replace number with checkmark
                const numberEl = stepEl.querySelector('.step-number');
                if (numberEl) {
                    numberEl.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>';
                }
            }
        }
        
        function handleCallHangup(msg) {
            const party = msg.party || 'unknown';
            const cause = msg.cause || 'normal';
            
            console.log(`[Hangup] ${party} hung up: ${cause}`);
            
            // End the call - server already knows, don't call back
            endCall(true);
        }
        
        function resetConnectionSteps() {
            const steps = ['Agent', 'Client', 'Ready'];
            steps.forEach((step, index) => {
                const el = document.getElementById('step' + step);
                if (el) {
                    el.classList.remove('active', 'complete');
                    if (index === 0) el.classList.add('active');
                    // Reset number content
                    const numberEl = el.querySelector('.step-number');
                    if (numberEl) {
                        numberEl.textContent = (index + 1).toString();
                    }
                }
            });
            // Use optional chaining to prevent errors if elements don't exist
            const stepAgentText = document.getElementById('stepAgentText');
            const stepClientText = document.getElementById('stepClientText');
            const connectingTitle = document.getElementById('connectingTitle');
            const connectingSubtitle = document.getElementById('connectingSubtitle');
            if (stepAgentText) stepAgentText.textContent = 'Calling your phone...';
            if (stepClientText) stepClientText.textContent = 'Calling client...';
            if (connectingTitle) connectingTitle.textContent = 'Calling Your Phone...';
            if (connectingSubtitle) connectingSubtitle.textContent = 'Answer, then we\'ll dial your client';
        }
        
        function onCallConnected() {
            if (state.isInCall) return; // Already handled
            
            state.isInCall = true;
            state.guidanceHistory = [];
            state.selectedTipIndex = null;
            state.callOutcome = null;
            
            // Disable landscape blocker during active call
            document.body.classList.add('call-active');
            
            // Show end button in header
            if (dom.endSessionBtn) {
                dom.endSessionBtn.classList.add('show');
            }
            
            resetCaptions();
            showScreen('callScreen');
            startTimer();
            setStatus('listening');
            
            // Keep screen awake
            if ('wakeLock' in navigator) {
                navigator.wakeLock.request('screen').catch(() => {});
            }
            
            console.log('[Call] Connected and listening');
        }
        
        function cancelCall() {
            console.log('[Cancel] Canceling call, session:', state.sessionId);
            
            // Re-enable landscape blocker
            document.body.classList.remove('call-active');
            
            // Close WebSocket first
            if (state.ws) {
                state.ws.close();
                state.ws = null;
            }
            
            // Tell backend to hang up the Telnyx call
            if (state.sessionId) {
                fetch(CONFIG.telnyxEndEndpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: state.sessionId })
                }).then(resp => {
                    console.log('[Cancel] End call response:', resp.status);
                }).catch(err => {
                    console.log('[Cancel] End call error:', err);
                });
            }
            
            state.sessionId = null;
            state.isInCall = false;
            setStatus('');
            resetConnectionSteps();
            showScreen('startScreen');
        }
        
        function endCall(fromServer = false) {
            // Prevent double-cleanup
            if (!state.isInCall && !state.sessionId) return;
            
            state.isInCall = false;
            
            // Re-enable landscape blocker
            document.body.classList.remove('call-active');
            
            // Hide end button in header
            if (dom.endSessionBtn) {
                dom.endSessionBtn.classList.remove('show');
            }
            
            // Only tell backend to end call if this wasn't triggered by the server
            // (avoids circular call when server sends call_ended)
            if (state.sessionId && !fromServer) {
                fetch(CONFIG.telnyxEndEndpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: state.sessionId })
                }).catch(() => {});
            }
            
            if (state.ws) {
                state.ws.close();
                state.ws = null;
            }
            
            stopTimer();
            setStatus('');
            
            // Show session complete screen with duration
            dom.completeDuration.textContent = formatTime(state.seconds);
            showScreen('completeScreen');
            state.sessionId = null;
        }
        
        // ==================== TRANSCRIPTS ====================
        function handleTranscript(msg) {
            const text = msg.text || '';
            const isFinal = msg.is_final;
            let speaker = msg.speaker || 'agent';
            const rolesLocked = msg.roles_locked;
            
            // Before roles are locked, show everything as neutral "agent" line
            // This prevents false CLIENT labels before we know who's who
            if (!rolesLocked && speaker === 'unknown') {
                speaker = 'agent';  // Show in agent line until we identify speakers
            }
            
            updateCaption(speaker, text, !isFinal);
            
            // Only extract client info from confirmed client speech
            if (isFinal && speaker === 'caller' && text.length > 3 && rolesLocked) {
                extractClientInfo(text);
            }
        }
        
        function extractClientInfo(text) {
            let updated = false;
            
            // Age extraction
            const agePatterns = [
                /i(?:'m| am)\s*(\d{1,2})(?:\s*years?\s*old)?/i,
                /(?:^|\s)(\d{1,2})\s*years?\s*old/i,
                /age\s*(?:is\s*)?(\d{1,2})/i
            ];
            for (const pattern of agePatterns) {
                const match = text.match(pattern);
                if (match) {
                    const age = parseInt(match[1]);
                    if (age >= 18 && age <= 100 && age !== state.clientContext.age) {
                        state.clientContext.age = age;
                        updated = true;
                    }
                    break;
                }
            }
            
            // Marital status
            if (!state.clientContext.married || state.clientContext.married === 'N') {
                if (/\b(my wife|my husband|my spouse|i'm married|i am married|we're married)\b/i.test(text)) {
                    state.clientContext.married = 'Y';
                    updated = true;
                }
            }
            
            // Kids
            const kidsPatterns = [
                /(?:have|got)\s*(\d+|one|two|three|four|five|six)\s*(?:kids?|children|child)/i,
                /(\d+|one|two|three|four|five|six)\s*(?:kids?|children)/i,
                /\b(my kids|my children|our kids|our children)\b/i
            ];
            for (const pattern of kidsPatterns) {
                const match = text.match(pattern);
                if (match) {
                    state.clientContext.kids = 'Y';
                    const numWords = { one: 1, two: 2, three: 3, four: 4, five: 5, six: 6 };
                    const countMatch = match[1];
                    if (countMatch) {
                        const count = numWords[countMatch.toLowerCase()] || parseInt(countMatch);
                        if (count && count > 0 && count < 20) {
                            state.clientContext.kidsCount = count;
                        }
                    }
                    updated = true;
                    break;
                }
            }
            
            // Budget
            const budgetPatterns = [
                /(?:only|maybe|about|around|do|afford|pay|spend)\s*\$(\d+)/i,
                /\$(\d+)\s*(?:a|per)?\s*month/i,
                /(\d+)\s*(?:dollars|bucks)\s*(?:a|per)?\s*month/i,
                /budget\s*(?:is|of)?\s*\$?(\d+)/i
            ];
            for (const pattern of budgetPatterns) {
                const match = text.match(pattern);
                if (match) {
                    const budget = parseInt(match[1]);
                    if (budget >= 10 && budget <= 500 && budget !== state.clientContext.budget) {
                        state.clientContext.budget = budget;
                        updated = true;
                    }
                    break;
                }
            }
            
            if (updated) {
                sendContextUpdate();
            }
        }
        
        function sendContextUpdate() {
            if (state.ws && state.ws.readyState === WebSocket.OPEN) {
                const contextData = {
                    call_type: state.callType,
                    agency: state.agency,
                    product: state.clientContext.product,
                    age: state.clientContext.age,
                    occupation: state.clientContext.occupation,
                    family: buildFamilyString(),
                    budget: state.clientContext.budget
                };
                
                state.ws.send(JSON.stringify({
                    type: 'context',
                    data: contextData
                }));
            }
        }
        
        function buildFamilyString() {
            const parts = [];
            if (state.clientContext.married === 'Y') {
                parts.push('married');
            } else {
                parts.push('single');
            }
            if (state.clientContext.kids === 'Y') {
                if (state.clientContext.kidsCount) {
                    parts.push(`${state.clientContext.kidsCount} kids`);
                } else {
                    parts.push('has kids');
                }
            }
            return parts.join(', ') || null;
        }
        
        // ==================== CAPTIONS ====================
        function handleClientTranscript(msg) {
            const text = msg.text || '';
            const isFinal = msg.is_final;
            
            updateTranscriptSidebar('client', text, !isFinal);
            
            if (isFinal && text.length > 3) {
                extractClientInfo(text);
            }
        }
        
        function handleAgentTranscript(msg) {
            const text = msg.text || '';
            if (text) {
                updateTranscriptSidebar('agent', text, false);
            }
        }
        
        function updateTranscriptSidebar(speaker, text, isInterim) {
            if (!text) return;
            
            // Remove empty state on first message
            if (dom.transcriptEmpty) {
                dom.transcriptEmpty.remove();
            }
            
            // For interim (live typing), update current element or create new
            if (isInterim) {
                if (!state.currentClientElement) {
                    // Create new message element for live typing
                    state.currentClientElement = createTranscriptMessage('client', '');
                    dom.transcriptFeed.appendChild(state.currentClientElement);
                }
                // Update with cursor
                const textEl = state.currentClientElement.querySelector('.transcript-text');
                textEl.innerHTML = text + '<span class="cursor"></span>';
                state.currentClientText = text;
            } else {
                // Final transcript
                if (speaker === 'client' && state.currentClientElement) {
                    // Finalize the current interim element
                    const textEl = state.currentClientElement.querySelector('.transcript-text');
                    textEl.textContent = text;
                    state.currentClientElement = null;
                    state.currentClientText = '';
                } else {
                    // Create new final message (agent or new client)
                    const msgEl = createTranscriptMessage(speaker, text);
                    dom.transcriptFeed.appendChild(msgEl);
                }
            }
            
            // Auto-scroll unless user scrolled up
            if (!state.transcriptUserScrolled) {
                dom.transcriptFeed.scrollTop = dom.transcriptFeed.scrollHeight;
            }
            
            // Update scroll fade indicator
            updateScrollFade();
        }
        
        function createTranscriptMessage(speaker, text) {
            const div = document.createElement('div');
            div.className = `transcript-msg ${speaker}`;
            div.innerHTML = `
                <span class="transcript-label">${speaker.toUpperCase()}</span>
                <div class="transcript-text">${text}</div>
            `;
            return div;
        }
        
        function updateScrollFade() {
            // Updated for new floating transcript panel
            if (dom.transcriptFeed && dom.transcriptPanel) {
                const hasScroll = dom.transcriptFeed.scrollTop > 10;
                dom.transcriptPanel.classList.toggle('has-scroll', hasScroll);
            }
        }
        
        function toggleTranscript() {
            const panel = dom.transcriptPanel;
            const pill = dom.transcriptPill;
            
            if (!panel) return;
            
            const isExpanded = panel.classList.contains('expanded');
            
            if (isExpanded) {
                // Collapse - show pill, hide panel
                panel.classList.remove('expanded');
                if (pill) pill.classList.remove('hidden');
            } else {
                // Expand - hide pill, show panel
                if (pill) pill.classList.add('hidden');
                panel.classList.add('expanded');
            }
            
            // On mobile, also handle mobile-visible class
            if (window.innerWidth <= 768) {
                panel.classList.add('mobile-visible');
                if (isExpanded) {
                    panel.classList.remove('expanded');
                } else {
                    panel.classList.add('expanded');
                }
            }
        }
        
        function collapseTranscript() {
            // Auto-collapse when guidance shows
            const panel = dom.transcriptPanel;
            const pill = dom.transcriptPill;
            
            if (panel && panel.classList.contains('expanded')) {
                panel.classList.remove('expanded');
                if (pill) pill.classList.remove('hidden');
            }
        }
        
        function initTranscriptScroll() {
            if (dom.transcriptFeed) {
                // Track if user scrolls up manually
                dom.transcriptFeed.addEventListener('scroll', () => {
                    const { scrollTop, scrollHeight, clientHeight } = dom.transcriptFeed;
                    const isAtBottom = scrollTop + clientHeight >= scrollHeight - 50;
                    state.transcriptUserScrolled = !isAtBottom;
                    updateScrollFade();
                });
            }
        }
        
        // Legacy handler - route to transcript panel
        function updateCaption(speaker, text, isInterim) {
            if (speaker === 'caller' || speaker === 'client') {
                updateTranscriptSidebar('client', text, isInterim);
            } else if (speaker === 'agent') {
                updateTranscriptSidebar('agent', text, false);
            }
        }
        
        function resetCaptions() {
            // Clear transcript panel
            if (dom.transcriptFeed) {
                dom.transcriptFeed.innerHTML = '<div class="transcript-empty" id="transcriptEmpty">Waiting for conversation...</div>';
            }
            state.currentClientElement = null;
            state.currentClientText = '';
            state.transcriptUserScrolled = false;
            if (dom.transcriptPanel) {
                dom.transcriptPanel.classList.remove('has-scroll');
            }
        }
        
        // ==================== GUIDANCE ====================
        function handleBridge(msg) {
            // Show loading indicator - agents bridge naturally with their voice
            console.log('[BRIDGE] Objection detected, showing loading indicator');
            
            dom.listeningState.style.display = 'none';
            dom.teleprompter.classList.add('has-guidance');
            dom.guidanceText.innerHTML = '<div class="guidance-loading">    </div>';
            dom.guidanceState.classList.add('active');
            
            // Audio + haptic notification
            playNotificationSound();
            if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
            
            // Mark that we've already notified for this guidance
            state.hasVibratedForCurrentGuidance = true;
        }
        
        function handleGuidance(msg) {
            const text = msg.guidance || msg.text || '';
            if (!text) return;
            
            const action = msg.action || 'guide';
            
            // Extract the guidance text - Veteran Brain sends clean text now
            let displayText = text;
            
            // Clean up any SAY: prefix if present (legacy compatibility)
            if (displayText.toUpperCase().startsWith('SAY:')) {
                displayText = displayText.substring(4).trim();
            }
            // Clean up reminder prefix if present
            if (displayText.startsWith('')) {
                displayText = displayText.substring(2).trim();
            }
            // Clean up leading/trailing quotes
            displayText = displayText.replace(/^["']|["']$/g, '').trim();
            
            state.guidanceHistory.push({
                text: displayText,
                raw: text,
                action: action,
                timestamp: Date.now()
            });
            
            showGuidance(displayText, action);
            
            // Only notify if we haven't already (e.g., from bridge)
            if (!state.hasVibratedForCurrentGuidance) {
                playNotificationSound();
                // Stronger vibration for strike/exit
                if (action === 'strike' || action === 'exit') {
                    if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 100]);
                } else {
                    if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
                }
            }
            state.hasVibratedForCurrentGuidance = false;
        }
        
        function handleGuidanceStart(msg) {
            console.log('[GUIDANCE_START] Buffering - waiting for valid marker');
            
            // DON'T show UI yet - buffer until we validate it's real guidance
            // This prevents "thinking out loud" from flashing on screen
            state.streamingGuidance = '';
            state.guidanceValidated = false;  // Wait for SAY: or  marker
            state.hasVibratedForCurrentGuidance = false;
        }
        
        function handleGuidanceChunk(msg) {
            const chunk = msg.text || msg.chunk || '';
            if (!chunk) return;
            
            state.streamingGuidance += chunk;
            const buffer = state.streamingGuidance.trim();
            const bufferUpper = buffer.toUpperCase();
            
            // Early abort patterns - Claude is reasoning, not guiding
            const ABORT_PATTERNS = [
                'NO_GUIDANCE', 'NO GUIDANCE', 
                'THE CLIENT', 'BASED ON', 'LOOKING AT', 'SINCE THE', 'GIVEN THE',
                'I NOTICE', 'IT SEEMS', 'IT APPEARS', 'THIS IS', 'LET ME',
                'ANALYZING', 'CONSIDERING', 'THE AGENT'
            ];
            
            for (const pattern of ABORT_PATTERNS) {
                if (bufferUpper.startsWith(pattern) || bufferUpper === 'NO') {
                    console.log('[GUIDANCE_CHUNK] Abort - reasoning detected:', buffer.substring(0, 30));
                    state.streamingGuidance = '';
                    state.guidanceValidated = false;
                    return;
                }
            }
            
            // Valid guidance markers - Claude is giving actual guidance
            const hasValidMarker = bufferUpper.startsWith('SAY:') || buffer.startsWith('') || buffer.startsWith('"');
            
            // If we haven't validated yet, check for marker
            if (!state.guidanceValidated) {
                if (hasValidMarker) {
                    console.log('[GUIDANCE_CHUNK] Valid marker found, showing guidance');
                    state.guidanceValidated = true;
                    
                    // NOW show UI and notify
                    playNotificationSound();
                    if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
                    state.hasVibratedForCurrentGuidance = true;
                    
                    dom.listeningState.style.display = 'none';
                    dom.teleprompter.classList.add('has-guidance');
                    dom.guidanceState.classList.add('active');
                } else if (buffer.length > 25) {
                    // Buffer getting long with no valid marker - abort
                    console.log('[GUIDANCE_CHUNK] No marker after 25 chars, aborting:', buffer.substring(0, 25));
                    state.streamingGuidance = '';
                    return;
                } else {
                    // Keep buffering silently
                    return;
                }
            }
            
            // Strip marker for display
            let displayText = buffer;
            if (bufferUpper.startsWith('SAY:')) {
                displayText = buffer.substring(4).trim();
            } else if (buffer.startsWith('')) {
                displayText = buffer.substring(2).trim();
            }
            
            dom.guidanceText.innerHTML = formatGuidanceText(displayText) + '<span class="cursor"></span>';
        }
        
        function handleGuidanceComplete(msg) {
            let fullText = msg.full_text || state.streamingGuidance || '';
            const trimmed = fullText.trim();
            const trimmedUpper = trimmed.toUpperCase();
            
            // Filter out non-guidance responses
            const ABORT_PATTERNS = ['NO_GUIDANCE', 'NO GUIDANCE', 'THE CLIENT', 'BASED ON', 
                'LOOKING AT', 'SINCE THE', 'GIVEN THE', 'I NOTICE', 'THE AGENT'];
            
            for (const pattern of ABORT_PATTERNS) {
                if (trimmedUpper.startsWith(pattern) || trimmedUpper === 'NO') {
                    console.log('[GUIDANCE_COMPLETE] Filtered out reasoning');
                    dismissGuidance();
                    return;
                }
            }
            
            if (!fullText || fullText.length < 10) {
                dismissGuidance();
                return;
            }
            
            // Strip SAY: marker if present
            if (trimmedUpper.startsWith('SAY:')) {
                fullText = trimmed.substring(4).trim();
            } else if (trimmed.startsWith('')) {
                fullText = trimmed.substring(2).trim();
            }
            
            const sayThis = extractSayThis(fullText);
            
            state.guidanceHistory.push({
                text: sayThis,
                raw: fullText,
                timestamp: Date.now(),
                objection_type: msg.objection_type
            });
            
            // Final display - no cursor
            const displayText = sayThis || fullText;
            
            // Ensure UI is shown (in case buffering skipped it)
            if (!state.guidanceValidated) {
                dom.listeningState.style.display = 'none';
                dom.teleprompter.classList.add('has-guidance');
                dom.guidanceState.classList.add('active');
            }
            
            dom.guidanceText.innerHTML = formatGuidanceText(displayText);
            
            state.streamingGuidance = '';
            state.guidanceValidated = false;
            state.hasVibratedForCurrentGuidance = false;
            
            // Start fallback dismiss timer (45s) - Claude should dismiss sooner via guidance_dismiss
            clearTimeout(state.guidanceDismissTimer);
            state.guidanceDismissTimer = setTimeout(() => {
                console.log('[GUIDANCE] Fallback auto-dismiss after 45s');
                dismissGuidance();
            }, 45000);
        }
        
        function formatGuidanceText(text) {
            if (!text) return '';
            
            let formatted = text.replace(/(\$[\d,]+|\d+%|\d+,\d+)/g, '<strong>$1</strong>');
            
            const quotedMatch = formatted.match(/"([^"]+)"/);
            if (quotedMatch) {
                formatted = formatted.replace(
                    `"${quotedMatch[1]}"`, 
                    `<span class="say-this">"${quotedMatch[1]}"</span>`
                );
            }
            
            return formatted;
        }
        
        function extractSayThis(text) {
            const quotedMatch = text.match(/"([^"]+)"/);
            if (quotedMatch) return quotedMatch[1];
            
            const sayMatch = text.match(/SAY THIS[:\s]*(.+?)(?=\n|WHY|$)/is);
            if (sayMatch) return sayMatch[1].trim().replace(/^[""]|[""]$/g, '');
            
            return text
                .replace(/^[]\s*/gm, '')
                .replace(/^DETECTED:.*?\n/i, '')
                .replace(/^WHY:.*$/ims, '')
                .replace(/^SAY THIS:\s*/i, '')
                .trim() || text;
        }
        
        function showGuidance(text, action = 'guide') {
            dom.listeningState.style.display = 'none';
            dom.guidanceState.classList.remove('active', 'strike', 'exit', 'warn', 'show-hint');
            dom.teleprompter.classList.add('has-guidance');
            
            // Auto-collapse transcript when guidance shows
            collapseTranscript();
            
            // Clear any existing dismiss hint timer
            clearTimeout(state.dismissHintTimer);
            
            // Add action-specific class for styling
            if (action === 'strike') {
                dom.guidanceState.classList.add('strike');
            } else if (action === 'exit') {
                dom.guidanceState.classList.add('exit');
            } else if (action === 'warn') {
                dom.guidanceState.classList.add('warn');
            }
            
            let formattedText = text.replace(/(\$[\d,]+|\d+%|\d+,\d+)/g, '<strong>$1</strong>');
            
            const quotedMatch = formattedText.match(/"([^"]+)"/);
            if (quotedMatch) {
                formattedText = formattedText.replace(
                    `"${quotedMatch[1]}"`, 
                    `<span class="say-this">"${quotedMatch[1]}"</span>`
                );
            }
            
            dom.guidanceText.innerHTML = formattedText;
            
            requestAnimationFrame(() => {
                dom.guidanceState.classList.add('active');
            });
            
            // Show dismiss hint after 3 seconds
            state.dismissHintTimer = setTimeout(() => {
                dom.guidanceState.classList.add('show-hint');
            }, 3000);
        }
        
        function dismissGuidance() {
            // Clear fallback timer
            clearTimeout(state.guidanceDismissTimer);
            state.guidanceDismissTimer = null;
            
            // Clear dismiss hint timer
            clearTimeout(state.dismissHintTimer);
            state.dismissHintTimer = null;
            
            dom.guidanceState.classList.remove('active', 'strike', 'exit', 'warn', 'show-hint');
            dom.listeningState.style.display = 'flex';
            dom.teleprompter.classList.remove('has-guidance');
            dom.guidanceText.innerHTML = '';
            state.streamingGuidance = '';
            state.hasVibratedForCurrentGuidance = false;
        }
        
        // ==================== SENTIMENT ====================
        const SENTIMENT_CONFIG = {
            cold: { label: 'Cold', color: 'danger' },
            cooling: { label: 'Cooling', color: 'warning' },
            neutral: { label: 'Listening', color: 'neutral' },
            warming: { label: 'Engaged', color: 'accent' },
            hot: { label: 'Ready', color: 'success' }
        };
        
        const TRAJECTORY_SYMBOLS = {
            warming: '',
            cooling: '',
            stable: ''
        };
        
        function handleSentimentUpdate(msg) {
            const level = msg.level || 'neutral';
            const trajectory = msg.trajectory || 'stable';
            
            console.log('[SENTIMENT]', level, trajectory);
            
            // Update state
            state.currentSentiment = { level, trajectory };
            
            // Use the same meter update logic
            const meter = document.getElementById('tempMeter');
            const indicator = document.getElementById('tempIndicator');
            
            if (!meter || !indicator) return;
            
            // Show the meter
            meter.classList.add('visible');
            
            // Map level to position
            const positions = {
                hot: 5,
                warming: 25,
                neutral: 50,
                cooling: 75,
                cold: 95
            };
            
            const position = positions[level] ?? 50;
            indicator.style.top = `${position}%`;
            meter.setAttribute('data-level', level);
            
            // Zone labels
            if (level === 'hot') {
                meter.setAttribute('data-zone', 'close');
            } else if (level === 'cold') {
                meter.setAttribute('data-zone', 'exit');
            } else {
                meter.removeAttribute('data-zone');
            }
        }
        
        function resetSentiment() {
            state.currentSentiment = { level: 'neutral', trajectory: 'stable', tip: '' };
            state.sentimentVisible = false;
            
            // Reset temperature meter
            resetTemperatureMeter();
        }
        
        // ==================== VETERAN BRAIN HANDLER ====================
        function handleVeteranUpdate(msg) {
            const temperature = msg.temperature || 'neutral';
            const trajectory = msg.trajectory || 'stable';
            const action = msg.action || 'breathe';
            const hardExit = msg.hard_exit || false;
            const buyingSignal = msg.buying_signal || false;
            const objectionCount = msg.objection_count || 0;
            
            console.log('[VETERAN]', temperature, trajectory, action, hardExit ? 'HARD_EXIT!' : '', buyingSignal ? 'BUYING_SIGNAL!' : '');
            
            // Update state
            state.currentSentiment = { level: temperature, trajectory, action };
            
            // Get the meter elements
            const meter = document.getElementById('tempMeter');
            const indicator = document.getElementById('tempIndicator');
            
            if (!meter || !indicator) return;
            
            // Show the meter
            meter.classList.add('visible');
            
            // Map temperature to position (0% = top/close, 100% = bottom/exit)
            const positions = {
                hot: 5,       // Near top
                warming: 25,
                neutral: 50,  // Middle
                cooling: 75,
                cold: 95      // Near bottom
            };
            
            const position = positions[temperature] ?? 50;
            indicator.style.top = `${position}%`;
            
            // Set data attributes for styling
            meter.setAttribute('data-level', temperature);
            meter.removeAttribute('data-action');
            meter.removeAttribute('data-zone');
            
            // Zone labels (which end is active)
            if (temperature === 'hot' || buyingSignal) {
                meter.setAttribute('data-zone', 'close');
            } else if (temperature === 'cold' || hardExit) {
                meter.setAttribute('data-zone', 'exit');
            }
            
            // Action state for pulse animation
            if (action === 'strike' || buyingSignal) {
                meter.setAttribute('data-action', 'strike');
            } else if (action === 'exit' || hardExit) {
                meter.setAttribute('data-action', 'exit');
            }
        }
        
        function resetTemperatureMeter() {
            const meter = document.getElementById('tempMeter');
            const indicator = document.getElementById('tempIndicator');
            
            if (meter) {
                meter.classList.remove('visible');
                meter.removeAttribute('data-level');
                meter.removeAttribute('data-action');
                meter.removeAttribute('data-zone');
            }
            if (indicator) {
                indicator.style.top = '50%';
            }
        }
        
        // ==================== SESSION COMPLETE ====================
        function startNewCall() {
            console.log('[StartNewCall] Resetting for new call');
            try {
                dom.timer.textContent = '0:00';
                state.guidanceHistory = [];
                state.selectedTipIndex = null;
                state.sessionId = null;
                state.clientPhone = null;
                state.seconds = 0;
                state.isInCall = false;
                if (state.ws) {
                    state.ws.close();
                    state.ws = null;
                }
                if (dom.clientPhoneInput) dom.clientPhoneInput.value = '';
                
                // Hide end button
                if (dom.endSessionBtn) {
                    dom.endSessionBtn.classList.remove('show');
                }
                
                // Collapse transcript panel
                collapseTranscript();
                
                dismissGuidance();
                resetCaptions();
                resetSentiment();
                resetConnectionSteps();
                console.log('[StartNewCall] Showing start screen');
                showScreen('startScreen');
            } catch (err) {
                console.error('[StartNewCall] Error:', err);
                // Force show start screen even if something failed
                showScreen('startScreen');
            }
        }
        
        function goHome() {
            showPageLoader();
            setTimeout(() => {
                window.location.href = '/';
            }, 150);
        }
        
        function handleBack() {
            console.log('[HandleBack] Current state:', {
                isInCall: state.isInCall,
                connectingActive: dom.connectingScreen?.classList.contains('active'),
                completeActive: dom.completeScreen?.classList.contains('active'),
                startActive: dom.startScreen?.classList.contains('active'),
                identifyActive: dom.identifyScreen?.classList.contains('active')
            });
            try {
                if (state.isInCall) {
                    if (confirm('End this session?')) endCall();
                } else if (dom.connectingScreen?.classList.contains('active')) {
                    cancelCall();
                } else if (dom.completeScreen?.classList.contains('active')) {
                    startNewCall();
                } else if (dom.startScreen?.classList.contains('active')) {
                    goHome();
                } else if (dom.identifyScreen?.classList.contains('active')) {
                    showPageLoader();
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 150);
                } else {
                    // Fallback: go home if no known state
                    console.log('[HandleBack] Unknown state, going home');
                    goHome();
                }
            } catch (err) {
                console.error('[HandleBack] Error:', err);
                goHome();
            }
        }
        
        // ==================== PAGE LOADER ====================
        function showPageLoader() {
            const loader = document.getElementById('pageLoader');
            if (loader) loader.classList.remove('hidden');
        }
        
        function hidePageLoader() {
            const loader = document.getElementById('pageLoader');
            if (loader) loader.classList.add('hidden');
        }
        
        // Hide loader on page load
        window.addEventListener('load', () => {
            setTimeout(hidePageLoader, 300);
        });
        
        // Initialize
        init();
        
        // ==================== PUBLIC API ====================
        return {
            startCall,
            cancelCall,
            endCall,
            dismissGuidance,
            startNewCall,
            goHome,
            handleBack,
            saveIdentity,
            changeAgent,
            setCallType,
            closeErrorModal,
            toggleTranscript,
            // Verification
            setVerifyMethod,
            sendVerifyCode,
            handleCodeInput,
            confirmVerifyCode,
            resendCode,
            showVerifyState,
            closeVerifyModal,
            getState: () => state
        };
    })();
    
    function handleBack() {
        Coachd.handleBack();
    }
    </script>
</body>
</html>
