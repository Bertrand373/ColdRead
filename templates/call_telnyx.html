<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Live Call | Coachd</title>
    
        <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="icon" type="image/png" sizes="96x96" href="/static/favicon-96x96.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
    <link rel="shortcut icon" href="/static/favicon.ico">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#F5F5F7">
    
    <!-- SEO -->
    <meta name="description" content="AI-powered sales coaching for life insurance agents.">
    
    <!-- VERSION: 2025-01-16-v15-guidance-history-timestamps -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Aligned with agent.html Shop.app design system */
            --bg: #F5F5F7;
            --surface: #FFFFFF;
            --glass: rgba(255,255,255,0.65);
            --glass-strong: rgba(255,255,255,0.85);
            --glass-border: rgba(255,255,255,0.4);
            --border: rgba(0,0,0,0.06);
            --border-solid: #E5E5E5;
            --text: #1A1A1A;
            --text-secondary: #6B7280;
            --text-muted: #9CA3AF;
            --accent: #3B82F6;
            --accent-dark: #2563EB;
            --accent-soft: rgba(59,130,246,0.12);
            --success: #10B981;
            --success-soft: rgba(16, 185, 129, 0.1);
            --danger: #EF4444;
            --danger-soft: rgba(239, 68, 68, 0.1);
            --blur: blur(24px);
            --blur-strong: blur(40px);
            --shadow-glass: 0 8px 32px rgba(0,0,0,0.06);
            --radius-sm: 12px;
            --radius-md: 16px;
            --radius-lg: 24px;
            --radius-xl: 32px;
            --radius-full: 9999px;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --sidebar-width: 72px;
        }
        
        /* ========== HIDE OLD FLOATING PANELS (replaced by sidebar slide panels) ========== */
        .transcript-pill,
        .transcript-panel,
        .history-pill,
        .history-panel,
        .mobile-history-badge,
        .mobile-history-sheet,
        .history-sheet-backdrop,
        .sentiment-indicator {
            display: none !important;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            min-height: 100dvh;
            overflow: hidden;
        }
        
        /* ========== LANDSCAPE BLOCKER (PREMIUM) ========== */
        .landscape-blocker {
            display: none;
            position: fixed;
            inset: 0;
            background: linear-gradient(180deg, #FAFAFA 0%, #F5F5F5 100%);
            z-index: 99999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 24px;
            gap: 28px;
        }
        
        .landscape-blocker::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            opacity: 0.025;
            pointer-events: none;
        }

        .landscape-logo {
            height: 22px;
            opacity: 0.9;
        }

        .phone-wrapper {
            width: 160px;
            height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .phone-shadow {
            position: absolute;
            width: 40px;
            height: 10px;
            background: radial-gradient(ellipse, rgba(0,0,0,0.18) 0%, transparent 70%);
            bottom: 4px;
            border-radius: 50%;
            animation: shadowPulse 7s ease-in-out infinite;
        }
        
        @keyframes shadowPulse {
            0%, 7%, 43%, 50%, 57%, 93%, 100% {
                transform: scaleX(2);
                opacity: 0.2;
            }
            25%, 75% {
                transform: scaleX(1);
                opacity: 0.6;
            }
        }

        .phone-device {
            position: absolute;
            width: 48px;
            height: 100px;
            animation: rotatePhoneAnim 7s cubic-bezier(0.33, 1, 0.68, 1) infinite;
            filter: drop-shadow(0 10px 30px rgba(0, 0, 0, 0.2)) drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
        }
        
        @keyframes rotatePhoneAnim {
            0%, 7% { transform: rotate(90deg); }
            25%, 43% { transform: rotate(0deg); }
            50%, 57% { transform: rotate(-90deg); }
            75%, 93% { transform: rotate(0deg); }
            100% { transform: rotate(90deg); }
        }

        .phone-device svg {
            width: 100%;
            height: 100%;
        }

        .landscape-text {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .landscape-title {
            font-family: 'Outfit', sans-serif;
            font-size: 1.5rem;
            font-weight: 600;
            color: #1A1A1A;
            letter-spacing: -0.02em;
        }
        
        .landscape-subtitle {
            font-size: 0.85rem;
            color: #9CA3AF;
        }

        /* Landscape blocker - but NOT during active calls */
        @media (orientation: landscape) and (max-height: 500px) {
            body:not(.call-active) .landscape-blocker { display: flex; }
            body:not(.call-active) .app { display: none !important; }
        }
        
        .app {
            display: flex;
            flex-direction: row;
            height: 100vh;
            height: 100dvh;
            padding-top: var(--safe-top);
        }
        
        /* ========== SIDEBAR (Desktop) ========== */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--glass);
            backdrop-filter: var(--blur-strong);
            -webkit-backdrop-filter: var(--blur-strong);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 100;
        }
        
        .sidebar-logo {
            width: 40px;
            height: 40px;
            margin-bottom: 32px;
        }
        
        .sidebar-logo img {
            width: 100%;
            height: 100%;
        }
        
        .sidebar-nav {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 0 12px;
        }
        
        .sidebar-nav-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        /* Normal nav (hidden during call) */
        .sidebar-nav-normal { display: flex; flex-direction: column; gap: 8px; }
        body.in-call .sidebar-nav-normal { display: none; }
        
        /* Call nav (hidden when not in call) */
        .sidebar-nav-call { display: none; flex-direction: column; gap: 8px; }
        body.in-call .sidebar-nav-call { display: flex; }
        
        .nav-item {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            border-radius: var(--radius-sm);
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.15s;
            text-decoration: none;
            position: relative;
        }
        
        .nav-item:hover { background: rgba(255,255,255,0.5); color: var(--text); }
        .nav-item.active { background: var(--accent-soft); color: var(--accent); }
        .nav-item.danger { color: var(--danger); }
        .nav-item.danger:hover { background: var(--danger-soft); }
        .nav-item svg { width: 22px; height: 22px; }
        
        /* Tooltip */
        .nav-item::after {
            content: attr(data-tooltip);
            position: absolute;
            left: calc(100% + 12px);
            padding: 8px 12px;
            background: var(--text);
            color: white;
            font-size: 0.8rem;
            font-weight: 500;
            border-radius: 8px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.15s;
            pointer-events: none;
        }
        .nav-item:hover::after { opacity: 1; visibility: visible; }
        
        /* Badge on nav item */
        .nav-item .nav-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            background: var(--accent);
            color: white;
            border-radius: 9px;
            font-size: 0.65rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .nav-item .nav-badge.empty { display: none; }
        
        .sidebar-footer {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 0 12px;
        }
        
        /* Normal footer (hidden during call) */
        .sidebar-footer-normal { display: flex; flex-direction: column; gap: 8px; align-items: center; }
        body.in-call .sidebar-footer-normal { display: none; }
        
        /* Call footer (hidden when not in call) */
        .sidebar-footer-call { display: none; flex-direction: column; gap: 8px; align-items: center; }
        body.in-call .sidebar-footer-call { display: flex; }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent-soft);
            color: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        /* ========== MAIN AREA ========== */
        .main-area {
            flex: 1;
            margin-left: var(--sidebar-width);
            display: flex;
            flex-direction: column;
            min-height: 0;
            padding-bottom: var(--safe-bottom);
        }
        
        /* ========== HEADER (Hidden during call - floating status instead) ========== */
        .header {
            display: none;
        }
        
        /* Floating call status - sits on guidance panel */
        .floating-status {
            position: absolute;
            top: 20px;
            right: 24px;
            display: none;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.5);
            border-radius: var(--radius-full);
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            z-index: 10;
        }
        
        body.in-call .floating-status { display: flex; }
        
        .floating-status .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s ease-in-out infinite;
        }
        
        .floating-status .timer {
            font-family: 'Outfit', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text);
            min-width: 40px;
        }
        
        .logo { display: none; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .agent-badge {
            display: none;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(255,255,255,0.5);
            border-radius: var(--radius-full);
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-secondary);
            max-width: 140px;
            overflow: hidden;
        }
        
        .agent-badge.show { display: flex; }
        
        /* Hide old end session button - now in sidebar */
        .end-session-btn { display: none !important; }
        
        /* ========== MOBILE BRANDED HEADER ========== */
        .mobile-header {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 44px;
            padding: 0 20px;
            padding-top: var(--safe-top);
            z-index: 300;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
        }
        
        /* Glass treatment during calls */
        body.in-call .mobile-header {
            background: var(--glass);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border-bottom: 1px solid var(--glass-border);
        }
        
        .mobile-header-left {
            display: flex;
            align-items: center;
        }
        
        .mobile-header-logo {
            height: 20px;
            opacity: 0.9;
        }
        
        /* Hide logo during calls */
        body.in-call .mobile-header-logo {
            display: none;
        }
        
        .mobile-header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Call timer in header - only visible during calls */
        .mobile-header-timer {
            display: none;
            align-items: center;
            gap: 6px;
        }
        
        body.in-call .mobile-header-timer {
            display: flex;
        }
        
        .mobile-header-timer .status-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .mobile-header-timer .timer-text {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            font-variant-numeric: tabular-nums;
        }
        
        /* ========== MOBILE BOTTOM PILL ========== */
        .bottom-pill {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 400;
            padding: 8px 16px calc(8px + var(--safe-bottom));
        }
        
        .bottom-pill-inner {
            background: var(--glass-strong);
            backdrop-filter: var(--blur-strong);
            -webkit-backdrop-filter: var(--blur-strong);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-full);
            padding: 6px 8px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.1);
        }
        
        .bottom-pill-items {
            display: flex;
            justify-content: space-around;
        }
        
        /* Normal nav items (hidden during call) */
        .pill-nav-normal { display: contents; }
        body.in-call .pill-nav-normal { display: none; }
        
        /* Call nav items (hidden when not in call) */
        .pill-nav-call { display: none; }
        body.in-call .pill-nav-call { display: contents; }
        
        .pill-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            padding: 8px 12px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: var(--radius-md);
            text-decoration: none;
            position: relative;
        }
        
        .pill-item.active { color: var(--accent); }
        .pill-item.danger { color: var(--danger); }
        .pill-item svg { width: 20px; height: 20px; }
        .pill-item-label { font-size: 0.6rem; font-weight: 600; }
        
        .pill-item .pill-badge {
            position: absolute;
            top: 2px;
            right: 4px;
            min-width: 16px;
            height: 16px;
            padding: 0 4px;
            background: var(--accent);
            color: white;
            border-radius: 8px;
            font-size: 0.55rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .pill-item .pill-badge.empty { display: none; }
        
        /* ========== SLIDE-OUT PANEL (Desktop) ========== */
        .slide-panel {
            position: fixed;
            top: 0;
            left: var(--sidebar-width);
            width: 320px;
            height: 100vh;
            background: var(--glass-strong);
            backdrop-filter: var(--blur-strong);
            -webkit-backdrop-filter: var(--blur-strong);
            border-right: 1px solid var(--border);
            z-index: 99;
            transform: translateX(-100%);
            opacity: 0;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
        }
        
        .slide-panel.open {
            transform: translateX(0);
            opacity: 1;
        }
        
        .slide-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .slide-panel-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .panel-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
        }
        
        .panel-title {
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        .slide-panel-close {
            width: 32px;
            height: 32px;
            background: transparent;
            border: none;
            border-radius: var(--radius-full);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            transition: all 0.15s;
        }
        
        .slide-panel-close:hover {
            background: rgba(0,0,0,0.05);
            color: var(--text);
        }
        
        .slide-panel-close svg { width: 20px; height: 20px; }
        
        .slide-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }
        
        /* ========== MOBILE BOTTOM SHEET ========== */
        .bottom-sheet-backdrop {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
            z-index: 500;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .bottom-sheet-backdrop.visible {
            opacity: 1;
            pointer-events: auto;
        }
        
        .bottom-sheet {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60vh;
            background: var(--glass-strong);
            backdrop-filter: var(--blur-strong);
            -webkit-backdrop-filter: var(--blur-strong);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            border: 1px solid var(--glass-border);
            border-bottom: none;
            z-index: 600;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
        }
        
        .bottom-sheet.open {
            transform: translateY(0);
        }
        
        .sheet-handle {
            display: flex;
            justify-content: center;
            padding: 12px;
        }
        
        .sheet-handle::after {
            content: '';
            width: 40px;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
        }
        
        .bottom-sheet-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 20px 16px;
            border-bottom: 1px solid var(--border);
        }
        
        .bottom-sheet-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px 20px;
        }
        
        .agent-badge svg {
            width: 14px;
            height: 14px;
            flex-shrink: 0;
        }
        
        .agent-badge span {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--surface);
            transition: all 0.2s ease;
        }
        
        .status-indicator svg {
            width: 16px;
            height: 16px;
            color: var(--text-muted);
        }
        
        .status-indicator.listening {
            background: var(--success-soft);
        }
        
        .status-indicator.listening svg {
            color: var(--success);
        }
        
        .status-indicator.connecting {
            background: rgba(245, 158, 11, 0.1);
        }
        
        .status-indicator.connecting svg {
            color: #F59E0B;
            animation: spin 1s linear infinite;
        }
        
        .status-indicator.ringing {
            background: var(--accent-soft);
        }
        
        .status-indicator.ringing svg {
            color: var(--accent-dark);
            animation: pulse 1s ease-in-out infinite;
        }
        
        .status-indicator.error {
            background: var(--danger-soft);
        }
        
        .status-indicator.error svg {
            color: var(--danger);
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* ========== SCREENS ========== */
        .screen {
            display: none;
            flex: 1;
            flex-direction: column;
        }
        
        .screen.active { 
            display: flex;
            flex-direction: column;
        }
        
        /* ========== IDENTIFY SCREEN ========== */
        .identify-screen {
            justify-content: center;
            align-items: center;
            padding: 40px 24px;
        }
        
        .identify-screen.active {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .identify-card {
            width: 100%;
            max-width: 400px;
            /* Glass "monitor" treatment */
            background: var(--glass-strong);
            backdrop-filter: var(--blur-strong);
            -webkit-backdrop-filter: var(--blur-strong);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-glass);
            padding: 48px 40px;
        }
        
        .identify-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .identify-icon {
            width: 56px;
            height: 56px;
            background: var(--accent-soft);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }
        
        .identify-icon svg {
            width: 28px;
            height: 28px;
            color: var(--accent-dark);
        }
        
        .identify-title {
            font-family: 'Outfit', sans-serif;
            font-size: 1.5rem;
            font-weight: 600;
            letter-spacing: -0.02em;
            text-align: center;
            margin-bottom: 8px;
        }
        
        .identify-subtitle {
            font-size: 0.9rem;
            color: var(--text-muted);
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            color: var(--text);
            background: transparent;
            border: 1.5px solid var(--border);
            border-radius: 12px;
            transition: all 0.2s ease;
            min-height: 50px;
            text-align: center;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-soft);
        }
        
        .form-input::placeholder {
            color: var(--text-muted);
        }
        
        .form-input.error {
            border-color: var(--danger);
            animation: shake 0.5s ease-in-out;
        }
        
        /* Hide number spinners */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        input[type="tel"] {
            font-variant-numeric: tabular-nums;
        }
        
        .form-select {
            width: 100%;
            padding: 14px 40px 14px 16px;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            color: var(--text);
            background: transparent;
            border: 1.5px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23999' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 20px;
            min-height: 50px;
            transition: all 0.2s ease;
            text-align: center;
            text-align-last: center;
        }
        
        .form-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-soft);
        }
        
        .form-optional {
            font-size: 0.65rem;
            color: var(--text-muted);
            font-weight: 400;
            text-transform: none;
            letter-spacing: 0;
            margin-left: 4px;
        }
        
        .identify-btn {
            width: 100%;
            padding: 16px 24px;
            margin-top: 12px;
            background: var(--text);
            color: white;
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: var(--radius-full);
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12), 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        
        .identify-btn:hover:not(:disabled) { 
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .identify-btn:active:not(:disabled) { 
            transform: translateY(0);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        }
        .identify-btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .form-error {
            color: var(--danger);
            font-size: 0.75rem;
            margin-top: 8px;
            text-align: center;
            display: none;
        }
        
        .form-error.show { display: block; }
        
        /* ========== START SCREEN ========== */
        .start-screen {
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 40px 24px;
        }
        
        .start-screen.active {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        /* Glass card wrapper for start screen content */
        .start-card {
            background: var(--glass-strong);
            backdrop-filter: var(--blur-strong);
            -webkit-backdrop-filter: var(--blur-strong);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-glass);
            padding: 48px 40px;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        
        .start-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 24px;
            background: var(--accent-soft);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .start-icon svg {
            width: 40px;
            height: 40px;
            color: var(--accent);
        }
        
        .start-title {
            font-family: 'Outfit', sans-serif;
            font-size: 1.75rem;
            font-weight: 600;
            letter-spacing: -0.02em;
            margin-bottom: 6px;
        }
        
        .start-subtitle {
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin-bottom: 28px;
            line-height: 1.5;
        }
        
        /* Mode Toggle - subtle text tabs */
        .mode-toggle {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin-bottom: 32px;
            position: relative;
        }
        
        .mode-toggle-btn {
            padding: 8px 4px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
        }
        
        .mode-toggle-btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent);
            border-radius: 1px;
            transform: scaleX(0);
            transition: transform 0.2s ease;
        }
        
        .mode-toggle-btn:hover {
            color: var(--text-secondary);
        }
        
        .mode-toggle-btn.active {
            color: var(--text);
        }
        
        .mode-toggle-btn.active::after {
            transform: scaleX(1);
        }
        
        .mode-toggle-btn svg {
            width: 16px;
            height: 16px;
        }
        
        /* Power Dialer Mode Styles */
        .mode-content { width: 100%; }
        
        .dialer-contacts-section {
            width: 100%;
            margin-bottom: 24px;
            text-align: left;
        }
        
        .dialer-input-wrap {
            position: relative;
            margin-bottom: 8px;
        }
        
        .dialer-textarea {
            width: 100%;
            min-height: 100px;
            padding: 16px;
            padding-right: 56px;
            border: 1.5px solid var(--border);
            border-radius: var(--radius-md);
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            line-height: 1.6;
            resize: none;
            background: transparent;
            color: var(--text);
            transition: all 0.2s ease;
        }
        
        .dialer-textarea::placeholder {
            color: var(--text-muted);
        }
        
        .dialer-textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-soft);
        }
        
        .dialer-textarea.error {
            border-color: var(--danger);
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
            animation: shake 0.5s ease-in-out;
        }
        
        .dialer-camera-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 40px;
            height: 40px;
            background: var(--accent-soft);
            border: none;
            border-radius: var(--radius-sm);
            color: var(--accent);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Only apply hover on devices that support it */
        @media (hover: hover) {
            .dialer-camera-btn:hover {
                background: var(--accent);
                color: white;
            }
        }
        
        /* Active state for touch feedback */
        .dialer-camera-btn:active {
            background: var(--accent);
            color: white;
            transform: scale(0.95);
        }
        
        .dialer-camera-btn svg {
            width: 20px;
            height: 20px;
        }
        
        .dialer-hint {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 12px;
            text-align: left;
        }
        
        .dialer-preview {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .dialer-count {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .dialer-clear {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 0.85rem;
            cursor: pointer;
            text-decoration: underline;
        }
        
        .dialer-clear:hover {
            color: var(--text);
        }
        
        /* Power Dialer Active Screen */
        .dialer-current-contact {
            padding: 20px;
            background: var(--accent-soft);
            border-radius: var(--radius-md);
            margin-bottom: 24px;
            text-align: center;
        }
        
        .dialer-contact-name {
            font-family: 'Outfit', sans-serif;
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .dialer-contact-phone {
            font-size: 0.95rem;
            color: var(--accent);
            font-weight: 500;
        }
        
        .dialer-contact-sponsor {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 6px;
            display: none;
        }
        
        .dialer-call-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: var(--radius-full);
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 24px;
        }
        
        .dialer-call-status.waiting { background: var(--surface); color: var(--text-secondary); }
        .dialer-call-status.ringing { background: rgba(245,158,11,0.15); color: #F59E0B; }
        .dialer-call-status.connected { background: rgba(16,185,129,0.12); color: var(--success); }
        
        .dialer-status-pulse {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: dialerPulse 1.5s infinite;
        }
        
        @keyframes dialerPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        
        .dialer-script-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        .dialer-script-toggle:hover { color: var(--text); }
        .dialer-script-toggle svg { width: 16px; height: 16px; transition: transform 0.2s; }
        .dialer-script-toggle.open svg { transform: rotate(180deg); }
        
        .dialer-script-body {
            display: none;
            padding: 16px;
            background: #FFFEF5;
            border: 1px solid #FEF3C7;
            border-radius: var(--radius-sm);
            margin-bottom: 20px;
            text-align: left;
            font-size: 0.88rem;
            line-height: 1.7;
            color: var(--text-secondary);
        }
        
        .dialer-script-body.open { display: block; }
        .dialer-script-body strong { color: var(--text); }
        
        .dialer-call-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .dialer-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 20px;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .dialer-btn svg { width: 20px; height: 20px; }
        .dialer-btn-primary { background: var(--accent); color: white; }
        .dialer-btn-primary:hover { filter: brightness(0.95); }
        .dialer-btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .dialer-btn-outline { background: transparent; color: var(--text-secondary); border: 1.5px solid var(--border-solid); }
        .dialer-btn-outline:hover { background: rgba(0,0,0,0.02); }
        
        .dialer-disp-section { display: none; }
        .dialer-disp-section.active { display: block; }
        
        .dialer-disp-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 10px;
            text-align: left;
        }
        
        .dialer-disp-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .dialer-disp-btn {
            padding: 14px 12px;
            background: white;
            border: 1.5px solid var(--border-solid);
            border-radius: var(--radius-sm);
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .dialer-disp-btn:hover { border-color: var(--accent); background: var(--accent-soft); }
        .dialer-disp-btn.success { border-color: var(--success); background: rgba(16,185,129,0.12); color: var(--success); }
        
        .dialer-progress {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            background: var(--surface);
            border-radius: var(--radius-sm);
            margin-top: 24px;
        }
        
        .dialer-progress-track {
            flex: 1;
            height: 5px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .dialer-progress-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 3px;
            transition: width 0.3s;
        }
        
        .dialer-progress-text {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            min-width: 44px;
            text-align: right;
        }
        
        .dialer-end-link {
            margin-top: 14px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 0.85rem;
            cursor: pointer;
            text-decoration: underline;
        }
        
        .dialer-end-link:hover { color: var(--danger); }
        
        /* Dialer Complete Stats */
        .dialer-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 32px 0;
        }
        
        .dialer-stat-card {
            padding: 20px 16px;
            background: var(--surface);
            border-radius: var(--radius-sm);
            text-align: center;
        }
        
        .dialer-stat-value {
            font-family: 'Outfit', sans-serif;
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--accent);
        }
        
        .dialer-stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 4px;
        }
        
        /* Dialer Modal */
        .dialer-modal-bg {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(4px);
            z-index: 1100;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }
        
        .dialer-modal-bg.open { display: flex; }
        
        .dialer-modal {
            background: white;
            border-radius: var(--radius-lg);
            padding: 28px;
            width: 100%;
            max-width: 340px;
        }
        
        .dialer-modal-title {
            font-family: 'Outfit', sans-serif;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .dialer-modal input {
            width: 100%;
            padding: 14px 16px;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            border: 1.5px solid var(--border-solid);
            border-radius: var(--radius-sm);
            margin-bottom: 12px;
        }
        
        .dialer-modal input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .dialer-modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .start-phone-display {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 18px;
            background: var(--glass-strong);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-full);
            margin-bottom: 28px;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--accent);
            box-shadow: var(--shadow-glass);
        }
        
        .start-phone-display svg {
            width: 16px;
            height: 16px;
            min-width: 16px;
            flex-shrink: 0;
        }
        
        .start-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 16px 24px;
            background: var(--text);
            color: white;
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: var(--radius-full);
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12), 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        
        .start-btn:hover:not(:disabled) { transform: translateY(-2px); }
        .start-btn:active:not(:disabled) { transform: scale(0.98); }
        .start-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .start-btn svg { width: 22px; height: 22px; }
        
        .change-agent {
            margin-top: 16px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 0.85rem;
            cursor: pointer;
            text-decoration: underline;
        }
        
        .change-agent:hover { color: var(--text-secondary); }
        
        /* ========== CALL TYPE SELECTOR ========== */
        .call-type-selector {
            width: 100%;
            max-width: 280px;
            margin-bottom: 24px;
        }

        .call-type-label {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .call-type-buttons {
            display: flex;
            background: var(--surface);
            border-radius: 12px;
            padding: 4px;
            gap: 4px;
        }

        .call-type-btn {
            flex: 1;
            padding: 12px 8px;
            background: transparent;
            border: none;
            border-radius: 10px;
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .call-type-btn.active {
            background: var(--bg);
            color: var(--text);
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .call-type-btn:hover:not(.active) { color: var(--text); }

        .call-type-hint {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 8px;
            text-align: center;
        }
        
        /* ========== CLIENT PHONE INPUT ========== */
        .client-phone-section {
            width: 100%;
            margin-bottom: 24px;
        }
        
        .client-phone-section .form-label {
            display: block;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 8px;
            text-align: center;
        }
        
        .client-phone-section .form-input {
            width: 100%;
            padding: 14px 16px;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            font-variant-numeric: tabular-nums;
            color: var(--text);
            background: transparent;
            border: 1.5px solid var(--border);
            border-radius: 12px;
            transition: all 0.2s ease;
            text-align: center;
        }
        
        .client-phone-section .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-soft);
        }
        
        .client-phone-section .form-input.error {
            border-color: var(--danger);
            animation: shake 0.5s ease-in-out;
        }
        
        .client-phone-error {
            font-size: 0.75rem;
            color: var(--danger);
            margin-top: 8px;
            text-align: center;
            display: none;
        }
        
        .client-phone-error.visible {
            display: block;
        }
        
        /* Hide hint when error is showing */
        .client-phone-error.visible + .client-phone-hint {
            display: none;
        }
        
        .client-phone-hint {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 8px;
            text-align: center;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-8px); }
            40% { transform: translateX(8px); }
            60% { transform: translateX(-6px); }
            80% { transform: translateX(6px); }
        }
        
        /* ========== CONNECTING SCREEN ========== */
        .connecting-screen {
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 40px 24px;
        }
        
        .connecting-screen.active {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        /* Glass card wrapper */
        .connecting-card {
            background: var(--glass-strong);
            backdrop-filter: var(--blur-strong);
            -webkit-backdrop-filter: var(--blur-strong);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-glass);
            padding: 48px 40px;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        
        .connecting-title {
            font-family: 'Outfit', sans-serif;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text);
        }
        
        .connecting-subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 32px;
            line-height: 1.5;
        }
        
        /* Connection Steps - Premium Segmented */
        .connection-steps {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0;
            margin-bottom: 32px;
            width: 100%;
        }

        /* Segmented connector between steps */
        .step-connector {
            width: 100%;
            max-width: 280px;
            height: 20px;
            position: relative;
        }
        
        .step-connector::before {
            content: '';
            position: absolute;
            left: calc(24px - 1px);
            top: 0;
            width: 2px;
            height: 100%;
            background: var(--border);
            border-radius: 1px;
        }
        
        .step-connector .connector-fill {
            position: absolute;
            left: calc(24px - 1px);
            top: 0;
            width: 2px;
            height: 0%;
            background: var(--success);
            border-radius: 1px;
            transition: height 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .step-connector.filled .connector-fill {
            height: 100%;
        }

        .connection-step {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 0;
            position: relative;
            z-index: 1;
            width: 100%;
            max-width: 280px;
        }

        /* Step indicator - icon based */
        .step-indicator {
            width: 48px;
            height: 48px;
            min-width: 48px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.5);
            border: 1.5px solid var(--border);
            flex-shrink: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .step-indicator svg {
            width: 22px;
            height: 22px;
            color: var(--text-muted);
            transition: all 0.3s ease;
        }

        /* Waiting state */
        .connection-step.waiting .step-indicator {
            opacity: 0.5;
        }

        .connection-step.waiting .step-content {
            opacity: 0.5;
        }

        /* Active state */
        .connection-step.active .step-indicator {
            background: var(--accent-soft);
            border-color: var(--accent);
            animation: indicatorPulse 2s ease-in-out infinite;
        }

        .connection-step.active .step-indicator svg {
            color: var(--accent-dark);
        }

        /* Phone ringing animation */
        .connection-step.active[data-step="agent"] .step-indicator svg {
            animation: phoneRing 1s ease-in-out infinite;
        }

        @keyframes indicatorPulse {
            0%, 100% { 
                box-shadow: 0 0 0 0 rgba(96, 165, 250, 0.3);
            }
            50% { 
                box-shadow: 0 0 0 8px rgba(96, 165, 250, 0);
            }
        }

        @keyframes phoneRing {
            0%, 100% { transform: rotate(0deg); }
            10% { transform: rotate(-12deg); }
            20% { transform: rotate(12deg); }
            30% { transform: rotate(-10deg); }
            40% { transform: rotate(10deg); }
            50% { transform: rotate(0deg); }
        }

        /* Complete state */
        .connection-step.complete .step-indicator {
            background: var(--success-soft);
            border-color: var(--success);
        }

        .connection-step.complete .step-indicator svg {
            color: var(--success);
        }

        /* Text styling */
        .step-content {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex: 1;
        }

        .step-text {
            font-family: 'Outfit', sans-serif;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text);
            line-height: 1.3;
            transition: all 0.3s ease;
        }

        .connection-step.waiting .step-text {
            color: var(--text-muted);
        }

        .step-subtext {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-weight: 400;
            line-height: 1.3;
        }

        .connection-step.active .step-subtext {
            color: var(--accent-dark);
        }

        .connection-step.complete .step-subtext {
            color: var(--success);
        }
        
        .connecting-cancel {
            width: 100%;
            padding: 12px 24px;
            background: rgba(255,255,255,0.5);
            color: var(--text-secondary);
            font-family: 'Outfit', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .connecting-cancel:hover {
            background: rgba(255,255,255,0.8);
            color: var(--text);
        }
        
        /* ========== CALL SCREEN ========== */
        .call-screen { 
            position: relative;
            overflow: hidden;
            background: var(--bg);  /* Explicit white to prevent any rendering differences */
        }
        
        /* FLEX LAYOUT for sidebar + main content */
        .call-screen.active {
            display: flex;
            flex-direction: column;
        }
        
        .teleprompter {
            /* Flex child - fills available space */
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;  /* Start from top for scroll support */
            width: 100%;
            max-width: 100%;
            padding: 48px;
            text-align: center;
            cursor: pointer;
            transition: opacity 0.3s ease;
            box-sizing: border-box;
            /* Enable scrolling */
            min-height: 0;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            
            /* Pure white - premium doesn't need effects */
            background: var(--bg);
        }
        
        /* When guidance is shown - smart centering with scroll support */
        .teleprompter.has-guidance {
            justify-content: flex-start;
            padding: 48px;
        }
        
        .teleprompter:active { 
            /* No visual feedback needed - tap dismisses guidance */
        }
        
        .listening-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 100%;
            margin: auto 0;
        }
        
        /* Simple pulsing dot */
        .listening-dot {
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            margin-bottom: 16px;
            animation: dotPulse 2s ease-in-out infinite;
        }
        
        @keyframes dotPulse {
            0%, 100% { opacity: 0.4; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
        }
        
        .listening-text {
            font-family: 'Outfit', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }
        
        /* Remove the subtitle - just "Listening" is enough */
        .listening-hint {
            display: none;
        }
        
        /* ========== SENTIMENT INDICATOR ========== */
        .sentiment-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            margin-top: 24px;
            padding: 12px 20px;
            background: var(--surface);
            border-radius: 12px;
            min-width: 180px;
            transition: all 0.4s ease;
            opacity: 0.9;
        }
        
        .sentiment-indicator.hidden {
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
        }
        
        .sentiment-main {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sentiment-emoji {
            font-size: 1.4rem;
            transition: transform 0.3s ease;
        }
        
        .sentiment-indicator.warming .sentiment-emoji {
            animation: bounceUp 0.5s ease;
        }
        
        .sentiment-indicator.cooling .sentiment-emoji {
            animation: bounceDown 0.5s ease;
        }
        
        @keyframes bounceUp {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }
        
        @keyframes bounceDown {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(4px); }
        }
        
        .sentiment-label {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }
        
        .sentiment-trajectory {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-left: 4px;
        }
        
        .sentiment-trajectory.warming {
            color: var(--success);
        }
        
        .sentiment-trajectory.cooling {
            color: var(--danger);
        }
        
        .sentiment-tip {
            font-size: 0.75rem;
            color: var(--accent-dark);
            text-align: center;
            max-width: 200px;
            line-height: 1.4;
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .sentiment-tip.visible {
            opacity: 1;
            max-height: 50px;
            margin-top: 4px;
        }
        
        /* Sentiment level colors */
        .sentiment-indicator[data-level="hot"] {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }
        
        .sentiment-indicator[data-level="hot"] .sentiment-label {
            color: var(--success);
        }
        
        .sentiment-indicator[data-level="warming"] {
            background: rgba(96, 165, 250, 0.1);
            border: 1px solid rgba(96, 165, 250, 0.2);
        }
        
        .sentiment-indicator[data-level="warming"] .sentiment-label {
            color: var(--accent-dark);
        }
        
        .sentiment-indicator[data-level="neutral"] {
            background: var(--surface);
            border: 1px solid var(--border);
        }
        
        .sentiment-indicator[data-level="cooling"] {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.2);
        }
        
        .sentiment-indicator[data-level="cooling"] .sentiment-label {
            color: #D97706;
        }
        
        .sentiment-indicator[data-level="cold"] {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }
        
        .sentiment-indicator[data-level="cold"] .sentiment-label {
            color: var(--danger);
        }
        
        /* Hard Exit State - subtle but clear */
        .sentiment-indicator[data-hard-exit="true"] {
            background: rgba(239, 68, 68, 0.08) !important;
            border: 1px solid rgba(239, 68, 68, 0.3) !important;
        }
        
        .sentiment-indicator[data-hard-exit="true"] .sentiment-emoji {
            color: var(--danger);
            animation: subtlePulse 1.5s ease-in-out infinite;
        }
        
        .sentiment-indicator[data-hard-exit="true"] .sentiment-label {
            color: var(--danger) !important;
            font-weight: 600;
        }
        
        @keyframes subtlePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Strike (Buying Signal) State - professional urgency */
        .sentiment-indicator[data-action="strike"] {
            background: rgba(16, 185, 129, 0.08) !important;
            border: 1px solid rgba(16, 185, 129, 0.3) !important;
        }
        
        .sentiment-indicator[data-action="strike"] .sentiment-emoji {
            color: var(--success);
            animation: subtlePulse 1.2s ease-in-out infinite;
        }
        
        .sentiment-indicator[data-action="strike"] .sentiment-label {
            color: var(--success) !important;
            font-weight: 600;
        }
        
        /* Exit action styling */
        .sentiment-indicator[data-action="exit"] {
            background: rgba(239, 68, 68, 0.06) !important;
            border: 1px solid rgba(239, 68, 68, 0.25) !important;
        }
        
        .sentiment-indicator[data-action="exit"] .sentiment-emoji {
            color: var(--danger);
        }
        
        .sentiment-indicator[data-action="exit"] .sentiment-label {
            color: var(--danger) !important;
        }
        
        /* Dot indicator colors based on temperature */
        .sentiment-indicator[data-level="hot"] .sentiment-emoji {
            color: var(--success);
        }
        
        .sentiment-indicator[data-level="warming"] .sentiment-emoji {
            color: var(--accent-dark);
        }
        
        .sentiment-indicator[data-level="neutral"] .sentiment-emoji {
            color: var(--text-muted);
        }
        
        .sentiment-indicator[data-level="cooling"] .sentiment-emoji {
            color: #D97706;
        }
        
        .sentiment-indicator[data-level="cold"] .sentiment-emoji {
            color: var(--danger);
        }
        
        /* Mobile adjustments */
        @media (max-width: 768px) {
            .sentiment-indicator {
                margin-top: 20px;
                padding: 10px 16px;
                min-width: 160px;
            }
            
            .sentiment-emoji {
                font-size: 1.2rem;
            }
            
            .sentiment-label {
                font-size: 0.7rem;
            }
        }
        
        .guidance-state {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            width: 100%;
            max-width: 900px;
            padding: 16px;
            box-sizing: border-box;
            position: relative;
            /* Smart centering: margin auto centers when content is short,
               but allows natural scroll when content is tall */
            margin: auto 0;
        }
        
        .guidance-state.active { 
            display: flex;
            animation: guidanceReveal 0.35s ease-out;
        }
        
        /* Premium reveal animation - scale + blur */
        @keyframes guidanceReveal {
            0% { 
                opacity: 0; 
                transform: scale(0.98);
                filter: blur(4px);
            }
            100% { 
                opacity: 1; 
                transform: scale(1);
                filter: blur(0);
            }
        }
        
        /* STRIKE action - subtle green tint on reveal */
        .guidance-state.strike {
            animation: guidanceRevealStrike 0.35s ease-out;
        }
        
        @keyframes guidanceRevealStrike {
            0% { 
                opacity: 0; 
                transform: scale(0.98);
                filter: blur(4px);
                background: rgba(16, 185, 129, 0.1);
            }
            100% { 
                opacity: 1; 
                transform: scale(1);
                filter: blur(0);
                background: transparent;
            }
        }
        
        /* EXIT action - subtle red tint on reveal */
        .guidance-state.exit {
            animation: guidanceRevealExit 0.35s ease-out;
        }
        
        @keyframes guidanceRevealExit {
            0% { 
                opacity: 0; 
                transform: scale(0.98);
                filter: blur(4px);
                background: rgba(239, 68, 68, 0.08);
            }
            100% { 
                opacity: 1; 
                transform: scale(1);
                filter: blur(0);
                background: transparent;
            }
        }
        
        /* WARN action - subtle amber tint */
        .guidance-state.warn {
            animation: guidanceRevealWarn 0.35s ease-out;
        }
        
        @keyframes guidanceRevealWarn {
            0% { 
                opacity: 0; 
                transform: scale(0.98);
                filter: blur(4px);
                background: rgba(217, 119, 6, 0.08);
            }
            100% { 
                opacity: 1; 
                transform: scale(1);
                filter: blur(0);
                background: transparent;
            }
        }
        
        /* Dismiss hint - fades in after 3s */
        .dismiss-hint {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            
            font-size: 0.75rem;
            color: var(--text-muted);
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
        }
        
        .guidance-state.show-hint .dismiss-hint {
            opacity: 1;
        }
        
        .guidance-text {
            width: 100%;
            max-width: 100%;
            font-size: clamp(1.4rem, 3.5vw, 2.5rem);
            line-height: 1.6;
            font-weight: 500;
            color: var(--text);
            text-align: center;
            overflow-wrap: break-word;
            word-wrap: break-word;
            padding-bottom: 24px; /* Buffer for dismiss hint */
            letter-spacing: -0.01em;
        }
        
        /* Numbers and prices stay bold - no special color for quotes anymore */
        .guidance-text .say-this {
            /* Removed blue color - just inherit normal text */
            font-weight: 500;
        }
        
        .guidance-text .cursor {
            display: inline-block;
            width: 3px;
            height: 1.3em;
            background: var(--accent);
            margin-left: 3px;
            animation: blink 0.6s infinite;
            vertical-align: text-bottom;
        }
        
        @keyframes blink {
            0%, 45% { opacity: 1; }
            50%, 100% { opacity: 0; }
        }
        
        /* Bridge phrase + loading indicator */
        .bridge-text {
            color: var(--text);
        }
        
        .loading-dots {
            color: var(--accent);
            animation: loadingPulse 1.2s ease-in-out infinite;
            margin-left: 8px;
        }
        
        .guidance-loading {
            font-size: 2rem;
            color: var(--accent);
            animation: loadingPulse 1.2s ease-in-out infinite;
            letter-spacing: 8px;
        }
        
        @keyframes loadingPulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        
        .guidance-text strong { font-weight: 700; }
        
        /* ========== CALL FOOTER ========== */
        /* Footer is now hidden - end button moved to header */
        .call-footer {
            display: none;
        }
        
        /* Legacy styles kept for reference */
        .end-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 28px;
            background: var(--surface);
            color: var(--text-secondary);
            font-family: 'Outfit', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            border: 1px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .end-btn:hover {
            background: var(--danger-soft);
            border-color: var(--danger);
            color: var(--danger);
        }
        
        .end-btn svg { width: 18px; height: 18px; }
        
        /* ========== TRANSCRIPT PANEL (Floating) ========== */
        .call-content-wrapper {
            display: flex;
            flex: 1;
            min-height: 0;
            overflow: hidden;
            position: relative;
            background: var(--bg);  /* Explicit white to prevent any subtle differences */
        }
        
        /* Collapsed state - just a pill */
        .transcript-pill {
            position: absolute;
            left: 24px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 10;
            
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            
            background: var(--surface);
            border-radius: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }
        
        .transcript-pill:hover {
            background: var(--border);
        }
        
        .transcript-pill:active {
            transform: translateY(-50%) scale(0.98);
        }
        
        .transcript-pill.hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateY(-50%) translateX(-20px);
        }
        
        .transcript-pill .pill-dot {
            width: 6px;
            height: 6px;
            background: var(--success);
            border-radius: 50%;
            animation: pillPulse 2s ease-in-out infinite;
        }
        
        @keyframes pillPulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        .transcript-pill .pill-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }
        
        /* Expanded state - floating panel */
        .transcript-panel {
            position: absolute;
            left: 24px;
            top: 24px;
            bottom: 24px;
            width: 300px;
            z-index: 20;
            
            display: flex;
            flex-direction: column;
            
            /* Premium glass effect */
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            
            border-radius: 16px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.08),
                0 2px 8px rgba(0, 0, 0, 0.04);
            /* No border - shadow defines edges */
            
            overflow: hidden;
            
            /* Hidden by default */
            opacity: 0;
            pointer-events: none;
            transform: translateX(-20px);
            transition: all 0.25s ease-out;
        }
        
        .transcript-panel.expanded {
            opacity: 1;
            pointer-events: auto;
            transform: translateX(0);
        }
        
        .transcript-panel-header {
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(to bottom, 
                rgba(255,255,255,1) 0%, 
                rgba(250,250,250,1) 100%
            );
            flex-shrink: 0;
        }
        
        .transcript-panel-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .transcript-panel-header .panel-dot {
            width: 6px;
            height: 6px;
            background: var(--success);
            border-radius: 50%;
            animation: pillPulse 2s ease-in-out infinite;
        }
        
        .transcript-panel-header .panel-title {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }
        
        .transcript-panel-close {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-muted);
            transition: all 0.15s ease;
        }
        
        .transcript-panel-close:hover {
            background: var(--surface);
            color: var(--text);
        }
        
        .transcript-panel-close svg {
            width: 16px;
            height: 16px;
        }
        
        .transcript-panel-feed {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 16px;
            padding-bottom: 32px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            
            /* Hidden scrollbar - premium */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .transcript-panel-feed::-webkit-scrollbar {
            display: none;
        }
        
        /* Fade at bottom */
        .transcript-panel::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 32px;
            background: linear-gradient(to top, rgba(255,255,255,0.92), transparent);
            pointer-events: none;
            z-index: 1;
            border-radius: 0 0 16px 16px;
        }
        
        /* ========== TRANSCRIPT TIMESTAMPS ========== */
        .transcript-msg-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .transcript-time {
            font-size: 0.6rem;
            font-weight: 500;
            color: var(--text-muted);
            font-variant-numeric: tabular-nums;
            opacity: 0.7;
        }
        
        /* ========== HISTORY PILL (Right side) ========== */
        .history-pill {
            position: absolute;
            right: 56px; /* Space for temp meter */
            top: 50%;
            transform: translateY(-50%);
            z-index: 10;
            
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            
            background: var(--surface);
            border-radius: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }
        
        .history-pill:hover {
            background: var(--border);
        }
        
        .history-pill:active {
            transform: translateY(-50%) scale(0.98);
        }
        
        .history-pill.hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateY(-50%) translateX(20px);
        }
        
        .history-pill .pill-icon {
            width: 14px;
            height: 14px;
            color: var(--text-muted);
        }
        
        .history-pill .pill-count {
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--accent-dark);
            background: var(--accent-soft);
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }
        
        .history-pill .pill-count.empty {
            display: none;
        }
        
        /* ========== HISTORY PANEL (Right - Expanded) ========== */
        .history-panel {
            position: absolute;
            right: 56px; /* Space for temp meter */
            top: 24px;
            bottom: 24px;
            width: 300px;
            z-index: 20;
            
            display: flex;
            flex-direction: column;
            
            /* Premium glass effect */
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            
            border-radius: 16px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.08),
                0 2px 8px rgba(0, 0, 0, 0.04);
            
            overflow: hidden;
            
            /* Hidden by default */
            opacity: 0;
            pointer-events: none;
            transform: translateX(20px);
            transition: all 0.25s ease-out;
        }
        
        .history-panel.expanded {
            opacity: 1;
            pointer-events: auto;
            transform: translateX(0);
        }
        
        .history-panel-header {
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(to bottom, 
                rgba(255,255,255,1) 0%, 
                rgba(250,250,250,1) 100%
            );
            flex-shrink: 0;
        }
        
        .history-panel-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .history-panel-header .panel-dot {
            width: 6px;
            height: 6px;
            background: var(--accent);
            border-radius: 50%;
        }
        
        .history-panel-header .panel-title {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }
        
        .history-panel-close {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-muted);
            transition: all 0.15s ease;
        }
        
        .history-panel-close:hover {
            background: var(--surface);
            color: var(--text);
        }
        
        .history-panel-close svg {
            width: 16px;
            height: 16px;
        }
        
        .history-panel-feed {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 16px;
            padding-bottom: 32px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            
            /* Hidden scrollbar - premium */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .history-panel-feed::-webkit-scrollbar {
            display: none;
        }
        
        /* Fade at bottom */
        .history-panel::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 32px;
            background: linear-gradient(to top, rgba(255,255,255,0.95), transparent);
            pointer-events: none;
            z-index: 1;
            border-radius: 0 0 16px 16px;
        }
        
        /* ========== HISTORY ITEM ========== */
        .history-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
            animation: historyFadeIn 0.2s ease;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        @keyframes historyFadeIn {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .history-item-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .history-time {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--accent-dark);
            font-variant-numeric: tabular-nums;
        }
        
        .history-text {
            font-size: 0.85rem;
            line-height: 1.5;
            color: var(--text);
        }
        
        .history-text strong {
            font-weight: 700;
        }
        
        .history-empty {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 0.8rem;
            font-style: italic;
        }
        
        /* ========== MOBILE HISTORY BADGE ========== */
        .mobile-history-badge {
            display: none;
            position: absolute;
            right: 16px;
            bottom: 80px;
            z-index: 15;
            
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--surface);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
            
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .mobile-history-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        
        .mobile-history-badge:active {
            transform: scale(0.95);
        }
        
        .mobile-history-badge svg {
            width: 20px;
            height: 20px;
            color: var(--text-secondary);
        }
        
        .mobile-history-badge .badge-count {
            position: absolute;
            top: -4px;
            right: -4px;
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            background: var(--accent);
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .mobile-history-badge .badge-count.empty {
            display: none;
        }
        
        /* ========== MOBILE HISTORY BOTTOM SHEET ========== */
        .mobile-history-sheet {
            display: none;
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 100;
            
            background: white;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.15);
            
            max-height: 60vh;
            
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            
            flex-direction: column;
        }
        
        .mobile-history-sheet.expanded {
            transform: translateY(0);
        }
        
        .mobile-history-sheet .sheet-handle {
            width: 36px;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin: 12px auto 0;
            flex-shrink: 0;
        }
        
        .mobile-history-sheet .history-panel-header {
            padding-top: 8px;
        }
        
        .mobile-history-sheet .history-panel-feed {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 16px;
            padding-bottom: calc(32px + env(safe-area-inset-bottom, 0px));
        }
        
        /* Backdrop for mobile sheet */
        .history-sheet-backdrop {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 99;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .history-sheet-backdrop.visible {
            opacity: 1;
        }
        
        /* LEGACY - keep for compatibility but hidden */
        .transcript-sidebar {
            display: none;
        }
        
        .transcript-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--surface);
        }
        
        .transcript-header-icon {
            width: 6px;
            height: 6px;
            background: var(--success);
            border-radius: 50%;
            animation: transcriptPulse 2s ease-in-out infinite;
        }
        
        @keyframes transcriptPulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        .transcript-header-text {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }
        
        .transcript-feed {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 16px;
            padding-bottom: 32px; /* Extra space at bottom for fade */
            display: flex;
            flex-direction: column;
            gap: 16px;
            
            /* Hidden scrollbar - premium */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .transcript-feed::-webkit-scrollbar {
            display: none;
        }
        
        /* Top fade when scrolled */
        .transcript-sidebar::before {
            content: '';
            position: absolute;
            top: 53px; /* Below header (padding + content + border) */
            left: 0;
            right: 0;
            height: 32px;
            background: linear-gradient(to bottom, var(--surface), transparent);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 2;
        }
        
        .transcript-sidebar.has-scroll::before {
            opacity: 1;
        }
        
        /* Bottom fade - always visible for polish */
        .transcript-sidebar::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 32px;
            background: linear-gradient(to top, var(--surface), transparent);
            pointer-events: none;
            z-index: 1;
        }
        
        .transcript-msg {
            display: flex;
            flex-direction: column;
            gap: 4px;
            animation: msgFadeIn 0.2s ease;
        }
        
        @keyframes msgFadeIn {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .transcript-label {
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }
        
        .transcript-text {
            font-size: 0.8125rem;
            line-height: 1.5;
        }
        
        .transcript-msg.agent .transcript-text {
            color: var(--text-muted);
        }
        
        .transcript-msg.client .transcript-text {
            color: var(--text);
            font-weight: 500;
        }
        
        /* Live typing cursor */
        .transcript-text .cursor {
            display: inline-block;
            width: 2px;
            height: 0.9em;
            background: var(--accent);
            margin-left: 2px;
            animation: cursorBlink 0.8s infinite;
            vertical-align: text-bottom;
        }
        
        .transcript-empty {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 0.8rem;
            font-style: italic;
        }
        
        .call-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            min-height: 0;  /* Critical for flex shrinking */
            overflow: hidden;
            background: var(--bg);
        }
        
        /* Guidance area: teleprompter centered, temp meter absolute */
        .guidance-area {
            flex: 1;
            display: flex;
            flex-direction: row;
            min-height: 0;
            overflow: hidden;
            background: var(--bg);  /* Explicit white */
            position: relative;  /* For absolute positioned children */
        }
        
        .guidance-area .teleprompter {
            flex: 1;
            min-width: 0;
            /* True centering - no longer affected by temp meter */
        }
        
        /* ========== TEMPERATURE METER (Absolute - doesn't affect layout) ========== */
        .temp-meter {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 5;
            
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px 8px;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        
        .temp-meter.visible {
            opacity: 1;
        }
        
        /* Fade temp meter when guidance is showing - guidance is the star */
        .guidance-area.has-guidance .temp-meter {
            opacity: 0.4;
        }
        
        .temp-label {
            font-size: 0.65rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: var(--text-muted);
            transition: color 0.3s ease;
        }
        
        .temp-label.temp-top {
            color: rgba(16, 185, 129, 0.6);
        }
        
        .temp-label.temp-bottom {
            color: rgba(96, 165, 250, 0.6);
        }
        
        /* Active state labels */
        .temp-meter[data-zone="close"] .temp-label.temp-top {
            color: var(--success);
        }
        
        .temp-meter[data-zone="exit"] .temp-label.temp-bottom {
            color: var(--accent-dark);
        }
        
        .temp-track {
            position: relative;
            width: 6px;
            flex: 1;
            min-height: 120px;
            border-radius: 3px;
            /* Premium gradient: green (top) to blue (bottom) */
            background: linear-gradient(
                to bottom,
                #10B981 0%,      /* Emerald - Close */
                #34D399 20%,     /* Light green */
                #5EEAD4 40%,     /* Teal */
                #7DD3FC 60%,     /* Light blue */
                #60A5FA 80%,     /* Blue */
                #3B82F6 100%    /* Deep blue - Exit */
            );
            overflow: visible;
        }
        
        .temp-fill {
            /* Not using fill approach - using indicator instead */
            display: none;
        }
        
        .temp-indicator {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--bg);
            border: 3px solid var(--text);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: top 0.5s cubic-bezier(0.4, 0, 0.2, 1), 
                        border-color 0.3s ease,
                        box-shadow 0.3s ease;
            top: 50%; /* Default: neutral */
            margin-top: -7px; /* Center the indicator */
        }
        
        /* Indicator color based on position */
        .temp-meter[data-level="hot"] .temp-indicator {
            border-color: #10B981;
            box-shadow: 0 2px 12px rgba(16, 185, 129, 0.4);
        }
        
        .temp-meter[data-level="warming"] .temp-indicator {
            border-color: #34D399;
            box-shadow: 0 2px 10px rgba(52, 211, 153, 0.3);
        }
        
        .temp-meter[data-level="neutral"] .temp-indicator {
            border-color: #5EEAD4;
            box-shadow: 0 2px 8px rgba(94, 234, 212, 0.3);
        }
        
        .temp-meter[data-level="cooling"] .temp-indicator {
            border-color: #60A5FA;
            box-shadow: 0 2px 10px rgba(96, 165, 250, 0.3);
        }
        
        .temp-meter[data-level="cold"] .temp-indicator {
            border-color: #3B82F6;
            box-shadow: 0 2px 12px rgba(59, 130, 246, 0.4);
        }
        
        /* Critical states: subtle pulse */
        .temp-meter[data-action="strike"] .temp-indicator {
            animation: meterPulse 1.5s ease-in-out infinite;
            border-color: #10B981;
        }
        
        .temp-meter[data-action="exit"] .temp-indicator {
            animation: meterPulse 1.5s ease-in-out infinite;
            border-color: #3B82F6;
        }
        
        @keyframes meterPulse {
            0%, 100% { 
                transform: translateX(-50%) scale(1);
                opacity: 1;
            }
            50% { 
                transform: translateX(-50%) scale(1.15);
                opacity: 0.85;
            }
        }
        
        /* Mobile: meter on right edge, more compact */
        @media (max-width: 768px) {
            .temp-meter {
                right: 8px;
                padding: 12px 6px;
            }
            
            .temp-track {
                width: 5px;
                min-height: 100px;
            }
            
            .temp-indicator {
                width: 12px;
                height: 12px;
                border-width: 2px;
                margin-top: -6px;
            }
            
            .temp-label {
                font-size: 0.6rem;
            }
        }
        
        /* Footer now inside call-main */
        .call-main .call-footer {
            flex-shrink: 0;
        }
        
        /* Mobile: Floating transcript as bottom sheet */
        @media (max-width: 768px) {
            .call-content-wrapper {
                flex-direction: column;
            }
            
            /* Hide desktop transcript pill on mobile */
            .transcript-pill {
                display: none;
            }
            
            /* Hide desktop history pill on mobile */
            .history-pill {
                display: none;
            }
            
            /* Hide desktop history panel on mobile */
            .history-panel {
                display: none;
            }
            
            /* Show mobile history badge */
            .mobile-history-badge {
                display: flex;
            }
            
            /* Show mobile history sheet */
            .mobile-history-sheet {
                display: flex;
            }
            
            /* Show backdrop when needed */
            .history-sheet-backdrop {
                display: block;
                pointer-events: none;
            }
            
            .history-sheet-backdrop.visible {
                pointer-events: auto;
            }
            
            /* Mobile transcript panel - bottom sheet style */
            .transcript-panel {
                position: fixed;
                left: 16px;
                right: 16px;
                bottom: 16px;
                top: auto;
                width: auto;
                max-height: 40vh;
                
                /* Start collapsed */
                transform: translateY(calc(100% - 52px));
                opacity: 1;
                pointer-events: auto;
            }
            
            .transcript-panel.expanded {
                transform: translateY(0);
            }
            
            .transcript-panel-header {
                cursor: pointer;
            }
            
            /* Show drag handle on mobile */
            .transcript-panel-header::before {
                content: '';
                position: absolute;
                top: 8px;
                left: 50%;
                transform: translateX(-50%);
                width: 32px;
                height: 4px;
                background: var(--border);
                border-radius: 2px;
            }
            
            /* Always show panel on mobile (collapsed by default) */
            .transcript-panel.mobile-visible {
                opacity: 1;
                pointer-events: auto;
                transform: translateY(calc(100% - 52px));
            }
            
            .transcript-panel.mobile-visible.expanded {
                transform: translateY(0);
            }
            
            /* Legacy sidebar - hidden on mobile */
            .transcript-sidebar {
                display: none;
            }
            
            .call-main {
                order: 1;
                flex: 1;
                min-height: 0;
                overflow: hidden;
            }
            
            /* Teleprompter is the scroll container on mobile */
            .call-main .teleprompter {
                flex: 1;
                min-height: 0;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                padding: 32px 24px;
                padding-bottom: 100px; /* Space for transcript bar */
                justify-content: flex-start;  /* Start from top for scroll */
            }
            
            /* Smart centering on mobile - margin auto handles it */
            .call-main .teleprompter.has-guidance {
                justify-content: flex-start;
                padding: 32px 24px;
                padding-bottom: 100px;
            }
            
            /* Guidance with smart centering */
            .call-main .guidance-state {
                flex-shrink: 0;
                padding-bottom: 24px; /* Buffer for dismiss hint */
                margin: auto 0;  /* Centers when short, scrolls when tall */
            }
            
            .call-main .guidance-text {
                /* Slightly smaller on mobile for better fit */
                font-size: clamp(1.2rem, 5vw, 1.6rem);
                line-height: 1.55;
            }
            
            /* Temp meter on mobile */
            .temp-meter {
                right: 8px;
                padding: 12px 6px;
            }
        }
        
        /* ========== SESSION COMPLETE SCREEN ========== */
        .complete-screen {
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 40px 24px;
        }
        
        .complete-screen.active {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        /* Glass card wrapper */
        .complete-card {
            background: var(--glass-strong);
            backdrop-filter: var(--blur-strong);
            -webkit-backdrop-filter: var(--blur-strong);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-glass);
            padding: 48px 40px;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        
        .complete-icon {
            width: 80px;
            height: 80px;
            background: var(--success-soft);
            border: 2px solid var(--success);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
        }
        
        .complete-icon svg {
            width: 40px;
            height: 40px;
            color: var(--success);
        }
        
        .complete-title {
            font-family: 'Outfit', sans-serif;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 24px;
        }
        
        .complete-stats {
            margin-bottom: 40px;
        }
        
        .complete-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        
        .complete-stat-value {
            font-family: 'Outfit', sans-serif;
            font-size: 2rem;
            font-weight: 700;
            color: var(--text);
        }
        
        .complete-stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .complete-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
        }
        
        .complete-btn {
            padding: 16px 24px;
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            border-radius: var(--radius-full);
            cursor: pointer;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }
        
        .complete-btn:active {
            transform: scale(0.97);
        }
        
        .complete-btn.primary {
            background: var(--text);
            color: white;
            border: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12), 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        
        .complete-btn.secondary {
            background: rgba(255,255,255,0.5);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }
        
        .complete-btn.primary:hover { transform: translateY(-2px); }
        .complete-btn.primary:active { transform: scale(0.98); }
        .complete-btn.secondary:hover { background: rgba(255,255,255,0.8); }

        /* ========== ERROR MODAL ========== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            padding: 20px;
            padding-top: max(20px, env(safe-area-inset-top));
            padding-bottom: max(20px, env(safe-area-inset-bottom));
        }
        
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background: var(--glass-strong);
            backdrop-filter: var(--blur-strong);
            -webkit-backdrop-filter: var(--blur-strong);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-glass);
            padding: 28px;
            width: 100%;
            max-width: 360px;
            transform: scale(0.95);
            transition: transform 0.2s ease;
        }
        
        .modal-overlay.visible .modal {
            transform: scale(1);
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 6px;
        }
        
        .modal-icon {
            width: 36px;
            height: 36px;
            background: var(--danger-soft);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .modal-icon svg {
            width: 18px;
            height: 18px;
            color: var(--danger);
        }
        
        .modal-title {
            font-family: 'Outfit', sans-serif;
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text);
        }
        
        .modal-desc {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            margin-bottom: 16px;
            line-height: 1.5;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
        }
        
        .modal-btn {
            flex: 1;
            padding: 12px 16px;
            border-radius: var(--radius-full);
            font-family: 'Inter', sans-serif;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .modal-btn-cancel {
            background: rgba(255,255,255,0.5);
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }
        
        .modal-btn-cancel:hover {
            background: rgba(255,255,255,0.8);
            color: var(--text);
        }
        
        .modal-btn-confirm {
            background: var(--text);
            border: none;
            color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12), 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        
        .modal-btn-confirm:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .modal-btn-confirm:active {
            transform: translateY(0);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        }
        
        /* ========== VERIFICATION MODAL ========== */
        .verify-modal .modal-icon {
            background: var(--accent-soft);
        }
        
        .verify-modal .modal-icon svg {
            color: var(--accent);
        }
        
        .method-toggle {
            display: flex;
            background: var(--surface);
            border-radius: 10px;
            padding: 4px;
            margin-bottom: 16px;
        }
        
        .method-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 12px;
            background: transparent;
            border: none;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .method-btn.active {
            background: var(--bg);
            color: var(--text);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .method-btn svg {
            width: 16px;
            height: 16px;
        }
        
        .code-input-wrapper {
            margin-bottom: 16px;
        }
        
        .code-input {
            width: 100%;
            padding: 16px;
            font-family: 'Inter', sans-serif;
            font-size: 1.5rem;
            font-weight: 600;
            letter-spacing: 0.5em;
            text-align: center;
            color: var(--text);
            background: transparent;
            border: 1.5px solid var(--border);
            border-radius: 12px;
            transition: all 0.2s ease;
        }
        
        .code-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-soft);
        }
        
        .code-input::placeholder {
            letter-spacing: 0.3em;
            color: var(--text-muted);
        }
        
        .code-input.error {
            border-color: var(--danger);
            box-shadow: 0 0 0 3px var(--danger-soft);
            animation: shake 0.5s ease-in-out;
        }
        
        .resend-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            font-size: 0.8125rem;
            color: var(--text-muted);
            margin-bottom: 20px;
        }
        
        .resend-btn {
            background: none;
            border: none;
            color: var(--accent);
            font-family: 'Inter', sans-serif;
            font-size: 0.8125rem;
            font-weight: 500;
            cursor: pointer;
            padding: 0;
        }
        
        .resend-btn:disabled {
            color: var(--text-muted);
            cursor: not-allowed;
        }
        
        .verify-sending {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 24px 0;
        }
        
        .verify-waveform {
            display: flex;
            align-items: center;
            gap: 4px;
            height: 32px;
            margin-bottom: 16px;
        }
        
        .verify-waveform .bar {
            width: 5px;
            border-radius: 2.5px;
            background: var(--accent);
            animation: waveformPulse 1s ease-in-out infinite;
        }
        
        .verify-waveform .bar:nth-child(1) { height: 12px; animation-delay: 0s; }
        .verify-waveform .bar:nth-child(2) { height: 24px; animation-delay: 0.1s; }
        .verify-waveform .bar:nth-child(3) { height: 16px; animation-delay: 0.2s; }
        .verify-waveform .bar:nth-child(4) { height: 28px; animation-delay: 0.3s; }
        .verify-waveform .bar:nth-child(5) { height: 14px; animation-delay: 0.4s; }
        
        .verify-success {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
        }
        
        .verify-success-icon {
            width: 56px;
            height: 56px;
            background: var(--success-soft);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
        }
        
        .verify-success-icon svg {
            width: 28px;
            height: 28px;
            color: var(--success);
        }
        
        .verify-success-title {
            font-family: 'Outfit', sans-serif;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 4px;
        }
        
        .verify-success-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .verify-state { display: none; }
        .verify-state.active { display: block; }
        .verify-sending.active,
        .verify-success.active {
            display: flex;
        }
        
        .verify-error {
            font-size: 0.75rem;
            color: var(--danger);
            text-align: center;
            margin-bottom: 12px;
            display: none;
        }
        
        .verify-error.visible {
            display: block;
        }
        
        /* Chat styles loaded from partial */
        {% include 'partials/chat_styles.css' %}
        
        /* ========== RESPONSIVE ========== */
        @media (min-width: 768px) {
            .teleprompter { padding: 40px; }
            .identify-screen, .start-screen, .connecting-screen, .connected-screen, .complete-screen {
                max-width: none;
                margin: 0;
            }
        }
        
        /* Mobile: Hide sidebar, show bottom pill and mobile header */
        @media (max-width: 767px) {
            .sidebar { display: none; }
            .main-area { margin-left: 0; padding-top: calc(44px + var(--safe-top)); }
            .mobile-header { display: flex; }
            .bottom-pill { display: block; }
            .slide-panel { display: none; }
            .bottom-sheet { display: flex; }
            .bottom-sheet-backdrop { display: block; }
            
            /* Hide old desktop header on mobile - mobile-header handles timer */
            .header { display: none !important; }
            
            /* Add padding for bottom pill */
            .identify-screen,
            .start-screen,
            .connecting-screen,
            .connected-screen,
            .complete-screen {
                padding-bottom: 100px;
            }
            
            .call-screen {
                padding-bottom: 80px;
            }
            
            /* Cards are full-width on mobile */
            .identify-card,
            .start-card,
            .connecting-card,
            .complete-card {
                padding: 32px 24px;
                border-radius: var(--radius-lg);
            }
        }
        
        /* Desktop: Show sidebar, hide bottom pill */
        @media (min-width: 768px) {
            .sidebar { display: flex; }
            .main-area { margin-left: var(--sidebar-width); }
            .bottom-pill { display: none; }
            .slide-panel { display: flex; }
            .bottom-sheet { display: none; }
            .bottom-sheet-backdrop { display: none; }
        }
        
        /* ========== PAGE LOADER ========== */
        .page-loader {
            position: fixed;
            inset: 0;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 1;
            visibility: visible;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .page-loader.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        
        .page-loader-waveform {
            display: flex;
            align-items: center;
            gap: 4px;
            height: 32px;
        }
        
        .page-loader-waveform .bar {
            width: 5px;
            border-radius: 2.5px;
            background: var(--accent);
            animation: waveformPulse 1s ease-in-out infinite;
        }
        
        .page-loader-waveform .bar:nth-child(1) { height: 12px; animation-delay: 0s; }
        .page-loader-waveform .bar:nth-child(2) { height: 24px; animation-delay: 0.1s; }
        .page-loader-waveform .bar:nth-child(3) { height: 16px; animation-delay: 0.2s; }
        .page-loader-waveform .bar:nth-child(4) { height: 28px; animation-delay: 0.3s; }
        .page-loader-waveform .bar:nth-child(5) { height: 14px; animation-delay: 0.4s; }
        
        @keyframes waveformPulse {
            0%, 100% { transform: scaleY(1); opacity: 0.7; }
            50% { transform: scaleY(0.5); opacity: 0.4; }
        }
        
        /* ========== CONNECTED SCREEN ========== */
        .connected-screen {
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 40px 24px;
            background: var(--bg);
        }
        
        .connected-screen.active {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .connected-check {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--success-soft);
            border: 2px solid var(--success);
            margin-bottom: 24px;
            transform: scale(0);
            opacity: 0;
        }
        
        .connected-screen.active .connected-check {
            animation: connectedBounceIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
        
        .connected-check svg {
            width: 40px;
            height: 40px;
            color: var(--success);
            stroke-dasharray: 50;
            stroke-dashoffset: 50;
        }
        
        .connected-screen.active .connected-check svg {
            animation: connectedDrawCheck 0.4s ease forwards 0.3s;
        }
        
        .connected-title {
            font-family: 'Outfit', sans-serif;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
            opacity: 0;
            transform: translateY(10px);
        }
        
        .connected-screen.active .connected-title {
            animation: connectedFadeUp 0.4s ease forwards 0.2s;
        }
        
        .connected-subtitle {
            font-size: 0.9rem;
            color: var(--text-muted);
            opacity: 0;
            transform: translateY(10px);
        }
        
        .connected-screen.active .connected-subtitle {
            animation: connectedFadeUp 0.4s ease forwards 0.3s;
        }
        
        @keyframes connectedBounceIn {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes connectedDrawCheck {
            to { stroke-dashoffset: 0; }
        }
        
        @keyframes connectedFadeUp {
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <!-- Landscape Blocker -->
    <div class="landscape-blocker">
        <img src="/static/logo.png" alt="Coachd" class="landscape-logo">
        
        <div class="phone-wrapper">
            <div class="phone-shadow"></div>
            <div class="phone-device">
                <svg viewBox="0 0 48 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="titaniumFrame" x1="0" y1="0" x2="48" y2="0" gradientUnits="userSpaceOnUse">
                            <stop offset="0%" stop-color="#4A4A4C"/>
                            <stop offset="15%" stop-color="#2C2C2E"/>
                            <stop offset="50%" stop-color="#1F1F21"/>
                            <stop offset="85%" stop-color="#2C2C2E"/>
                            <stop offset="100%" stop-color="#4A4A4C"/>
                        </linearGradient>
                        <linearGradient id="frameDepth" x1="24" y1="0" x2="24" y2="100" gradientUnits="userSpaceOnUse">
                            <stop offset="0%" stop-color="#FFFFFF" stop-opacity="0.08"/>
                            <stop offset="50%" stop-color="#FFFFFF" stop-opacity="0"/>
                            <stop offset="100%" stop-color="#000000" stop-opacity="0.1"/>
                        </linearGradient>
                        <linearGradient id="edgeHighlight" x1="0" y1="50" x2="48" y2="50" gradientUnits="userSpaceOnUse">
                            <stop offset="0%" stop-color="#5A5A5C"/>
                            <stop offset="3%" stop-color="#3A3A3C"/>
                            <stop offset="97%" stop-color="#3A3A3C"/>
                            <stop offset="100%" stop-color="#5A5A5C"/>
                        </linearGradient>
                        <linearGradient id="screenOLED" x1="24" y1="3" x2="24" y2="97" gradientUnits="userSpaceOnUse">
                            <stop offset="0%" stop-color="#0A0A0A"/>
                            <stop offset="100%" stop-color="#000000"/>
                        </linearGradient>
                        <linearGradient id="glassReflectTop" x1="24" y1="3" x2="24" y2="20" gradientUnits="userSpaceOnUse">
                            <stop offset="0%" stop-color="#FFFFFF" stop-opacity="0.06"/>
                            <stop offset="100%" stop-color="#FFFFFF" stop-opacity="0"/>
                        </linearGradient>
                        <linearGradient id="glassReflectDiag" x1="5" y1="10" x2="40" y2="45" gradientUnits="userSpaceOnUse">
                            <stop offset="0%" stop-color="#FFFFFF" stop-opacity="0.04"/>
                            <stop offset="50%" stop-color="#FFFFFF" stop-opacity="0.01"/>
                            <stop offset="100%" stop-color="#FFFFFF" stop-opacity="0"/>
                        </linearGradient>
                        <linearGradient id="buttonMetal" x1="0" y1="0" x2="2" y2="0" gradientUnits="userSpaceOnUse">
                            <stop offset="0%" stop-color="#5A5A5C"/>
                            <stop offset="30%" stop-color="#3A3A3C"/>
                            <stop offset="70%" stop-color="#2A2A2C"/>
                            <stop offset="100%" stop-color="#1A1A1C"/>
                        </linearGradient>
                        <linearGradient id="islandDepth" x1="24" y1="6" x2="24" y2="13" gradientUnits="userSpaceOnUse">
                            <stop offset="0%" stop-color="#000000"/>
                            <stop offset="100%" stop-color="#0A0A0A"/>
                        </linearGradient>
                        <linearGradient id="homeIndicator" x1="14" y1="93" x2="34" y2="93" gradientUnits="userSpaceOnUse">
                            <stop offset="0%" stop-color="#3A3A3C"/>
                            <stop offset="50%" stop-color="#4A4A4C"/>
                            <stop offset="100%" stop-color="#3A3A3C"/>
                        </linearGradient>
                        <linearGradient id="antennaBand" x1="0" y1="0" x2="0" y2="4" gradientUnits="userSpaceOnUse">
                            <stop offset="0%" stop-color="#1A1A1C"/>
                            <stop offset="50%" stop-color="#252527"/>
                            <stop offset="100%" stop-color="#1A1A1C"/>
                        </linearGradient>
                    </defs>
                    <rect x="0.5" y="0.5" width="47" height="99" rx="10.5" fill="url(#titaniumFrame)"/>
                    <rect x="0.5" y="0.5" width="47" height="99" rx="10.5" fill="url(#frameDepth)"/>
                    <rect x="0.5" y="0.5" width="47" height="99" rx="10.5" fill="none" stroke="url(#edgeHighlight)" stroke-width="0.5"/>
                    <rect x="0" y="18" width="1" height="3" fill="url(#antennaBand)"/>
                    <rect x="47" y="18" width="1" height="3" fill="url(#antennaBand)"/>
                    <rect x="0" y="79" width="1" height="3" fill="url(#antennaBand)"/>
                    <rect x="47" y="79" width="1" height="3" fill="url(#antennaBand)"/>
                    <rect x="1.5" y="1.5" width="45" height="97" rx="9.5" fill="#050505"/>
                    <rect x="2.5" y="2.5" width="43" height="95" rx="8.5" fill="url(#screenOLED)"/>
                    <rect x="2.5" y="2.5" width="43" height="20" rx="8.5" fill="url(#glassReflectTop)"/>
                    <rect x="2.5" y="2.5" width="43" height="50" rx="8.5" fill="url(#glassReflectDiag)"/>
                    <rect x="13" y="6.5" width="22" height="7" rx="3.5" fill="url(#islandDepth)"/>
                    <rect x="13.5" y="7" width="21" height="6" rx="3" fill="none" stroke="#1A1A1A" stroke-width="0.5"/>
                    <circle cx="29" cy="9.5" r="2" fill="#0D0D0D"/>
                    <circle cx="29" cy="9.5" r="1.3" fill="#1A1A1A"/>
                    <circle cx="29" cy="9.5" r="0.8" fill="#0A0A0A"/>
                    <circle cx="28.5" cy="9" r="0.3" fill="#3A3A3A"/>
                    <circle cx="19" cy="9.5" r="1.2" fill="#0D0D0D"/>
                    <circle cx="22" cy="9.5" r="0.6" fill="#0D0D0D"/>
                    <rect x="46.5" y="26" width="1.5" height="13" rx="0.75" fill="url(#buttonMetal)"/>
                    <rect x="47.3" y="26.5" width="0.3" height="12" rx="0.15" fill="#5A5A5C" opacity="0.5"/>
                    <rect x="0" y="14" width="1.5" height="5" rx="0.75" fill="url(#buttonMetal)"/>
                    <rect x="0.3" y="14.5" width="0.3" height="4" rx="0.15" fill="#5A5A5C" opacity="0.5"/>
                    <rect x="0" y="23" width="1.5" height="9" rx="0.75" fill="url(#buttonMetal)"/>
                    <rect x="0.3" y="23.5" width="0.3" height="8" rx="0.15" fill="#5A5A5C" opacity="0.5"/>
                    <rect x="0" y="35" width="1.5" height="9" rx="0.75" fill="url(#buttonMetal)"/>
                    <rect x="0.3" y="35.5" width="0.3" height="8" rx="0.15" fill="#5A5A5C" opacity="0.5"/>
                    <rect x="14" y="92" width="20" height="4" rx="2" fill="url(#homeIndicator)"/>
                    <circle cx="14" cy="96.5" r="0.6" fill="#2A2A2C"/>
                    <circle cx="16" cy="96.5" r="0.6" fill="#2A2A2C"/>
                    <circle cx="18" cy="96.5" r="0.6" fill="#2A2A2C"/>
                    <rect x="21" y="95.5" width="6" height="2" rx="1" fill="#1A1A1C"/>
                    <circle cx="30" cy="96.5" r="0.6" fill="#2A2A2C"/>
                    <circle cx="32" cy="96.5" r="0.6" fill="#2A2A2C"/>
                    <circle cx="34" cy="96.5" r="0.6" fill="#2A2A2C"/>
                    <rect x="10" y="0.25" width="28" height="0.5" rx="0.25" fill="#5A5A5C" opacity="0.3"/>
                    <circle cx="10.5" cy="10.5" r="0.3" fill="#6A6A6C" opacity="0.2"/>
                    <circle cx="37.5" cy="10.5" r="0.3" fill="#6A6A6C" opacity="0.2"/>
                </svg>
            </div>
        </div>
        
        <div class="landscape-text">
            <h2 class="landscape-title">Rotate to portrait</h2>
            <p class="landscape-subtitle">For the best experience</p>
        </div>
    </div>
    
    <div class="app" id="app">
        <!-- ========== MOBILE BRANDED HEADER ========== -->
        <header class="mobile-header" id="mobileHeader">
            <div class="mobile-header-left">
                <img src="/static/logo.png" alt="Coachd" class="mobile-header-logo">
            </div>
            <div class="mobile-header-right">
                <div class="mobile-header-timer">
                    <div class="status-dot"></div>
                    <span class="timer-text" id="mobileTimer">0:00</span>
                </div>
            </div>
        </header>
        
        <!-- ========== DESKTOP SIDEBAR ========== -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-logo">
                <img src="/static/favicon.svg" alt="Coachd">
            </div>
            
            <nav class="sidebar-nav">
                <!-- Normal nav (shown when NOT in call) -->
                <div class="sidebar-nav-normal">
                    <a href="/" class="nav-item" data-tooltip="Dashboard">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
                    </a>
                    <a href="/call" class="nav-item active" data-tooltip="Live Call">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg>
                    </a>
                    <button class="nav-item" data-tooltip="Ask" onclick="Chat.open()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
                    </button>
                    <a href="#" class="nav-item" data-tooltip="Resources">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/></svg>
                    </a>
                </div>
                
                <!-- Call nav (shown DURING call) -->
                <div class="sidebar-nav-call">
                    <button class="nav-item" id="sidebarTranscriptBtn" data-tooltip="Transcript" onclick="Coachd.toggleSlidePanel('transcript')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
                        <span class="nav-badge empty" id="sidebarTranscriptBadge">0</span>
                    </button>
                    <button class="nav-item" id="sidebarHistoryBtn" data-tooltip="History" onclick="Coachd.toggleSlidePanel('history')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                        <span class="nav-badge empty" id="sidebarHistoryBadge">0</span>
                    </button>
                </div>
            </nav>
            
            <div class="sidebar-footer">
                <!-- Normal footer (shown when NOT in call) -->
                <div class="sidebar-footer-normal">
                    <a href="#" class="nav-item" data-tooltip="Settings">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
                    </a>
                    <div class="user-avatar" id="userAvatar">A</div>
                </div>
                
                <!-- Call footer (shown DURING call) -->
                <div class="sidebar-footer-call">
                    <button class="nav-item danger" data-tooltip="End Call" onclick="Coachd.endCall()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.68 13.31a16 16 0 003.41 2.6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7 2 2 0 011.72 2v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 002.59 3.4z"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
                    </button>
                </div>
            </div>
        </aside>
        
        <!-- ========== SLIDE-OUT PANELS (Desktop) ========== -->
        <div class="slide-panel" id="transcriptSlidePanel">
            <div class="slide-panel-header">
                <div class="slide-panel-header-left">
                    <div class="panel-dot"></div>
                    <span class="panel-title">Live Transcript</span>
                </div>
                <button class="slide-panel-close" onclick="Coachd.toggleSlidePanel('transcript')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="slide-panel-content transcript-panel-feed" id="transcriptFeed">
                <div class="transcript-empty" id="transcriptEmpty">Waiting for conversation...</div>
            </div>
        </div>
        
        <div class="slide-panel" id="historySlidePanel">
            <div class="slide-panel-header">
                <div class="slide-panel-header-left">
                    <div class="panel-dot"></div>
                    <span class="panel-title">Guidance History</span>
                </div>
                <button class="slide-panel-close" onclick="Coachd.toggleSlidePanel('history')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="slide-panel-content history-panel-feed" id="historyFeed">
                <div class="history-empty" id="historyEmpty">No guidance yet</div>
            </div>
        </div>
        
        <!-- ========== MAIN AREA ========== -->
        <div class="main-area">
        
            <!-- Identify Screen -->
            <div class="screen identify-screen active" id="identifyScreen">
                <div class="identify-card">
                    <div class="identify-header">
                        <h1 class="identify-title">Agent Setup</h1>
                    <p class="identify-subtitle">One-time setup to get started</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Your Phone Number</label>
                    <input type="tel" class="form-input" id="agentPhone" placeholder="(404) 555-1234" autocomplete="tel">
                    <div class="form-error" id="identifyError">Please enter a valid phone number</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Agency</label>
                    <select class="form-select" id="agencySelect">
                        <option value="">Select your agency...</option>
                    </select>
                </div>
                
                <button class="identify-btn" onclick="Coachd.saveIdentity()">Continue</button>
            </div>
        </div>
        
        <!-- Start Screen -->
        <div class="screen start-screen" id="startScreen">
            <div class="start-card">
                <!-- Mode Toggle -->
                <div class="mode-toggle">
                    <button class="mode-toggle-btn active" data-mode="presentation" onclick="Coachd.switchMode('presentation')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
                        Presentation
                    </button>
                    <button class="mode-toggle-btn" data-mode="dialer" onclick="Coachd.switchMode('dialer')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="4" width="4" height="4" rx="1"/><rect x="10" y="4" width="4" height="4" rx="1"/><rect x="16" y="4" width="4" height="4" rx="1"/><rect x="4" y="10" width="4" height="4" rx="1"/><rect x="10" y="10" width="4" height="4" rx="1"/><rect x="16" y="10" width="4" height="4" rx="1"/><rect x="4" y="16" width="4" height="4" rx="1"/><rect x="10" y="16" width="4" height="4" rx="1"/><rect x="16" y="16" width="4" height="4" rx="1"/></svg>
                        Power Dialer
                    </button>
                </div>
                
                <!-- PRESENTATION MODE CONTENT -->
                <div class="mode-content" id="presentationMode">
                    <h1 class="start-title">Ready to close?</h1>
                    <p class="start-subtitle">Your coach is on standby</p>
                    
                    <div class="start-phone-display" id="phoneDisplay">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                        </svg>
                        <span id="phoneDisplayNumber">(404) 555-1234</span>
                    </div>
                    
                    <!-- Client Phone Input for Click-to-Call -->
                    <div class="client-phone-section">
                        <label class="form-label">CLIENT PHONE NUMBER</label>
                        <input type="tel" 
                               id="clientPhoneInput" 
                               class="form-input"
                               placeholder="(555) 123-4567"
                               autocomplete="tel">
                        <p class="client-phone-error" id="clientPhoneError">Please enter a valid phone number</p>
                        <div class="client-phone-hint">We'll dial your client after you answer</div>
                    </div>
                    
                    <button class="start-btn" id="startBtn" onclick="Coachd.startCall()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                        </svg>
                        Start Coaching
                    </button>
                    <button class="change-agent" onclick="Coachd.changeAgent()">Not you? Change settings</button>
                </div>
                
                <!-- POWER DIALER MODE CONTENT -->
                <div class="mode-content" id="dialerMode" style="display:none">
                    <h1 class="start-title">Power Dialer</h1>
                    <p class="start-subtitle">Book appointments fast</p>
                    
                    <div class="start-phone-display">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg>
                        <span id="dialerPhoneDisplay">(404) 422-1729</span>
                    </div>
                    
                    <div class="dialer-contacts-section">
                        <label class="form-label">CONTACTS</label>
                        <div class="dialer-input-wrap">
                            <textarea class="dialer-textarea" id="dialerContactsInput" placeholder="John Smith (678) 555-1234&#10;Maria Garcia 404-555-5678" oninput="Coachd.parseDialerContacts()"></textarea>
                            <button class="dialer-camera-btn" onclick="document.getElementById('dialerImageInput').click()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>
                            </button>
                            <input type="file" id="dialerImageInput" accept="image/*" capture="environment" style="display:none" onchange="Coachd.dialerPhoto(event)">
                        </div>
                        <div class="dialer-hint">Name and phone number, one per line</div>
                        <div class="dialer-preview" id="dialerPreview">
                            <span class="dialer-count" id="dialerCount"> 0 contacts</span>
                            <button class="dialer-clear" onclick="Coachd.clearDialerContacts()">Clear</button>
                        </div>
                    </div>
                    
                    <button class="start-btn" id="dialerStartBtn" onclick="Coachd.dialerStart()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                        Start Dialing
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Power Dialer Active Screen -->
        <div class="screen dialer-active-screen" id="dialerActiveScreen">
            <div class="start-card">
                <div class="dialer-current-contact">
                    <div class="dialer-contact-name" id="dialerContactName">Maria Garcia</div>
                    <div class="dialer-contact-phone" id="dialerContactPhone">(404) 555-5678</div>
                    <div class="dialer-contact-sponsor" id="dialerContactSponsor"></div>
                </div>
                
                <div class="dialer-call-status waiting" id="dialerCallStatus">
                    <span class="dialer-status-pulse"></span>
                    <span id="dialerStatusText">Ready</span>
                </div>
                
                <div class="dialer-script-toggle" id="dialerScriptToggle" onclick="Coachd.dialerToggleScript()">
                    <span>View script</span>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="dialer-script-body" id="dialerScriptBody"></div>
                
                <div class="dialer-call-actions" id="dialerCallActions">
                    <button class="dialer-btn dialer-btn-primary" id="dialerDialBtn" onclick="Coachd.dialerDial()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg>
                        Dial
                    </button>
                    <button class="dialer-btn dialer-btn-outline" onclick="Coachd.dialerSkip()">Skip</button>
                </div>
                
                <div class="dialer-disp-section" id="dialerDispSection">
                    <div class="dialer-disp-label">Outcome</div>
                    <div class="dialer-disp-grid">
                        <button class="dialer-disp-btn success" onclick="Coachd.dialerDisp('appointment')"> Appointment</button>
                        <button class="dialer-disp-btn" onclick="Coachd.dialerDisp('callback')"> Callback</button>
                        <button class="dialer-disp-btn" onclick="Coachd.dialerDisp('no_answer')"> No Answer</button>
                        <button class="dialer-disp-btn" onclick="Coachd.dialerDisp('not_interested')"> Not Interested</button>
                    </div>
                </div>
                
                <div class="dialer-progress">
                    <div class="dialer-progress-track"><div class="dialer-progress-fill" id="dialerProgressFill"></div></div>
                    <div class="dialer-progress-text" id="dialerProgressText">0/0</div>
                </div>
                
                <button class="dialer-end-link" onclick="Coachd.dialerEnd()">End session</button>
            </div>
        </div>
        
        <!-- Power Dialer Complete Screen -->
        <div class="screen dialer-complete-screen" id="dialerCompleteScreen">
            <div class="start-card">
                <h1 class="start-title">Session Complete </h1>
                <p class="start-subtitle">Great work!</p>
                <div class="dialer-stats-grid">
                    <div class="dialer-stat-card"><div class="dialer-stat-value" id="dialerStatCalls">0</div><div class="dialer-stat-label">Calls</div></div>
                    <div class="dialer-stat-card"><div class="dialer-stat-value" id="dialerStatAppts">0</div><div class="dialer-stat-label">Appts</div></div>
                    <div class="dialer-stat-card"><div class="dialer-stat-value" id="dialerStatTime">0:00</div><div class="dialer-stat-label">Time</div></div>
                </div>
                <button class="start-btn" onclick="Coachd.dialerReset()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
                    New Session
                </button>
            </div>
        </div>
        
        <!-- Power Dialer Appointment Modal -->
        <div class="dialer-modal-bg" id="dialerModal">
            <div class="dialer-modal">
                <h2 class="dialer-modal-title"> Book Appointment</h2>
                <input type="date" id="dialerApptDate">
                <input type="time" id="dialerApptTime" value="10:00">
                <div class="dialer-modal-actions">
                    <button class="dialer-btn dialer-btn-outline" onclick="Coachd.dialerCloseModal()">Cancel</button>
                    <button class="dialer-btn dialer-btn-primary" onclick="Coachd.dialerSaveAppt()">Save</button>
                </div>
            </div>
        </div>
        
        <!-- Connecting Screen -->
        <div class="screen connecting-screen" id="connectingScreen">
            <div class="connecting-card">
                <h1 class="connecting-title" id="connectingTitle">Calling Your Phone...</h1>
                <p class="connecting-subtitle" id="connectingSubtitle">Answer, then we'll dial your client</p>
                
                <div class="connection-steps">
                    <div class="connection-step active" id="stepAgent" data-step="agent">
                        <div class="step-indicator" id="stepAgentIndicator">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                                <path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/>
                            </svg>
                        </div>
                        <div class="step-content">
                            <span class="step-text">Your Phone</span>
                            <span class="step-subtext" id="stepAgentSubtext">Ringing...</span>
                        </div>
                    </div>
                    
                    <div class="step-connector" id="connectorAgentClient">
                        <div class="connector-fill"></div>
                    </div>
                    
                    <div class="connection-step waiting" id="stepClient" data-step="client">
                        <div class="step-indicator" id="stepClientIndicator">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                                <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                        </div>
                        <div class="step-content">
                            <span class="step-text">Client</span>
                            <span class="step-subtext" id="stepClientSubtext">Waiting...</span>
                        </div>
                    </div>
                    
                    <div class="step-connector" id="connectorClientReady">
                        <div class="connector-fill"></div>
                    </div>
                    
                    <div class="connection-step waiting" id="stepReady" data-step="ready">
                        <div class="step-indicator" id="stepReadyIndicator">
                            <!-- 5-bar waveform matching Coachd brand -->
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                                <line x1="4" y1="8" x2="4" y2="16"/>
                                <line x1="8" y1="5" x2="8" y2="19"/>
                                <line x1="12" y1="7" x2="12" y2="17"/>
                                <line x1="16" y1="4" x2="16" y2="20"/>
                                <line x1="20" y1="9" x2="20" y2="15"/>
                            </svg>
                        </div>
                        <div class="step-content">
                            <span class="step-text">Coachd</span>
                            <span class="step-subtext" id="stepReadySubtext">Ready</span>
                        </div>
                    </div>
                </div>
                
                <button class="connecting-cancel" onclick="Coachd.cancelCall()">Cancel</button>
            </div>
        </div>
        
        <!-- Connected Screen (shows briefly when client picks up) -->
        <div class="screen connected-screen" id="connectedScreen">
            <div class="connected-check">
                <svg fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                </svg>
            </div>
            <h1 class="connected-title">Connected!</h1>
            <p class="connected-subtitle">Client is on the line</p>
        </div>
        
        <!-- Call Screen -->
        <div class="screen call-screen" id="callScreen">
            <div class="call-content-wrapper">
                <!-- Main Guidance Area -->
                <div class="call-main">
                    <div class="guidance-area">
                        <!-- Floating Call Status -->
                        <div class="floating-status">
                            <div class="status-dot"></div>
                            <span class="timer" id="timer">0:00</span>
                        </div>
                        
                        <div class="teleprompter" id="teleprompter" onclick="Coachd.dismissGuidance()">
                            <div class="listening-state" id="listeningState">
                                <div class="listening-dot"></div>
                                <div class="listening-text">LISTENING</div>
                            </div>
                            
                            <div class="guidance-state" id="guidanceState">
                                <div class="guidance-text" id="guidanceText"></div>
                                <div class="dismiss-hint">Tap anywhere to dismiss</div>
                            </div>
                        </div>
                        
                        <!-- Temperature Meter -->
                        <div class="temp-meter" id="tempMeter">
                            <span class="temp-label temp-top">Close</span>
                            <div class="temp-track">
                                <div class="temp-fill" id="tempFill"></div>
                                <div class="temp-indicator" id="tempIndicator"></div>
                            </div>
                            <span class="temp-label temp-bottom">Exit</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Session Complete Screen -->
        <div class="screen complete-screen" id="completeScreen">
            <div class="complete-card">
                <div class="complete-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                </div>
                <h1 class="complete-title">Session Complete</h1>
                <div class="complete-stats">
                    <div class="complete-stat">
                        <span class="complete-stat-value" id="completeDuration">0:00</span>
                        <span class="complete-stat-label">Duration</span>
                    </div>
                </div>
                <div class="complete-actions">
                    <button class="complete-btn primary" onclick="Coachd.startNewCall()">New Call</button>
                </div>
            </div>
        </div>
        
        <!-- Error Modal -->
        <div class="modal-overlay" id="errorModal">
            <div class="modal">
                <div class="modal-header">
                    <div class="modal-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                    </div>
                    <h3 class="modal-title" id="errorModalTitle">Connection Failed</h3>
                </div>
                <p class="modal-desc" id="errorModalMessage">Unable to start the call. Please try again.</p>
                <div class="modal-actions" id="errorModalActions">
                    <button class="modal-btn modal-btn-confirm" onclick="Coachd.closeErrorModal()">OK</button>
                </div>
            </div>
        </div>
        
        <!-- Verification Modal -->
        <div class="modal-overlay verify-modal" id="verifyModal">
            <div class="modal">
                <!-- State 1: Initial -->
                <div class="verify-state active" id="verifyStateInitial">
                    <div class="modal-header">
                        <div class="modal-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                                <polyline points="9 12 11 14 15 10"/>
                            </svg>
                        </div>
                        <h3 class="modal-title">Quick Verification</h3>
                    </div>
                    <p class="modal-desc">To display your caller ID, we need to verify your phone number once. This only takes a moment.</p>
                    
                    <div class="method-toggle">
                        <button class="method-btn active" data-method="sms" onclick="Coachd.setVerifyMethod('sms')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                            </svg>
                            Text SMS
                        </button>
                        <button class="method-btn" data-method="call" onclick="Coachd.setVerifyMethod('call')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                            </svg>
                            Phone Call
                        </button>
                    </div>
                    
                    <div class="modal-actions">
                        <button class="modal-btn modal-btn-cancel" onclick="Coachd.closeVerifyModal()">Cancel</button>
                        <button class="modal-btn modal-btn-confirm" onclick="Coachd.sendVerifyCode()">Send Code</button>
                    </div>
                </div>
                
                <!-- State 2: Sending -->
                <div class="verify-state verify-sending" id="verifyStateSending">
                    <div class="verify-waveform">
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                        <div class="bar"></div>
                    </div>
                    <span class="modal-desc" style="margin-bottom:0">Sending verification code...</span>
                </div>
                
                <!-- State 3: Enter Code -->
                <div class="verify-state" id="verifyStateCode">
                    <div class="modal-header">
                        <div class="modal-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                            </svg>
                        </div>
                        <h3 class="modal-title">Enter Code</h3>
                    </div>
                    <p class="modal-desc" id="verifyCodeDesc">We sent a 5-digit code to your phone</p>
                    
                    <div class="code-input-wrapper">
                        <input type="text" 
                               class="code-input" 
                               id="verifyCodeInput"
                               inputmode="numeric" 
                               autocomplete="one-time-code"
                               maxlength="5"
                               placeholder=""
                               oninput="Coachd.handleCodeInput(this)">
                    </div>
                    
                    <div class="verify-error" id="verifyError">Invalid code. Please try again.</div>
                    
                    <div class="resend-row">
                        <span>Didn't receive it?</span>
                        <button class="resend-btn" id="resendBtn" disabled onclick="Coachd.resendCode()">Resend (60s)</button>
                    </div>
                    
                    <div class="modal-actions">
                        <button class="modal-btn modal-btn-cancel" onclick="Coachd.showVerifyState('verifyStateInitial')">Back</button>
                        <button class="modal-btn modal-btn-confirm" id="verifyConfirmBtn" disabled onclick="Coachd.confirmVerifyCode()">Verify</button>
                    </div>
                </div>
                
                <!-- State 4: Success -->
                <div class="verify-state verify-success" id="verifyStateSuccess">
                    <div class="verify-success-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    </div>
                    <h3 class="verify-success-title">Verified!</h3>
                    <p class="verify-success-subtitle">Connecting your call now...</p>
                </div>
            </div>
        </div>
        
        </div><!-- End .main-area -->
        
        <!-- ========== MOBILE BOTTOM PILL ========== -->
        <nav class="bottom-pill" id="bottomPill">
            <div class="bottom-pill-inner">
                <div class="bottom-pill-items">
                    <!-- Normal nav (shown when NOT in call) -->
                    <div class="pill-nav-normal">
                        <a href="/" class="pill-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
                            <span class="pill-item-label">Home</span>
                        </a>
                        <a href="/call" class="pill-item active">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 16.92z"/></svg>
                            <span class="pill-item-label">Call</span>
                        </a>
                        <button class="pill-item" onclick="Chat.open()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
                            <span class="pill-item-label">Ask</span>
                        </button>
                        <a href="#" class="pill-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/></svg>
                            <span class="pill-item-label">Resources</span>
                        </a>
                        <a href="#" class="pill-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
                            <span class="pill-item-label">Settings</span>
                        </a>
                    </div>
                    
                    <!-- Call nav (shown DURING call) -->
                    <div class="pill-nav-call">
                        <button class="pill-item" id="pillTranscriptBtn" onclick="Coachd.toggleBottomSheet('transcript')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
                            <span class="pill-badge empty" id="pillTranscriptBadge">0</span>
                            <span class="pill-item-label">Transcript</span>
                        </button>
                        <button class="pill-item" id="pillHistoryBtn" onclick="Coachd.toggleBottomSheet('history')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                            <span class="pill-badge empty" id="pillHistoryBadge">0</span>
                            <span class="pill-item-label">History</span>
                        </button>
                        <button class="pill-item danger" onclick="Coachd.endCall()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.68 13.31a16 16 0 003.41 2.6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7 2 2 0 011.72 2v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 002.59 3.4z"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
                            <span class="pill-item-label">End</span>
                        </button>
                    </div>
                </div>
            </div>
        </nav>
        
        <!-- ========== MOBILE BOTTOM SHEETS ========== -->
        <div class="bottom-sheet-backdrop" id="bottomSheetBackdrop" onclick="Coachd.closeBottomSheet()"></div>
        
        <div class="bottom-sheet" id="transcriptBottomSheet">
            <div class="sheet-handle"></div>
            <div class="bottom-sheet-header">
                <div class="slide-panel-header-left">
                    <div class="panel-dot"></div>
                    <span class="panel-title">Live Transcript</span>
                </div>
                <button class="slide-panel-close" onclick="Coachd.closeBottomSheet()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="bottom-sheet-content" id="transcriptSheetFeed">
                <div class="transcript-empty">Waiting for conversation...</div>
            </div>
        </div>
        
        <div class="bottom-sheet" id="historyBottomSheet">
            <div class="sheet-handle"></div>
            <div class="bottom-sheet-header">
                <div class="slide-panel-header-left">
                    <div class="panel-dot"></div>
                    <span class="panel-title">Guidance History</span>
                </div>
                <button class="slide-panel-close" onclick="Coachd.closeBottomSheet()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                </button>
            </div>
            <div class="bottom-sheet-content" id="historySheetFeed">
                <div class="history-empty">No guidance yet</div>
            </div>
        </div>
    </div><!-- End .app -->
    
    <!-- Page Loader (disabled - instant load) -->
    <div class="page-loader hidden" id="pageLoader">
        <div class="page-loader-waveform">
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
        </div>
    </div>
    
    <!-- Chat Modal (loaded from partial) -->
    {% include 'partials/chat.html' %}
    
    <script>
    // Chat module (loaded from partial)
    {% include 'partials/chat.js' %}
    
    const Coachd = (function() {
        'use strict';
        
        // ==================== CONFIG ====================
        const CONFIG = {
            telnyxStartEndpoint: '/api/telnyx/start-call',
            telnyxEndEndpoint: '/api/telnyx/end-call',
            telnyxSessionEndpoint: '/api/telnyx/session',
            agenciesEndpoint: '/api/agencies',
            outcomeEndpoint: '/api/call-outcomes',
            captionFadeDelay: 4000,
            pollInterval: 2000
        };
        
        // ==================== STATE ====================
        const state = {
            sessionId: null,
            agentPhone: null,
            clientPhone: null,  // Client phone for click-to-call
            agency: null,
            authAgent: null,  // Full agent data from auth system
            // SECURITY: Validated agency from home page
            validatedAgencyCode: null,
            validatedAgencyName: null,
            callType: 'presentation',
            currentMode: 'presentation',  // 'presentation' or 'dialer'
            dialerContacts: [],
            dialerIndex: 0,
            isInCall: false,
            seconds: 0,
            timerInterval: null,
            callStartTime: null,  // For relative timestamps
            guidanceHistory: [],
            selectedTipIndex: null,
            callOutcome: null,
            ws: null,
            wsReconnectAttempts: 0,
            wsMaxReconnectAttempts: 5,
            wsReconnecting: false,
            agentFadeTimer: null,
            callerFadeTimer: null,
            clientFadeTimer: null,
            streamingGuidance: '',
            hasVibratedForCurrentGuidance: false,
            guidanceDismissTimer: null,  // Fallback auto-dismiss
            dismissHintTimer: null,       // Shows "tap to dismiss" after 3s
            // Transcript sidebar state
            transcriptUserScrolled: false,
            currentClientText: '',
            currentClientElement: null,
            // History panel state
            historyExpanded: false,
            mobileHistoryExpanded: false,
            clientContext: {
                product: 'whole_life',
                age: null,
                occupation: null,
                married: null,
                kids: null,
                kidsCount: null,
                tobacco: null,
                budget: null
            },
            // Sentiment tracking
            currentSentiment: {
                level: 'neutral',
                trajectory: 'stable',
                tip: ''
            },
            sentimentVisible: false,
            // Guidance validation
            guidanceValidated: false,
            // Phone verification
            verifyMethod: 'sms',
            verifyCountdown: 0,
            verifyCountdownInterval: null
        };
        
        // ==================== DOM ====================
        const dom = {
            get identifyScreen() { return document.getElementById('identifyScreen'); },
            get startScreen() { return document.getElementById('startScreen'); },
            get connectingScreen() { return document.getElementById('connectingScreen'); },
            get callScreen() { return document.getElementById('callScreen'); },
            get completeScreen() { return document.getElementById('completeScreen'); },
            get startBtn() { return document.getElementById('startBtn'); },
            get timer() { return document.getElementById('timer'); },
            get endSessionBtn() { return document.getElementById('endSessionBtn'); },
            get teleprompter() { return document.getElementById('teleprompter'); },
            get listeningState() { return document.getElementById('listeningState'); },
            get guidanceState() { return document.getElementById('guidanceState'); },
            get guidanceText() { return document.getElementById('guidanceText'); },
            get completeDuration() { return document.getElementById('completeDuration'); },
            get agentPhone() { return document.getElementById('agentPhone'); },
            get agencySelect() { return document.getElementById('agencySelect'); },
            get identifyError() { return document.getElementById('identifyError'); },
            get phoneDisplay() { return document.getElementById('phoneDisplay'); },
            get phoneDisplayNumber() { return document.getElementById('phoneDisplayNumber'); },
            get clientPhoneInput() { return document.getElementById('clientPhoneInput'); },
            get clientPhoneError() { return document.getElementById('clientPhoneError'); },
            get callTypeHint() { return document.getElementById('callTypeHint'); },
            get errorModal() { return document.getElementById('errorModal'); },
            get errorModalTitle() { return document.getElementById('errorModalTitle'); },
            get errorModalMessage() { return document.getElementById('errorModalMessage'); },
            // Slide panels (desktop)
            get transcriptSlidePanel() { return document.getElementById('transcriptSlidePanel'); },
            get historySlidePanel() { return document.getElementById('historySlidePanel'); },
            get transcriptFeed() { return document.getElementById('transcriptFeed'); },
            get historyFeed() { return document.getElementById('historyFeed'); },
            get transcriptEmpty() { return document.getElementById('transcriptEmpty'); },
            get historyEmpty() { return document.getElementById('historyEmpty'); },
            // Bottom sheets (mobile)
            get transcriptBottomSheet() { return document.getElementById('transcriptBottomSheet'); },
            get historyBottomSheet() { return document.getElementById('historyBottomSheet'); },
            get transcriptSheetFeed() { return document.getElementById('transcriptSheetFeed'); },
            get historySheetFeed() { return document.getElementById('historySheetFeed'); },
            get bottomSheetBackdrop() { return document.getElementById('bottomSheetBackdrop'); },
            // Verification modal
            get verifyModal() { return document.getElementById('verifyModal'); },
            get verifyCodeInput() { return document.getElementById('verifyCodeInput'); },
            get verifyConfirmBtn() { return document.getElementById('verifyConfirmBtn'); },
            get verifyError() { return document.getElementById('verifyError'); },
            get resendBtn() { return document.getElementById('resendBtn'); },
            get verifyCodeDesc() { return document.getElementById('verifyCodeDesc'); },
            // Guidance area (for has-guidance class)
            get guidanceArea() { return document.querySelector('.guidance-area'); }
        };
        
        // ==================== INIT ====================
        
        // SECURITY: Check for validated agency code from home page
        function checkAgencyCode() {
            const savedAgency = localStorage.getItem('coachd_agency');
            if (!savedAgency) {
                console.log('[Security] No validated agency code - redirecting to home');
                const loader = document.getElementById('pageLoader');
                if (loader) loader.classList.remove('hidden');
                window.location.href = '/';
                return null;
            }
            try {
                const agency = JSON.parse(savedAgency);
                if (!agency.code) {
                    console.log('[Security] Invalid agency code format - redirecting to home');
                    const loader = document.getElementById('pageLoader');
                    if (loader) loader.classList.remove('hidden');
                    window.location.href = '/';
                    return null;
                }
                console.log('[Security] Validated agency code:', agency.code);
                return agency;
            } catch (e) {
                console.log('[Security] Failed to parse agency code - redirecting to home');
                localStorage.removeItem('coachd_agency');
                const loader = document.getElementById('pageLoader');
                if (loader) loader.classList.remove('hidden');
                window.location.href = '/';
                return null;
            }
        }
        
        async function init() {
            console.log(' Coachd.ai Live Call (Telnyx) - VERSION: 2025-01-16-v15-guidance-history');
            
            // SECURITY: Gate on validated agency code FIRST
            const validatedAgency = checkAgencyCode();
            if (!validatedAgency) {
                return; // Redirect is happening
            }
            
            // Store validated agency in state
            state.validatedAgencyCode = validatedAgency.code;
            state.validatedAgencyName = validatedAgency.name;
            
            await loadAgencies();
            loadClientContext();
            await checkExistingIdentity();
            
            // Initialize transcript sidebar scroll tracking
            initTranscriptScroll();
            
            // Clear phone error when user starts typing
            if (dom.clientPhoneInput) {
                dom.clientPhoneInput.addEventListener('input', clearPhoneError);
            }
        }
        
        function loadClientContext() {
            const saved = sessionStorage.getItem('coachd_context');
            if (saved) {
                try {
                    const ctx = JSON.parse(saved);
                    Object.keys(ctx).forEach(key => {
                        if (ctx[key] !== null && ctx[key] !== undefined) {
                            state.clientContext[key] = ctx[key];
                        }
                    });
                    console.log('[Context] Loaded from Quick Prep:', state.clientContext);
                } catch (e) {
                    console.log('[Context] No saved context found');
                }
            }
        }
        
        async function loadAgencies() {
            try {
                const resp = await fetch(CONFIG.agenciesEndpoint);
                if (resp.ok) {
                    const data = await resp.json();
                    const agencies = data.agencies || [];
                    agencies.forEach(a => {
                        const opt = document.createElement('option');
                        opt.value = a.code;
                        opt.textContent = a.name;
                        dom.agencySelect.appendChild(opt);
                    });
                }
            } catch (e) {
                // Fallback agencies
                const fallback = [
                    { code: 'ADERHOLT', name: 'Aderholt Agency' },
                    { code: 'BROOKS', name: 'Brooks Agency' }
                ];
                fallback.forEach(a => {
                    const opt = document.createElement('option');
                    opt.value = a.code;
                    opt.textContent = a.name;
                    dom.agencySelect.appendChild(opt);
                });
            }
        }
        
        async function checkExistingIdentity() {
            // FIRST: Check for auth token (agent logged in via signup flow)
            const authToken = localStorage.getItem('coachd_token');
            if (authToken) {
                try {
                    const authRes = await fetch('/api/auth/me', {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    if (authRes.ok) {
                        const authData = await authRes.json();
                        if (authData.success && authData.agent) {
                            // SECURITY: Verify agent's agency matches validated agency
                            if (authData.agent.agency_code === state.validatedAgencyCode) {
                                console.log('[Auth] Using authenticated agent:', authData.agent.first_name);
                                state.agentPhone = authData.agent.phone;
                                state.agency = authData.agent.agency_code;
                                state.authAgent = authData.agent;
                                updatePhoneDisplay();
                                showScreen('startScreen');
                                return;
                            } else {
                                console.log('[Auth] Agent agency mismatch - showing identify screen');
                            }
                        }
                    }
                } catch (e) {
                    console.log('[Auth] Token check failed:', e);
                }
            }
            
            // FALLBACK: Check for legacy coachd_agent localStorage
            const saved = localStorage.getItem('coachd_agent');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    
                    // SECURITY: Only accept saved identity if it matches validated agency
                    if (data.agency !== state.validatedAgencyCode) {
                        console.log('[Security] Saved agent agency mismatch - showing identify screen');
                        localStorage.removeItem('coachd_agent');
                        prefillAgencyDropdown();
                        showScreen('identifyScreen');
                        return;
                    }
                    
                    state.agentPhone = data.phone;
                    state.agency = data.agency;
                    updatePhoneDisplay();
                    showScreen('startScreen');
                } catch (e) {
                    prefillAgencyDropdown();
                    showScreen('identifyScreen');
                }
            } else {
                prefillAgencyDropdown();
                showScreen('identifyScreen');
            }
        }
        
        // Pre-fill and lock agency dropdown to validated agency
        function prefillAgencyDropdown() {
            if (state.validatedAgencyCode && dom.agencySelect) {
                console.log('[Agency] Prefilling dropdown with:', state.validatedAgencyCode, state.validatedAgencyName);
                
                // Clear all options first
                dom.agencySelect.innerHTML = '';
                
                // Add the validated agency as the only option
                const opt = document.createElement('option');
                opt.value = state.validatedAgencyCode;
                opt.textContent = state.validatedAgencyName || state.validatedAgencyCode;
                opt.selected = true;
                dom.agencySelect.appendChild(opt);
                
                // Lock dropdown
                dom.agencySelect.disabled = true;
                dom.agencySelect.style.opacity = '0.7';
                dom.agencySelect.style.cursor = 'not-allowed';
                
                console.log('[Agency] Dropdown set to:', dom.agencySelect.value);
            } else {
                console.log('[Agency] Cannot prefill - validatedAgencyCode:', state.validatedAgencyCode, 'agencySelect:', !!dom.agencySelect);
            }
        }
        
        function formatPhoneDisplay(phone) {
            const digits = phone.replace(/\D/g, '').slice(-10);
            if (digits.length === 10) {
                return `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
            }
            return phone;
        }
        
        function updatePhoneDisplay() {
            if (state.agentPhone) {
                dom.phoneDisplayNumber.textContent = formatPhoneDisplay(state.agentPhone);
            }
        }
        
        function saveIdentity() {
            const phone = dom.agentPhone.value.trim();
            // SECURITY: Use validated agency code, not dropdown value
            const agency = state.validatedAgencyCode;
            
            // Validate phone number (at least 10 digits)
            const phoneDigits = phone.replace(/\D/g, '');
            if (!agency || phoneDigits.length < 10) {
                dom.identifyError.textContent = 'Please enter a valid phone number';
                dom.identifyError.classList.add('show');
                dom.agentPhone.classList.add('error');
                setTimeout(() => dom.agentPhone.classList.remove('error'), 500);
                return;
            }
            
            dom.identifyError.classList.remove('show');
            
            state.agentPhone = phone;
            state.agency = agency;
            
            localStorage.setItem('coachd_agent', JSON.stringify({
                phone: state.agentPhone,
                agency: state.agency
            }));
            
            updatePhoneDisplay();
            showScreen('startScreen');
        }
        
        function changeAgent() {
            localStorage.removeItem('coachd_agent');
            state.agentPhone = null;
            state.agency = null;
            dom.agentPhone.value = '';
            // Agency stays locked to validated agency
            prefillAgencyDropdown();
            showScreen('identifyScreen');
        }
        
        // ==================== CALL TYPE ====================
        function setCallType(type) {
            state.callType = type;
            document.querySelectorAll('.call-type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });
            const hints = {
                phone: 'Setting appointments (2-3 min)',
                presentation: 'Full sales presentation (30-45 min)'
            };
            dom.callTypeHint.textContent = hints[type];
        }
        
        // ==================== NOTIFICATION SOUND ====================
        let audioContext = null;
        
        // Initialize audio context on user gesture (iOS requirement)
        function warmUpAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }
        
        function playNotificationSound() {
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Soft, pleasant tone
                oscillator.frequency.value = 880; // A5 note
                oscillator.type = 'sine';
                
                // Quick fade in/out for smooth sound
                const now = audioContext.currentTime;
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(0.3, now + 0.02); // Fade in
                gainNode.gain.linearRampToValueAtTime(0, now + 0.15);   // Fade out
                
                oscillator.start(now);
                oscillator.stop(now + 0.15);
            } catch (e) {
                console.log('[Audio] Notification sound failed:', e);
            }
        }
        
        // ==================== UTILS ====================
        function formatTime(s) {
            const m = Math.floor(s / 60);
            const sec = s % 60;
            return `${m}:${sec.toString().padStart(2, '0')}`;
        }
        
        function getCallRelativeTime(timestamp) {
            if (!state.callStartTime) return '0:00';
            const elapsed = Math.floor((timestamp - state.callStartTime) / 1000);
            const mins = Math.floor(Math.max(0, elapsed) / 60);
            const secs = Math.max(0, elapsed) % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        function setStatus(status) {
            // Status indicator removed - end button now in header
            // This function kept for compatibility but does nothing
            console.log('[Status]', status);
        }
        
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            
            // Timer visible during connected and call screens
            if (dom.timer) {
                dom.timer.style.display = (screenId === 'callScreen' || screenId === 'connectedScreen') ? 'block' : 'none';
            }
            
            // Manage in-call state for nav transformation
            const isInCall = (screenId === 'callScreen' || screenId === 'connectedScreen');
            setInCallState(isInCall);
            
            // Close any open panels/sheets when leaving call screen
            if (!isInCall) {
                const transcriptPanel = document.getElementById('transcriptSlidePanel');
                const historyPanel = document.getElementById('historySlidePanel');
                if (transcriptPanel) transcriptPanel.classList.remove('open');
                if (historyPanel) historyPanel.classList.remove('open');
                closeBottomSheet();
            }
        }
        
        function startTimer() {
            state.seconds = 0;
            state.callStartTime = Date.now();  // Track when call started for timestamps
            state.timerInterval = setInterval(() => {
                state.seconds++;
                const timeStr = formatTime(state.seconds);
                dom.timer.textContent = timeStr;
                // Also update mobile header timer
                const mobileTimer = document.getElementById('mobileTimer');
                if (mobileTimer) mobileTimer.textContent = timeStr;
            }, 1000);
        }
        
        function stopTimer() {
            if (state.timerInterval) {
                clearInterval(state.timerInterval);
                state.timerInterval = null;
            }
        }
        
        // ==================== ERROR MODAL ====================
        function showErrorModal(title, message) {
            dom.errorModalTitle.textContent = title || 'Connection Failed';
            dom.errorModalMessage.textContent = message || 'Unable to start the call. Please try again.';
            dom.errorModal.classList.add('visible');
        }
        
        function closeErrorModal() {
            dom.errorModal.classList.remove('visible');
        }
        
        // ==================== PHONE VERIFICATION ====================
        function showVerifyModal() {
            showVerifyState('verifyStateInitial');
            dom.verifyModal.classList.add('visible');
        }
        
        function closeVerifyModal() {
            dom.verifyModal.classList.remove('visible');
            stopVerifyCountdown();
            // Reset state
            if (dom.verifyCodeInput) dom.verifyCodeInput.value = '';
            if (dom.verifyConfirmBtn) dom.verifyConfirmBtn.disabled = true;
            if (dom.verifyError) dom.verifyError.classList.remove('visible');
        }
        
        function showVerifyState(stateId) {
            document.querySelectorAll('.verify-state').forEach(s => s.classList.remove('active'));
            document.getElementById(stateId)?.classList.add('active');
        }
        
        function setVerifyMethod(method) {
            state.verifyMethod = method;
            document.querySelectorAll('.method-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.method === method);
            });
        }
        
        async function checkPhoneVerified(phone) {
            try {
                const digits = phone.replace(/\D/g, '');
                const response = await fetch(`/api/verify/check/${digits}`);
                const data = await response.json();
                return data.verified === true;
            } catch (e) {
                console.error('[Verify] Check failed:', e);
                // On error, assume not verified to be safe
                return false;
            }
        }
        
        async function sendVerifyCode() {
            showVerifyState('verifyStateSending');
            
            try {
                const response = await fetch('/api/verify/initiate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone_number: state.agentPhone,
                        method: state.verifyMethod
                    })
                });
                
                const data = await response.json();
                
                if (data.already_verified) {
                    // Already verified - proceed to call
                    showVerifyState('verifyStateSuccess');
                    setTimeout(() => {
                        closeVerifyModal();
                        proceedWithCall();
                    }, 1500);
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(data.detail || 'Failed to send code');
                }
                
                // Show code entry screen
                const methodText = state.verifyMethod === 'sms' ? 'texted' : 'called';
                if (dom.verifyCodeDesc) {
                    dom.verifyCodeDesc.textContent = `We ${methodText} a 5-digit code to your phone`;
                }
                showVerifyState('verifyStateCode');
                startVerifyCountdown();
                
                // Focus the input
                setTimeout(() => dom.verifyCodeInput?.focus(), 100);
                
            } catch (e) {
                console.error('[Verify] Send code failed:', e);
                showVerifyState('verifyStateInitial');
                showErrorModal('Verification Failed', e.message || 'Unable to send verification code. Please try again.');
                closeVerifyModal();
            }
        }
        
        function handleCodeInput(input) {
            // Strip non-digits
            input.value = input.value.replace(/\D/g, '');
            
            // Clear error on input
            if (dom.verifyError) dom.verifyError.classList.remove('visible');
            if (dom.verifyCodeInput) dom.verifyCodeInput.classList.remove('error');
            
            // Enable/disable verify button (Telnyx sends 5-digit codes)
            if (dom.verifyConfirmBtn) {
                dom.verifyConfirmBtn.disabled = input.value.length !== 5;
            }
        }
        
        async function confirmVerifyCode() {
            const code = dom.verifyCodeInput?.value?.trim();
            if (!code || code.length !== 5) return;
            
            dom.verifyConfirmBtn.disabled = true;
            
            try {
                const response = await fetch('/api/verify/confirm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone_number: state.agentPhone,
                        code: code
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || 'Invalid code');
                }
                
                // Success!
                stopVerifyCountdown();
                showVerifyState('verifyStateSuccess');
                
                // Auto-proceed to call
                setTimeout(() => {
                    closeVerifyModal();
                    proceedWithCall();
                }, 1500);
                
            } catch (e) {
                console.error('[Verify] Confirm failed:', e);
                // Show error
                if (dom.verifyError) {
                    dom.verifyError.textContent = e.message || 'Invalid code. Please try again.';
                    dom.verifyError.classList.add('visible');
                }
                if (dom.verifyCodeInput) {
                    dom.verifyCodeInput.classList.add('error');
                    dom.verifyCodeInput.select();
                }
                dom.verifyConfirmBtn.disabled = false;
            }
        }
        
        function startVerifyCountdown() {
            state.verifyCountdown = 60;
            updateResendButton();
            
            state.verifyCountdownInterval = setInterval(() => {
                state.verifyCountdown--;
                updateResendButton();
                
                if (state.verifyCountdown <= 0) {
                    stopVerifyCountdown();
                }
            }, 1000);
        }
        
        function stopVerifyCountdown() {
            if (state.verifyCountdownInterval) {
                clearInterval(state.verifyCountdownInterval);
                state.verifyCountdownInterval = null;
            }
        }
        
        function updateResendButton() {
            if (!dom.resendBtn) return;
            
            if (state.verifyCountdown > 0) {
                dom.resendBtn.disabled = true;
                dom.resendBtn.textContent = `Resend (${state.verifyCountdown}s)`;
            } else {
                dom.resendBtn.disabled = false;
                dom.resendBtn.textContent = 'Resend Code';
            }
        }
        
        async function resendCode() {
            if (state.verifyCountdown > 0) return;
            await sendVerifyCode();
        }
        
        // ==================== TELNYX CALL FLOW ====================
        
        // Helper to validate phone number
        function validatePhoneNumber(phone) {
            // Strip non-digits
            const digits = phone.replace(/\D/g, '');
            // US numbers: 10 digits, or 11 starting with 1
            return digits.length === 10 || (digits.length === 11 && digits.startsWith('1'));
        }
        
        // Helper to show phone validation error
        function showPhoneError(message) {
            const input = dom.clientPhoneInput;
            const error = dom.clientPhoneError;
            
            if (input) {
                input.classList.add('error');
                // Remove error class after animation
                setTimeout(() => input.classList.remove('error'), 500);
            }
            
            if (error) {
                error.textContent = message;
                error.classList.add('visible');
            }
        }
        
        // Helper to clear phone validation error
        function clearPhoneError() {
            const input = dom.clientPhoneInput;
            const error = dom.clientPhoneError;
            
            if (input) input.classList.remove('error');
            if (error) error.classList.remove('visible');
        }
        
        async function startCall() {
            // Warm up audio on user gesture (iOS requirement)
            warmUpAudio();
            
            // Clear any previous error
            clearPhoneError();
            
            // Get client phone - now mandatory
            const clientPhone = dom.clientPhoneInput?.value?.trim() || '';
            
            // Validate phone number
            if (!clientPhone) {
                showPhoneError('Client phone number is required');
                dom.clientPhoneInput?.focus();
                return;
            }
            
            if (!validatePhoneNumber(clientPhone)) {
                showPhoneError('Please enter a valid 10-digit phone number');
                dom.clientPhoneInput?.focus();
                return;
            }
            
            state.clientPhone = clientPhone;
            dom.startBtn.disabled = true;
            
            // Check if agent phone is verified for caller ID
            const isVerified = await checkPhoneVerified(state.agentPhone);
            
            if (!isVerified) {
                // Show verification modal
                dom.startBtn.disabled = false;
                showVerifyModal();
                return;
            }
            
            // Phone is verified, proceed with call
            proceedWithCall();
        }
        
        async function proceedWithCall() {
            dom.startBtn.disabled = true;
            
            // Reset reconnection state for new call
            state.wsReconnectAttempts = 0;
            state.wsReconnecting = false;
            
            setStatus('connecting');
            showScreen('connectingScreen');
            resetConnectionSteps();
            
            // Update connecting screen message based on mode
            const connectingTitle = document.querySelector('.connecting-title');
            const connectingSubtitle = document.querySelector('.connecting-subtitle');
            if (state.clientPhone) {
                if (connectingTitle) connectingTitle.textContent = 'Calling Your Phone...';
                if (connectingSubtitle) connectingSubtitle.textContent = 'Answer, then we\'ll dial your client';
            } else {
                if (connectingTitle) connectingTitle.textContent = 'Calling Your Phone...';
                if (connectingSubtitle) connectingSubtitle.textContent = 'Answer, then we\'ll dial your client';
            }
            
            try {
                // Call the Telnyx API - include client_phone and context for click-to-call
                const response = await fetch(CONFIG.telnyxStartEndpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        agent_phone: state.agentPhone,
                        client_phone: state.clientPhone || null,  // null triggers legacy 3-way mode
                        client_context: state.clientContext  // Quick Prep context for personalized coaching
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok || !data.success) {
                    throw new Error(data.detail || data.error || 'Failed to start call');
                }
                
                state.sessionId = data.session_id;
                console.log('[Telnyx] Call initiated, session:', state.sessionId);
                
                setStatus('ringing');
                
                // Connect WebSocket for real-time updates
                await connectWebSocket();
                
            } catch (e) {
                console.error('Start call failed:', e);
                setStatus('error');
                showScreen('startScreen');
                showErrorModal('Connection Failed', e.message || 'Unable to start the call. Please try again.');
            }
            
            dom.startBtn.disabled = false;
        }
        
        async function connectWebSocket() {
            return new Promise((resolve, reject) => {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/telnyx/session/${state.sessionId}`;
                
                console.log('[WS] Connecting to:', wsUrl);
                state.ws = new WebSocket(wsUrl);
                
                state.ws.onopen = () => {
                    console.log('[WS] Connected');
                    state.wsReconnectAttempts = 0;  // Reset on successful connect
                    state.wsReconnecting = false;
                    startKeepAlive();  // Keep mobile Safari alive
                    resolve();
                };
                
                state.ws.onclose = (event) => {
                    console.log('[WS] Disconnected, code:', event.code, 'reason:', event.reason);
                    
                    // Don't reconnect if we intentionally closed (code 1000) or no session
                    if (event.code === 1000 || !state.sessionId) {
                        handleIntentionalClose();
                        return;
                    }
                    
                    // Try to reconnect if we still have an active session
                    if (state.sessionId && state.wsReconnectAttempts < state.wsMaxReconnectAttempts) {
                        attemptReconnect();
                    } else {
                        handleIntentionalClose();
                    }
                };
                
                state.ws.onerror = (err) => {
                    console.error('[WS] Error:', err);
                    // Don't reject on error if reconnecting - let onclose handle it
                    if (!state.wsReconnecting) {
                        reject(err);
                    }
                };
                
                state.ws.onmessage = (e) => {
                    try {
                        const msg = JSON.parse(e.data);
                        handleMessage(msg);
                    } catch (err) {
                        console.error('[WS] Parse error:', err);
                    }
                };
                
                setTimeout(() => {
                    if (state.ws.readyState !== WebSocket.OPEN) {
                        reject(new Error('WebSocket timeout'));
                    }
                }, 10000);
            });
        }
        
        function handleIntentionalClose() {
            stopKeepAlive();
            
            // If we're on the connecting screen, call was rejected/ended before answering
            if (dom.connectingScreen.classList.contains('active')) {
                console.log('[WS] Call ended while connecting');
                state.sessionId = null;
                setStatus('');
                showScreen('startScreen');
            }
            // If we're in an active call, show outcome screen
            else if (state.isInCall) {
                console.log('[WS] Call ended during active session');
                endCall();
            }
        }
        
        function attemptReconnect() {
            state.wsReconnectAttempts++;
            state.wsReconnecting = true;
            
            // Show reconnecting status
            setStatus(`Reconnecting... (${state.wsReconnectAttempts}/${state.wsMaxReconnectAttempts})`);
            
            // Exponential backoff: 1s, 2s, 4s, 8s, 16s
            const delay = Math.min(1000 * Math.pow(2, state.wsReconnectAttempts - 1), 16000);
            console.log(`[WS] Reconnecting in ${delay}ms (attempt ${state.wsReconnectAttempts}/${state.wsMaxReconnectAttempts})`);
            
            setTimeout(async () => {
                if (!state.sessionId) {
                    console.log('[WS] Session cleared, aborting reconnect');
                    state.wsReconnecting = false;
                    return;
                }
                
                try {
                    await connectWebSocket();
                    console.log('[WS] Reconnected successfully');
                    setStatus('');  // Clear reconnecting message
                } catch (err) {
                    console.error('[WS] Reconnect failed:', err);
                    // onclose will handle next attempt
                }
            }, delay);
        }
        
        // Mobile Safari keepalive - ping every 15 seconds to prevent connection timeout
        let keepAliveInterval = null;
        
        function startKeepAlive() {
            stopKeepAlive();
            keepAliveInterval = setInterval(() => {
                if (state.ws && state.ws.readyState === WebSocket.OPEN) {
                    state.ws.send(JSON.stringify({ type: 'ping' }));
                }
            }, 15000);
        }
        
        function stopKeepAlive() {
            if (keepAliveInterval) {
                clearInterval(keepAliveInterval);
                keepAliveInterval = null;
            }
        }
        
        function handleMessage(msg) {
            console.log('[MSG]', msg.type);
            
            switch (msg.type) {
                case 'session_state':
                    handleSessionState(msg.data);
                    break;
                case 'status_update':
                    handleStatusUpdate(msg.data);
                    break;
                case 'session_update':
                    // Backend sends this on session changes
                    handleStatusUpdate(msg.data);
                    break;
                case 'ready':
                    // Agent connected, call is live
                    onCallConnected();
                    break;
                case 'transcript':
                    handleTranscript(msg);
                    break;
                case 'client_transcript':
                    handleClientTranscript(msg);
                    break;
                case 'agent_transcript':
                    handleAgentTranscript(msg);
                    break;
                case 'speakers_identified':
                    // Agent intro detected - roles are now locked
                    console.log(' Speakers identified:', msg.message);
                    setStatus('Coaching active');
                    break;
                case 'session_update':
                    handleSessionUpdate(msg.data || msg);
                    break;
                case 'client_connected':
                    // Click-to-call: Client answered - all connected!
                    console.log(' Client connected!');
                    updateConnectionStep('client', 'complete');
                    updateConnectionStep('ready', 'complete');
                    document.getElementById('stepClientSubtext').textContent = 'Connected';
                    document.getElementById('stepReadySubtext').textContent = 'Going live...';
                    document.getElementById('connectingTitle').textContent = 'All Connected!';
                    document.getElementById('connectingSubtitle').textContent = 'Starting session...';
                    // Brief pause to show success, then transition
                    setTimeout(() => onCallConnected(), 800);
                    break;
                case 'guidance':
                    handleGuidance(msg);
                    break;
                case 'guidance_start':
                    handleGuidanceStart(msg);
                    break;
                case 'guidance_chunk':
                    handleGuidanceChunk(msg);
                    break;
                case 'guidance_complete':
                    handleGuidanceComplete(msg);
                    break;
                case 'guidance_dismiss':
                    dismissGuidance();
                    break;
                case 'sentiment_update':
                    handleSentimentUpdate(msg);
                    break;
                case 'veteran_update':
                    handleVeteranUpdate(msg);
                    break;
                case 'bridge':
                    handleBridge(msg);
                    break;
                case 'redialing':
                    // Auto-redial in progress (first attempt failed)
                    console.log(' Redialing client, attempt', msg.attempt || 2);
                    document.getElementById('connectingTitle').textContent = 'Redialing Client...';
                    document.getElementById('connectingSubtitle').textContent = 'First attempt failed, trying again';
                    document.getElementById('stepClientSubtext').textContent = 'Retrying...';
                    break;
                case 'client_dialing':
                    // Client is being dialed (could be initial or redial)
                    const dialAttempt = msg.attempt || 1;
                    console.log(' Dialing client, attempt', dialAttempt);
                    updateConnectionStep('agent', 'complete');
                    updateConnectionStep('client', 'active');
                    document.getElementById('stepAgentSubtext').textContent = 'Connected';
                    
                    // Show different text for redial vs first dial
                    if (dialAttempt > 1) {
                        document.getElementById('stepClientSubtext').textContent = 'Redialing...';
                        document.getElementById('connectingTitle').textContent = 'Redialing Client...';
                        document.getElementById('connectingSubtitle').textContent = 'Second attempt';
                    } else {
                        document.getElementById('stepClientSubtext').textContent = 'Ringing...';
                        document.getElementById('connectingTitle').textContent = 'Calling Client...';
                        document.getElementById('connectingSubtitle').textContent = 'Waiting for them to answer';
                    }
                    break;
                case 'client_unavailable':
                    // Client couldn't be reached after 2 attempts
                    console.log(' Client unavailable after 2 attempts');
                    cancelCall();
                    showErrorModal('Client Unavailable', msg.message || 'Couldn\'t reach client after 2 attempts.');
                    break;
                case 'call_ended':
                    // Call ended by server (agent or client hung up, or timeout)
                    console.log(' Call ended by server:', msg.party || 'unknown', msg.cause || '');
                    
                    // If we're still on connecting screen, show appropriate message
                    if (dom.connectingScreen.classList.contains('active')) {
                        const cause = msg.cause || 'normal';
                        let title = 'Call Ended';
                        let message = 'The call was disconnected.';
                        
                        // Agent-side failures (user declined our call, etc)
                        if (msg.party === 'agent') {
                            if (cause === 'timeout' || cause === 'no_answer') {
                                title = 'No Answer';
                                message = 'Please answer your phone to start coaching.';
                            } else if (cause === 'rejected' || cause === 'call_rejected') {
                                title = 'Call Declined';
                                message = 'You declined the call.';
                            }
                        }
                        // Note: Client failures are handled by auto-redial + client_unavailable
                        
                        cancelCall();
                        showErrorModal(title, message);
                    } else {
                        // Normal end during active call
                        endCall(true);  // true = from server, don't call backend again
                    }
                    break;
                case 'call_hangup':
                    // Phone hung up (from Telnyx webhook)
                    console.log(' Call hangup:', msg.party, msg.cause);
                    handleCallHangup(msg);
                    break;
                case 'error':
                    console.error('Server error:', msg.message, msg.code);
                    // If we're on the connecting screen, show appropriate error
                    if (dom.connectingScreen.classList.contains('active')) {
                        const errorCode = msg.code || '';
                        let title = 'Connection Failed';
                        let message = msg.message || 'Unable to complete the call.';
                        
                        if (errorCode === 'client_dial_failed') {
                            title = 'Couldn\'t Reach Client';
                            message = 'Unable to connect to the client. Please check the number.';
                        }
                        
                        // Return to start screen and show error
                        cancelCall();
                        showErrorModal(title, message);
                    }
                    break;
            }
        }
        
        function handleSessionState(data) {
            console.log('[Session State]', data.status);
            
            if (data.status === 'in_progress') {
                // Client is connected - ready for coaching
                onCallConnected();
            } else if (data.status === 'agent_connected') {
                // Agent connected - only go to coaching if NO client phone was provided
                // (native 3-way mode where agent manually adds client)
                if (!state.clientPhone) {
                    onCallConnected();
                }
                // If client phone was provided, wait for client_connected message
            } else if (data.status === 'ended' || data.status === 'failed') {
                endCall(true);  // Server indicated call ended
            }
        }
        
        function handleStatusUpdate(data) {
            console.log('[Status Update]', data.status);
            
            if (data.status === 'in_progress') {
                // Client is connected - ready for coaching
                onCallConnected();
            } else if (data.status === 'agent_connected') {
                // Agent connected - only go to coaching if NO client phone was provided
                if (!state.clientPhone) {
                    onCallConnected();
                }
                // If client phone was provided, the client_dialing message handler
                // will update the UI, and client_connected will trigger onCallConnected
            } else if (data.status === 'client_ringing') {
                // Client is ringing - update UI
                updateConnectionStep('agent', 'complete');
                updateConnectionStep('client', 'active');
                document.getElementById('stepAgentSubtext').textContent = 'Connected';
                document.getElementById('stepClientSubtext').textContent = 'Ringing...';
                document.getElementById('connectingTitle').textContent = 'Calling Client...';
                document.getElementById('connectingSubtitle').textContent = 'Waiting for them to answer';
            }
        }
        
        function updateConnectionStep(step, status) {
            const stepEl = document.getElementById('step' + step.charAt(0).toUpperCase() + step.slice(1));
            if (!stepEl) return;
            
            stepEl.classList.remove('active', 'complete', 'waiting');
            if (status === 'active') {
                stepEl.classList.add('active');
            } else if (status === 'complete') {
                stepEl.classList.add('complete');
                // Replace icon with checkmark
                const indicatorEl = stepEl.querySelector('.step-indicator');
                if (indicatorEl) {
                    indicatorEl.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>';
                }
                // Fill the connector that leads TO the next step
                if (step === 'agent') {
                    const connector = document.getElementById('connectorAgentClient');
                    if (connector) connector.classList.add('filled');
                } else if (step === 'client') {
                    const connector = document.getElementById('connectorClientReady');
                    if (connector) connector.classList.add('filled');
                }
            } else {
                stepEl.classList.add('waiting');
            }
        }
        
        function handleCallHangup(msg) {
            const party = msg.party || 'unknown';
            const cause = msg.cause || 'normal';
            
            console.log(`[Hangup] ${party} hung up: ${cause}`);
            
            // End the call - server already knows, don't call back
            endCall(true);
        }
        
        function resetConnectionSteps() {
            // Reset step 1 - Agent
            const stepAgent = document.getElementById('stepAgent');
            if (stepAgent) {
                stepAgent.classList.remove('complete', 'waiting');
                stepAgent.classList.add('active');
                const indicator = stepAgent.querySelector('.step-indicator');
                if (indicator) {
                    indicator.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/></svg>';
                }
            }
            
            // Reset step 2 - Client
            const stepClient = document.getElementById('stepClient');
            if (stepClient) {
                stepClient.classList.remove('active', 'complete');
                stepClient.classList.add('waiting');
                const indicator = stepClient.querySelector('.step-indicator');
                if (indicator) {
                    indicator.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>';
                }
            }
            
            // Reset step 3 - Coachd
            const stepReady = document.getElementById('stepReady');
            if (stepReady) {
                stepReady.classList.remove('active', 'complete');
                stepReady.classList.add('waiting');
                const indicator = stepReady.querySelector('.step-indicator');
                if (indicator) {
                    // 5-bar waveform icon matching Coachd brand
                    indicator.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="4" y1="8" x2="4" y2="16"/><line x1="8" y1="5" x2="8" y2="19"/><line x1="12" y1="7" x2="12" y2="17"/><line x1="16" y1="4" x2="16" y2="20"/><line x1="20" y1="9" x2="20" y2="15"/></svg>';
                }
            }
            
            // Reset connectors
            const connectorAgentClient = document.getElementById('connectorAgentClient');
            const connectorClientReady = document.getElementById('connectorClientReady');
            if (connectorAgentClient) connectorAgentClient.classList.remove('filled');
            if (connectorClientReady) connectorClientReady.classList.remove('filled');
            
            // Reset subtexts
            const stepAgentSubtext = document.getElementById('stepAgentSubtext');
            const stepClientSubtext = document.getElementById('stepClientSubtext');
            const stepReadySubtext = document.getElementById('stepReadySubtext');
            const connectingTitle = document.getElementById('connectingTitle');
            const connectingSubtitle = document.getElementById('connectingSubtitle');
            
            if (stepAgentSubtext) stepAgentSubtext.textContent = 'Ringing...';
            if (stepClientSubtext) stepClientSubtext.textContent = 'Waiting...';
            if (stepReadySubtext) stepReadySubtext.textContent = 'Ready';
            if (connectingTitle) connectingTitle.textContent = 'Connecting...';
            if (connectingSubtitle) connectingSubtitle.textContent = 'Answer your phone to begin';
        }
        
        function onCallConnected() {
            if (state.isInCall) return; // Already handled
            
            state.isInCall = true;
            state.guidanceHistory = [];
            state.selectedTipIndex = null;
            state.callOutcome = null;
            
            // Disable landscape blocker during active call
            document.body.classList.add('call-active');
            
            // Show end button in header
            if (dom.endSessionBtn) {
                dom.endSessionBtn.classList.add('show');
            }
            
            // Mark all connection steps complete
            updateConnectionStep('agent', 'complete');
            updateConnectionStep('client', 'complete');
            updateConnectionStep('ready', 'complete');
            document.getElementById('stepClientSubtext').textContent = 'Connected';
            document.getElementById('stepReadySubtext').textContent = 'Live';
            
            // Start timer immediately
            startTimer();
            
            console.log('[Call] Client connected - transitioning to guidance');
            
            // Brief pause then smooth transition to guidance screen (skip interstitial)
            setTimeout(() => {
                resetCaptions();
                showScreen('callScreen');
                setStatus('listening');
                console.log('[Call] Transitioned to guidance - listening');
            }, 400);
            
            // Keep screen awake
            if ('wakeLock' in navigator) {
                navigator.wakeLock.request('screen').catch(() => {});
            }
        }
        
        function cancelCall() {
            console.log('[Cancel] Canceling call, session:', state.sessionId);
            
            // Re-enable landscape blocker
            document.body.classList.remove('call-active');
            
            // Close WebSocket first
            if (state.ws) {
                state.ws.close();
                state.ws = null;
            }
            
            // Tell backend to hang up the Telnyx call
            if (state.sessionId) {
                fetch(CONFIG.telnyxEndEndpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: state.sessionId })
                }).then(resp => {
                    console.log('[Cancel] End call response:', resp.status);
                }).catch(err => {
                    console.log('[Cancel] End call error:', err);
                });
            }
            
            state.sessionId = null;
            state.isInCall = false;
            setStatus('');
            resetConnectionSteps();
            showScreen('startScreen');
        }
        
        function endCall(fromServer = false) {
            // Prevent double-cleanup
            if (!state.isInCall && !state.sessionId) return;
            
            state.isInCall = false;
            
            // Re-enable landscape blocker
            document.body.classList.remove('call-active');
            
            // Hide end button in header
            if (dom.endSessionBtn) {
                dom.endSessionBtn.classList.remove('show');
            }
            
            // Only tell backend to end call if this wasn't triggered by the server
            // (avoids circular call when server sends call_ended)
            if (state.sessionId && !fromServer) {
                fetch(CONFIG.telnyxEndEndpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: state.sessionId })
                }).catch(() => {});
            }
            
            if (state.ws) {
                state.ws.close();
                state.ws = null;
            }
            
            stopTimer();
            setStatus('');
            
            // Show session complete screen with duration
            dom.completeDuration.textContent = formatTime(state.seconds);
            showScreen('completeScreen');
            state.sessionId = null;
        }
        
        // ==================== TRANSCRIPTS ====================
        function handleTranscript(msg) {
            const text = msg.text || '';
            const isFinal = msg.is_final;
            let speaker = msg.speaker || 'agent';
            const rolesLocked = msg.roles_locked;
            
            // Before roles are locked, show everything as neutral "agent" line
            // This prevents false CLIENT labels before we know who's who
            if (!rolesLocked && speaker === 'unknown') {
                speaker = 'agent';  // Show in agent line until we identify speakers
            }
            
            updateCaption(speaker, text, !isFinal);
            
            // Only extract client info from confirmed client speech
            if (isFinal && speaker === 'caller' && text.length > 3 && rolesLocked) {
                extractClientInfo(text);
            }
        }
        
        function extractClientInfo(text) {
            let updated = false;
            
            // Age extraction
            const agePatterns = [
                /i(?:'m| am)\s*(\d{1,2})(?:\s*years?\s*old)?/i,
                /(?:^|\s)(\d{1,2})\s*years?\s*old/i,
                /age\s*(?:is\s*)?(\d{1,2})/i
            ];
            for (const pattern of agePatterns) {
                const match = text.match(pattern);
                if (match) {
                    const age = parseInt(match[1]);
                    if (age >= 18 && age <= 100 && age !== state.clientContext.age) {
                        state.clientContext.age = age;
                        updated = true;
                    }
                    break;
                }
            }
            
            // Marital status
            if (!state.clientContext.married || state.clientContext.married === 'N') {
                if (/\b(my wife|my husband|my spouse|i'm married|i am married|we're married)\b/i.test(text)) {
                    state.clientContext.married = 'Y';
                    updated = true;
                }
            }
            
            // Kids
            const kidsPatterns = [
                /(?:have|got)\s*(\d+|one|two|three|four|five|six)\s*(?:kids?|children|child)/i,
                /(\d+|one|two|three|four|five|six)\s*(?:kids?|children)/i,
                /\b(my kids|my children|our kids|our children)\b/i
            ];
            for (const pattern of kidsPatterns) {
                const match = text.match(pattern);
                if (match) {
                    state.clientContext.kids = 'Y';
                    const numWords = { one: 1, two: 2, three: 3, four: 4, five: 5, six: 6 };
                    const countMatch = match[1];
                    if (countMatch) {
                        const count = numWords[countMatch.toLowerCase()] || parseInt(countMatch);
                        if (count && count > 0 && count < 20) {
                            state.clientContext.kidsCount = count;
                        }
                    }
                    updated = true;
                    break;
                }
            }
            
            // Budget
            const budgetPatterns = [
                /(?:only|maybe|about|around|do|afford|pay|spend)\s*\$(\d+)/i,
                /\$(\d+)\s*(?:a|per)?\s*month/i,
                /(\d+)\s*(?:dollars|bucks)\s*(?:a|per)?\s*month/i,
                /budget\s*(?:is|of)?\s*\$?(\d+)/i
            ];
            for (const pattern of budgetPatterns) {
                const match = text.match(pattern);
                if (match) {
                    const budget = parseInt(match[1]);
                    if (budget >= 10 && budget <= 500 && budget !== state.clientContext.budget) {
                        state.clientContext.budget = budget;
                        updated = true;
                    }
                    break;
                }
            }
            
            if (updated) {
                sendContextUpdate();
            }
        }
        
        function sendContextUpdate() {
            if (state.ws && state.ws.readyState === WebSocket.OPEN) {
                const contextData = {
                    call_type: state.callType,
                    agency: state.agency,
                    product: state.clientContext.product,
                    age: state.clientContext.age,
                    occupation: state.clientContext.occupation,
                    family: buildFamilyString(),
                    budget: state.clientContext.budget
                };
                
                state.ws.send(JSON.stringify({
                    type: 'context',
                    data: contextData
                }));
            }
        }
        
        function buildFamilyString() {
            const parts = [];
            if (state.clientContext.married === 'Y') {
                parts.push('married');
            } else {
                parts.push('single');
            }
            if (state.clientContext.kids === 'Y') {
                if (state.clientContext.kidsCount) {
                    parts.push(`${state.clientContext.kidsCount} kids`);
                } else {
                    parts.push('has kids');
                }
            }
            return parts.join(', ') || null;
        }
        
        // ==================== CAPTIONS ====================
        function handleClientTranscript(msg) {
            const text = msg.text || '';
            const isFinal = msg.is_final;
            
            updateTranscriptSidebar('client', text, !isFinal);
            
            if (isFinal && text.length > 3) {
                extractClientInfo(text);
            }
        }
        
        function handleAgentTranscript(msg) {
            const text = msg.text || '';
            if (text) {
                updateTranscriptSidebar('agent', text, false);
            }
        }
        
        function updateTranscriptSidebar(speaker, text, isInterim) {
            if (!text) return;
            
            // Remove empty state on first message
            if (dom.transcriptEmpty) {
                dom.transcriptEmpty.remove();
            }
            
            // For interim (live typing), update current element or create new
            if (isInterim) {
                if (!state.currentClientElement) {
                    // Create new message element for live typing
                    state.currentClientElement = createTranscriptMessage('client', '');
                    dom.transcriptFeed.appendChild(state.currentClientElement);
                }
                // Update with cursor
                const textEl = state.currentClientElement.querySelector('.transcript-text');
                textEl.innerHTML = text + '<span class="cursor"></span>';
                state.currentClientText = text;
            } else {
                // Final transcript
                if (speaker === 'client' && state.currentClientElement) {
                    // Finalize the current interim element
                    const textEl = state.currentClientElement.querySelector('.transcript-text');
                    textEl.textContent = text;
                    state.currentClientElement = null;
                    state.currentClientText = '';
                } else {
                    // Create new final message (agent or new client)
                    const msgEl = createTranscriptMessage(speaker, text);
                    dom.transcriptFeed.appendChild(msgEl);
                }
            }
            
            // Auto-scroll unless user scrolled up
            if (!state.transcriptUserScrolled) {
                dom.transcriptFeed.scrollTop = dom.transcriptFeed.scrollHeight;
            }
            
            // Update scroll fade indicator
            updateScrollFade();
            
            // Sync to slide panel and bottom sheet
            syncTranscriptToNav();
        }
        
        function createTranscriptMessage(speaker, text) {
            const div = document.createElement('div');
            div.className = `transcript-msg ${speaker}`;
            const timestamp = getCallRelativeTime(Date.now());
            div.innerHTML = `
                <div class="transcript-msg-header">
                    <span class="transcript-label">${speaker.toUpperCase()}</span>
                    <span class="transcript-time">${timestamp}</span>
                </div>
                <div class="transcript-text">${text}</div>
            `;
            return div;
        }
        
        function updateScrollFade() {
            // Updated for new floating transcript panel
            if (dom.transcriptFeed && dom.transcriptPanel) {
                const hasScroll = dom.transcriptFeed.scrollTop > 10;
                dom.transcriptPanel.classList.toggle('has-scroll', hasScroll);
            }
        }
        
        function toggleTranscript() {
            // Redirect to slide panel toggle (desktop) or bottom sheet (mobile)
            if (window.innerWidth <= 767) {
                toggleBottomSheet('transcript');
            } else {
                toggleSlidePanel('transcript');
            }
        }
        
        function collapseTranscript() {
            // Auto-collapse panels when guidance shows
            const transcriptPanel = dom.transcriptSlidePanel;
            if (transcriptPanel) transcriptPanel.classList.remove('open');
            // Also close bottom sheet on mobile
            closeBottomSheet();
        }
        
        // ==================== HISTORY PANEL ====================
        function toggleHistory() {
            // Redirect to slide panel toggle (desktop) or bottom sheet (mobile)
            if (window.innerWidth <= 767) {
                toggleBottomSheet('history');
            } else {
                toggleSlidePanel('history');
            }
            // Render latest history when opening
            renderHistoryPanel();
        }
        
        function collapseHistory() {
            // Auto-collapse panels when guidance shows
            const historyPanel = dom.historySlidePanel;
            if (historyPanel) historyPanel.classList.remove('open');
            state.historyExpanded = false;
        }
        
        function toggleMobileHistory() {
            // Redirect to bottom sheet
            toggleBottomSheet('history');
            renderHistoryPanel();
        }
        
        function renderHistoryPanel() {
            const feed = dom.historyFeed;
            if (!feed) return;
            
            if (state.guidanceHistory.length === 0) {
                feed.innerHTML = '<div class="history-empty">No guidance yet</div>';
                syncHistoryToNav();
                return;
            }
            
            // Render in reverse order (newest first)
            const items = [...state.guidanceHistory].reverse();
            feed.innerHTML = items.map(item => {
                const time = item.relativeTime || '0:00';
                const text = formatGuidanceText(item.text || '');
                return `
                    <div class="history-item">
                        <div class="history-item-header">
                            <span class="history-time">${time}</span>
                        </div>
                        <div class="history-text">${text}</div>
                    </div>
                `;
            }).join('');
            
            // Sync to mobile sheet
            syncHistoryToNav();
        }
        
        function renderMobileHistoryPanel() {
            // Just calls renderHistoryPanel which syncs everywhere
            renderHistoryPanel();
        }
        
        function updateHistoryCount() {
            const count = state.guidanceHistory.length;
            
            // Update nav badges (sidebar/pill)
            const transcriptCount = dom.transcriptFeed ? 
                dom.transcriptFeed.querySelectorAll('.transcript-msg').length : 0;
            updateNavBadges(transcriptCount, count);
            
            // Sync history to mobile bottom sheet
            syncHistoryToNav();
        }
        
        function initTranscriptScroll() {
            if (dom.transcriptFeed) {
                // Track if user scrolls up manually
                dom.transcriptFeed.addEventListener('scroll', () => {
                    const { scrollTop, scrollHeight, clientHeight } = dom.transcriptFeed;
                    const isAtBottom = scrollTop + clientHeight >= scrollHeight - 50;
                    state.transcriptUserScrolled = !isAtBottom;
                    updateScrollFade();
                });
            }
        }
        
        // Legacy handler - route to transcript panel
        function updateCaption(speaker, text, isInterim) {
            if (speaker === 'caller' || speaker === 'client') {
                updateTranscriptSidebar('client', text, isInterim);
            } else if (speaker === 'agent') {
                updateTranscriptSidebar('agent', text, false);
            }
        }
        
        function resetCaptions() {
            // Clear transcript panel
            if (dom.transcriptFeed) {
                dom.transcriptFeed.innerHTML = '<div class="transcript-empty" id="transcriptEmpty">Waiting for conversation...</div>';
            }
            // Also clear mobile sheet
            if (dom.transcriptSheetFeed) {
                dom.transcriptSheetFeed.innerHTML = '<div class="transcript-empty">Waiting for conversation...</div>';
            }
            state.currentClientElement = null;
            state.currentClientText = '';
            state.transcriptUserScrolled = false;
        }
        
        // ==================== GUIDANCE ====================
        function handleBridge(msg) {
            // Show loading indicator - agents bridge naturally with their voice
            console.log('[BRIDGE] Objection detected, showing loading indicator');
            
            dom.listeningState.style.display = 'none';
            dom.teleprompter.classList.add('has-guidance');
            dom.guidanceText.innerHTML = '<div class="guidance-loading">    </div>';
            dom.guidanceState.classList.add('active');
            
            // Audio + haptic notification
            playNotificationSound();
            if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
            
            // Mark that we've already notified for this guidance
            state.hasVibratedForCurrentGuidance = true;
        }
        
        function handleGuidance(msg) {
            const text = msg.guidance || msg.text || '';
            if (!text) return;
            
            const action = msg.action || 'guide';
            
            // Extract the guidance text - Veteran Brain sends clean text now
            let displayText = text;
            
            // Clean up any SAY: prefix if present (legacy compatibility)
            if (displayText.toUpperCase().startsWith('SAY:')) {
                displayText = displayText.substring(4).trim();
            }
            // Clean up reminder prefix if present
            if (displayText.startsWith('')) {
                displayText = displayText.substring(2).trim();
            }
            // Clean up leading/trailing quotes
            displayText = displayText.replace(/^["']|["']$/g, '').trim();
            
            const now = Date.now();
            state.guidanceHistory.push({
                text: displayText,
                raw: text,
                action: action,
                timestamp: now,
                relativeTime: getCallRelativeTime(now)
            });
            
            // Update history count badge
            updateHistoryCount();
            
            showGuidance(displayText, action);
            
            // Only notify if we haven't already (e.g., from bridge)
            if (!state.hasVibratedForCurrentGuidance) {
                playNotificationSound();
                // Stronger vibration for strike/exit
                if (action === 'strike' || action === 'exit') {
                    if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 100]);
                } else {
                    if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
                }
            }
            state.hasVibratedForCurrentGuidance = false;
        }
        
        function handleGuidanceStart(msg) {
            console.log('[GUIDANCE_START] Buffering - waiting for valid marker');
            
            // DON'T show UI yet - buffer until we validate it's real guidance
            // This prevents "thinking out loud" from flashing on screen
            state.streamingGuidance = '';
            state.guidanceValidated = false;  // Wait for SAY: or  marker
            state.hasVibratedForCurrentGuidance = false;
        }
        
        function handleGuidanceChunk(msg) {
            const chunk = msg.text || msg.chunk || '';
            if (!chunk) return;
            
            state.streamingGuidance += chunk;
            const buffer = state.streamingGuidance.trim();
            const bufferUpper = buffer.toUpperCase();
            
            // Early abort patterns - Claude is reasoning, not guiding
            const ABORT_PATTERNS = [
                'NO_GUIDANCE', 'NO GUIDANCE', 
                'THE CLIENT', 'BASED ON', 'LOOKING AT', 'SINCE THE', 'GIVEN THE',
                'I NOTICE', 'IT SEEMS', 'IT APPEARS', 'THIS IS', 'LET ME',
                'ANALYZING', 'CONSIDERING', 'THE AGENT'
            ];
            
            for (const pattern of ABORT_PATTERNS) {
                if (bufferUpper.startsWith(pattern) || bufferUpper === 'NO') {
                    console.log('[GUIDANCE_CHUNK] Abort - reasoning detected:', buffer.substring(0, 30));
                    state.streamingGuidance = '';
                    state.guidanceValidated = false;
                    return;
                }
            }
            
            // Valid guidance markers - Claude is giving actual guidance
            const hasValidMarker = bufferUpper.startsWith('SAY:') || buffer.startsWith('') || buffer.startsWith('"');
            
            // If we haven't validated yet, check for marker
            if (!state.guidanceValidated) {
                if (hasValidMarker) {
                    console.log('[GUIDANCE_CHUNK] Valid marker found, showing guidance');
                    state.guidanceValidated = true;
                    
                    // NOW show UI and notify
                    playNotificationSound();
                    if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
                    state.hasVibratedForCurrentGuidance = true;
                    
                    dom.listeningState.style.display = 'none';
                    dom.teleprompter.classList.add('has-guidance');
                    dom.guidanceState.classList.add('active');
                } else if (buffer.length > 25) {
                    // Buffer getting long with no valid marker - abort
                    console.log('[GUIDANCE_CHUNK] No marker after 25 chars, aborting:', buffer.substring(0, 25));
                    state.streamingGuidance = '';
                    return;
                } else {
                    // Keep buffering silently
                    return;
                }
            }
            
            // Strip marker for display
            let displayText = buffer;
            if (bufferUpper.startsWith('SAY:')) {
                displayText = buffer.substring(4).trim();
            } else if (buffer.startsWith('')) {
                displayText = buffer.substring(2).trim();
            }
            
            dom.guidanceText.innerHTML = formatGuidanceText(displayText) + '<span class="cursor"></span>';
        }
        
        function handleGuidanceComplete(msg) {
            let fullText = msg.full_text || state.streamingGuidance || '';
            const trimmed = fullText.trim();
            const trimmedUpper = trimmed.toUpperCase();
            
            // Filter out non-guidance responses
            const ABORT_PATTERNS = ['NO_GUIDANCE', 'NO GUIDANCE', 'THE CLIENT', 'BASED ON', 
                'LOOKING AT', 'SINCE THE', 'GIVEN THE', 'I NOTICE', 'THE AGENT'];
            
            for (const pattern of ABORT_PATTERNS) {
                if (trimmedUpper.startsWith(pattern) || trimmedUpper === 'NO') {
                    console.log('[GUIDANCE_COMPLETE] Filtered out reasoning');
                    dismissGuidance();
                    return;
                }
            }
            
            if (!fullText || fullText.length < 10) {
                dismissGuidance();
                return;
            }
            
            // Strip SAY: marker if present
            if (trimmedUpper.startsWith('SAY:')) {
                fullText = trimmed.substring(4).trim();
            } else if (trimmed.startsWith('')) {
                fullText = trimmed.substring(2).trim();
            }
            
            const sayThis = extractSayThis(fullText);
            const now = Date.now();
            
            state.guidanceHistory.push({
                text: sayThis,
                raw: fullText,
                timestamp: now,
                relativeTime: getCallRelativeTime(now),
                objection_type: msg.objection_type
            });
            
            // Update history count badge
            updateHistoryCount();
            
            // Final display - no cursor
            const displayText = sayThis || fullText;
            
            // Ensure UI is shown (in case buffering skipped it)
            if (!state.guidanceValidated) {
                dom.listeningState.style.display = 'none';
                dom.teleprompter.classList.add('has-guidance');
                dom.guidanceState.classList.add('active');
            }
            
            // Add has-guidance to guidance-area for temp meter fade
            if (dom.guidanceArea) {
                dom.guidanceArea.classList.add('has-guidance');
            }
            
            // Collapse history panel when guidance shows
            collapseHistory();
            
            dom.guidanceText.innerHTML = formatGuidanceText(displayText);
            
            state.streamingGuidance = '';
            state.guidanceValidated = false;
            state.hasVibratedForCurrentGuidance = false;
            
            // Start fallback dismiss timer (45s) - Claude should dismiss sooner via guidance_dismiss
            clearTimeout(state.guidanceDismissTimer);
            state.guidanceDismissTimer = setTimeout(() => {
                console.log('[GUIDANCE] Fallback auto-dismiss after 45s');
                dismissGuidance();
            }, 45000);
        }
        
        function formatGuidanceText(text) {
            if (!text) return '';
            
            let formatted = text.replace(/(\$[\d,]+|\d+%|\d+,\d+)/g, '<strong>$1</strong>');
            
            const quotedMatch = formatted.match(/"([^"]+)"/);
            if (quotedMatch) {
                formatted = formatted.replace(
                    `"${quotedMatch[1]}"`, 
                    `<span class="say-this">"${quotedMatch[1]}"</span>`
                );
            }
            
            return formatted;
        }
        
        function extractSayThis(text) {
            const quotedMatch = text.match(/"([^"]+)"/);
            if (quotedMatch) return quotedMatch[1];
            
            const sayMatch = text.match(/SAY THIS[:\s]*(.+?)(?=\n|WHY|$)/is);
            if (sayMatch) return sayMatch[1].trim().replace(/^[""]|[""]$/g, '');
            
            return text
                .replace(/^[]\s*/gm, '')
                .replace(/^DETECTED:.*?\n/i, '')
                .replace(/^WHY:.*$/ims, '')
                .replace(/^SAY THIS:\s*/i, '')
                .trim() || text;
        }
        
        function showGuidance(text, action = 'guide') {
            dom.listeningState.style.display = 'none';
            dom.guidanceState.classList.remove('active', 'strike', 'exit', 'warn', 'show-hint');
            dom.teleprompter.classList.add('has-guidance');
            
            // Add has-guidance to guidance-area for temp meter fade
            if (dom.guidanceArea) {
                dom.guidanceArea.classList.add('has-guidance');
            }
            
            // Auto-collapse transcript and history when guidance shows
            collapseTranscript();
            collapseHistory();
            
            // Clear any existing dismiss hint timer
            clearTimeout(state.dismissHintTimer);
            
            // Add action-specific class for styling
            if (action === 'strike') {
                dom.guidanceState.classList.add('strike');
            } else if (action === 'exit') {
                dom.guidanceState.classList.add('exit');
            } else if (action === 'warn') {
                dom.guidanceState.classList.add('warn');
            }
            
            let formattedText = text.replace(/(\$[\d,]+|\d+%|\d+,\d+)/g, '<strong>$1</strong>');
            
            const quotedMatch = formattedText.match(/"([^"]+)"/);
            if (quotedMatch) {
                formattedText = formattedText.replace(
                    `"${quotedMatch[1]}"`, 
                    `<span class="say-this">"${quotedMatch[1]}"</span>`
                );
            }
            
            dom.guidanceText.innerHTML = formattedText;
            
            requestAnimationFrame(() => {
                dom.guidanceState.classList.add('active');
            });
            
            // Show dismiss hint after 3 seconds
            state.dismissHintTimer = setTimeout(() => {
                dom.guidanceState.classList.add('show-hint');
            }, 3000);
        }
        
        function dismissGuidance() {
            // Clear fallback timer
            clearTimeout(state.guidanceDismissTimer);
            state.guidanceDismissTimer = null;
            
            // Clear dismiss hint timer
            clearTimeout(state.dismissHintTimer);
            state.dismissHintTimer = null;
            
            dom.guidanceState.classList.remove('active', 'strike', 'exit', 'warn', 'show-hint');
            dom.listeningState.style.display = 'flex';
            dom.teleprompter.classList.remove('has-guidance');
            dom.guidanceText.innerHTML = '';
            state.streamingGuidance = '';
            state.hasVibratedForCurrentGuidance = false;
            
            // Remove has-guidance from guidance-area
            if (dom.guidanceArea) {
                dom.guidanceArea.classList.remove('has-guidance');
            }
        }
        
        // ==================== SENTIMENT ====================
        const SENTIMENT_CONFIG = {
            cold: { label: 'Cold', color: 'danger' },
            cooling: { label: 'Cooling', color: 'warning' },
            neutral: { label: 'Listening', color: 'neutral' },
            warming: { label: 'Engaged', color: 'accent' },
            hot: { label: 'Ready', color: 'success' }
        };
        
        const TRAJECTORY_SYMBOLS = {
            warming: '',
            cooling: '',
            stable: ''
        };
        
        function handleSentimentUpdate(msg) {
            const level = msg.level || 'neutral';
            const trajectory = msg.trajectory || 'stable';
            
            console.log('[SENTIMENT]', level, trajectory);
            
            // Update state
            state.currentSentiment = { level, trajectory };
            
            // Use the same meter update logic
            const meter = document.getElementById('tempMeter');
            const indicator = document.getElementById('tempIndicator');
            
            if (!meter || !indicator) return;
            
            // Show the meter
            meter.classList.add('visible');
            
            // Map level to position
            const positions = {
                hot: 5,
                warming: 25,
                neutral: 50,
                cooling: 75,
                cold: 95
            };
            
            const position = positions[level] ?? 50;
            indicator.style.top = `${position}%`;
            meter.setAttribute('data-level', level);
            
            // Zone labels
            if (level === 'hot') {
                meter.setAttribute('data-zone', 'close');
            } else if (level === 'cold') {
                meter.setAttribute('data-zone', 'exit');
            } else {
                meter.removeAttribute('data-zone');
            }
        }
        
        function resetSentiment() {
            state.currentSentiment = { level: 'neutral', trajectory: 'stable', tip: '' };
            state.sentimentVisible = false;
            
            // Reset temperature meter
            resetTemperatureMeter();
        }
        
        // ==================== VETERAN BRAIN HANDLER ====================
        function handleVeteranUpdate(msg) {
            const temperature = msg.temperature || 'neutral';
            const trajectory = msg.trajectory || 'stable';
            const action = msg.action || 'breathe';
            const hardExit = msg.hard_exit || false;
            const buyingSignal = msg.buying_signal || false;
            const objectionCount = msg.objection_count || 0;
            
            console.log('[VETERAN]', temperature, trajectory, action, hardExit ? 'HARD_EXIT!' : '', buyingSignal ? 'BUYING_SIGNAL!' : '');
            
            // Update state
            state.currentSentiment = { level: temperature, trajectory, action };
            
            // Get the meter elements
            const meter = document.getElementById('tempMeter');
            const indicator = document.getElementById('tempIndicator');
            
            if (!meter || !indicator) return;
            
            // Show the meter
            meter.classList.add('visible');
            
            // Map temperature to position (0% = top/close, 100% = bottom/exit)
            const positions = {
                hot: 5,       // Near top
                warming: 25,
                neutral: 50,  // Middle
                cooling: 75,
                cold: 95      // Near bottom
            };
            
            const position = positions[temperature] ?? 50;
            indicator.style.top = `${position}%`;
            
            // Set data attributes for styling
            meter.setAttribute('data-level', temperature);
            meter.removeAttribute('data-action');
            meter.removeAttribute('data-zone');
            
            // Zone labels (which end is active)
            if (temperature === 'hot' || buyingSignal) {
                meter.setAttribute('data-zone', 'close');
            } else if (temperature === 'cold' || hardExit) {
                meter.setAttribute('data-zone', 'exit');
            }
            
            // Action state for pulse animation
            if (action === 'strike' || buyingSignal) {
                meter.setAttribute('data-action', 'strike');
            } else if (action === 'exit' || hardExit) {
                meter.setAttribute('data-action', 'exit');
            }
        }
        
        function resetTemperatureMeter() {
            const meter = document.getElementById('tempMeter');
            const indicator = document.getElementById('tempIndicator');
            
            if (meter) {
                meter.classList.remove('visible');
                meter.removeAttribute('data-level');
                meter.removeAttribute('data-action');
                meter.removeAttribute('data-zone');
            }
            if (indicator) {
                indicator.style.top = '50%';
            }
        }
        
        // ==================== SESSION COMPLETE ====================
        function startNewCall() {
            console.log('[StartNewCall] Resetting for new call');
            try {
                dom.timer.textContent = '0:00';
                // Also reset mobile timer
                const mobileTimer = document.getElementById('mobileTimer');
                if (mobileTimer) mobileTimer.textContent = '0:00';
                state.guidanceHistory = [];
                state.selectedTipIndex = null;
                state.sessionId = null;
                state.clientPhone = null;
                state.seconds = 0;
                state.callStartTime = null;
                state.isInCall = false;
                state.historyExpanded = false;
                state.mobileHistoryExpanded = false;
                if (state.ws) {
                    state.ws.close();
                    state.ws = null;
                }
                if (dom.clientPhoneInput) dom.clientPhoneInput.value = '';
                
                // Hide end button
                if (dom.endSessionBtn) {
                    dom.endSessionBtn.classList.remove('show');
                }
                
                // Collapse transcript panel
                collapseTranscript();
                
                // Collapse and reset history panels
                collapseHistory();
                if (dom.mobileHistorySheet) dom.mobileHistorySheet.classList.remove('expanded');
                if (dom.historySheetBackdrop) dom.historySheetBackdrop.classList.remove('visible');
                updateHistoryCount();
                
                dismissGuidance();
                resetCaptions();
                resetSentiment();
                resetConnectionSteps();
                console.log('[StartNewCall] Showing start screen');
                showScreen('startScreen');
            } catch (err) {
                console.error('[StartNewCall] Error:', err);
                // Force show start screen even if something failed
                showScreen('startScreen');
            }
        }
        
        function goHome() {
            showPageLoader();
            setTimeout(() => {
                window.location.href = '/';
            }, 150);
        }
        
        function handleBack() {
            console.log('[HandleBack] Current state:', {
                isInCall: state.isInCall,
                connectingActive: dom.connectingScreen?.classList.contains('active'),
                completeActive: dom.completeScreen?.classList.contains('active'),
                startActive: dom.startScreen?.classList.contains('active'),
                identifyActive: dom.identifyScreen?.classList.contains('active')
            });
            try {
                if (state.isInCall) {
                    if (confirm('End this session?')) endCall();
                } else if (dom.connectingScreen?.classList.contains('active')) {
                    cancelCall();
                } else if (dom.completeScreen?.classList.contains('active')) {
                    startNewCall();
                } else if (dom.startScreen?.classList.contains('active')) {
                    goHome();
                } else if (dom.identifyScreen?.classList.contains('active')) {
                    showPageLoader();
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 150);
                } else {
                    // Fallback: go home if no known state
                    console.log('[HandleBack] Unknown state, going home');
                    goHome();
                }
            } catch (err) {
                console.error('[HandleBack] Error:', err);
                goHome();
            }
        }
        
        // ==================== PAGE LOADER ====================
        function showPageLoader() {
            const loader = document.getElementById('pageLoader');
            if (loader) loader.classList.remove('hidden');
        }
        
        function hidePageLoader() {
            const loader = document.getElementById('pageLoader');
            if (loader) loader.classList.add('hidden');
        }
        
        // Hide loader on page load
        window.addEventListener('load', () => {
            setTimeout(hidePageLoader, 300);
        });
        
        // ==================== SIDEBAR & MOBILE NAV ====================
        
        // Toggle body class for in-call state (controls nav transformation)
        function setInCallState(isInCall) {
            if (isInCall) {
                document.body.classList.add('in-call');
            } else {
                document.body.classList.remove('in-call');
            }
        }
        
        // Desktop slide panel toggle
        function toggleSlidePanel(type) {
            const transcriptPanel = document.getElementById('transcriptSlidePanel');
            const historyPanel = document.getElementById('historySlidePanel');
            const transcriptBtn = document.getElementById('sidebarTranscriptBtn');
            const historyBtn = document.getElementById('sidebarHistoryBtn');
            
            if (type === 'transcript') {
                const isOpen = transcriptPanel.classList.contains('open');
                transcriptPanel.classList.toggle('open');
                historyPanel.classList.remove('open');
                if (transcriptBtn) transcriptBtn.classList.toggle('active', !isOpen);
                if (historyBtn) historyBtn.classList.remove('active');
            } else if (type === 'history') {
                const isOpen = historyPanel.classList.contains('open');
                historyPanel.classList.toggle('open');
                transcriptPanel.classList.remove('open');
                if (historyBtn) historyBtn.classList.toggle('active', !isOpen);
                if (transcriptBtn) transcriptBtn.classList.remove('active');
            }
        }
        
        // Mobile bottom sheet toggle
        function toggleBottomSheet(type) {
            const backdrop = document.getElementById('bottomSheetBackdrop');
            const transcriptSheet = document.getElementById('transcriptBottomSheet');
            const historySheet = document.getElementById('historyBottomSheet');
            
            const transcriptOpen = transcriptSheet.classList.contains('open');
            const historyOpen = historySheet.classList.contains('open');
            
            // Close all first
            transcriptSheet.classList.remove('open');
            historySheet.classList.remove('open');
            
            if (type === 'transcript' && !transcriptOpen) {
                transcriptSheet.classList.add('open');
                backdrop.classList.add('visible');
            } else if (type === 'history' && !historyOpen) {
                historySheet.classList.add('open');
                backdrop.classList.add('visible');
            } else {
                backdrop.classList.remove('visible');
            }
        }
        
        function closeBottomSheet() {
            document.getElementById('bottomSheetBackdrop').classList.remove('visible');
            document.getElementById('transcriptBottomSheet').classList.remove('open');
            document.getElementById('historyBottomSheet').classList.remove('open');
        }
        
        // Update badges on sidebar and mobile pill
        function updateNavBadges(transcriptCount, historyCount) {
            // Desktop sidebar
            const sidebarTranscript = document.getElementById('sidebarTranscriptBadge');
            const sidebarHistory = document.getElementById('sidebarHistoryBadge');
            if (sidebarTranscript) {
                sidebarTranscript.textContent = transcriptCount;
                sidebarTranscript.classList.toggle('empty', transcriptCount === 0);
            }
            if (sidebarHistory) {
                sidebarHistory.textContent = historyCount;
                sidebarHistory.classList.toggle('empty', historyCount === 0);
            }
            
            // Mobile pill
            const pillTranscript = document.getElementById('pillTranscriptBadge');
            const pillHistory = document.getElementById('pillHistoryBadge');
            if (pillTranscript) {
                pillTranscript.textContent = transcriptCount;
                pillTranscript.classList.toggle('empty', transcriptCount === 0);
            }
            if (pillHistory) {
                pillHistory.textContent = historyCount;
                pillHistory.classList.toggle('empty', historyCount === 0);
            }
        }
        
        // Sync transcript content to mobile bottom sheet
        function syncTranscriptToNav() {
            const mainFeed = dom.transcriptFeed;
            const sheetFeed = dom.transcriptSheetFeed;
            
            if (mainFeed && sheetFeed) {
                sheetFeed.innerHTML = mainFeed.innerHTML;
            }
            
            // Update badges
            const transcriptCount = mainFeed ? 
                mainFeed.querySelectorAll('.transcript-msg').length : 0;
            const historyCount = state.guidanceHistory.length;
            updateNavBadges(transcriptCount, historyCount);
        }
        
        // Sync history content to mobile bottom sheet
        function syncHistoryToNav() {
            const mainFeed = dom.historyFeed;
            const sheetFeed = dom.historySheetFeed;
            
            if (mainFeed && sheetFeed) {
                sheetFeed.innerHTML = mainFeed.innerHTML;
            }
        }
        
        // ==================== CHAT (uses Chat module) ====================
        // Chat module is already loaded - just connect it to agency code
        Chat.setAgencyCodeGetter(() => state.validatedAgencyCode || state.agency?.code);
        
        // Initialize
        init();
        
        // ==================== MODE SWITCHING ====================
        function switchMode(mode) {
            state.currentMode = mode;
            
            // Update toggle buttons
            document.querySelectorAll('.mode-toggle-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
            
            // Show/hide content
            document.getElementById('presentationMode').style.display = mode === 'presentation' ? 'block' : 'none';
            document.getElementById('dialerMode').style.display = mode === 'dialer' ? 'block' : 'none';
            
            // Update dialer phone display
            if (mode === 'dialer' && state.agentPhone) {
                document.getElementById('dialerPhoneDisplay').textContent = formatPhone(state.agentPhone);
            }
        }
        
        // ==================== POWER DIALER ====================
        const dialerState = {
            sessionId: null,
            contacts: [],
            index: 0,
            appointments: 0,
            startTime: null,
            script: `<p><strong>Opening:</strong> "Hi, is this [Name]? This is [Agent] from Globe Life. [Sponsor] suggested I call."</p><p><strong>Close:</strong> "Got 2 minutes to see if you qualify?"</p>`
        };
        
        function parseDialerContacts() {
            const textarea = document.getElementById('dialerContactsInput');
            const lines = textarea.value.trim().split('\n').filter(l => l.trim());
            
            dialerState.contacts = lines.map((line, i) => {
                const phoneMatch = line.match(/[\d\-\(\)\.\s]{10,}/);
                const phone = phoneMatch ? phoneMatch[0].replace(/\D/g, '') : '';
                const name = line.replace(phoneMatch ? phoneMatch[0] : '', '').trim() || `Contact ${i+1}`;
                const formattedPhone = phone.length === 10 ? `+1${phone}` : (phone.length === 11 ? `+${phone}` : '');
                return { id: i+1, name, phone: formattedPhone };
            }).filter(c => c.phone.length >= 11);
            
            const count = dialerState.contacts.length;
            document.getElementById('dialerCount').textContent = ` ${count} contact${count !== 1 ? 's' : ''}`;
            
            // Clear error state when user types valid contacts
            if (count > 0) {
                textarea.classList.remove('error');
            }
        }
        
        function clearDialerContacts() {
            const textarea = document.getElementById('dialerContactsInput');
            textarea.value = '';
            textarea.classList.remove('error');
            dialerState.contacts = [];
            document.getElementById('dialerCount').textContent = ' 0 contacts';
        }
        
        async function dialerPhoto(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Show loading state
            const cameraBtn = document.querySelector('.dialer-camera-btn');
            if (cameraBtn) cameraBtn.style.opacity = '0.5';
            
            const formData = new FormData();
            formData.append('image', file);
            
            try {
                const res = await fetch('/api/dialer/parse-image', { method: 'POST', body: formData });
                
                if (!res.ok) {
                    throw new Error(`Server error: ${res.status}`);
                }
                
                const data = await res.json();
                
                if (data.success === false) {
                    throw new Error(data.error || 'Could not parse contacts from image');
                }
                
                if (data.contacts && data.contacts.length > 0) {
                    dialerState.contacts = data.contacts;
                    document.getElementById('dialerContactsInput').value = data.contacts.map(c => `${c.name} ${formatPhone(c.phone)}`).join('\n');
                    parseDialerContacts();
                } else {
                    showErrorModal('No Contacts Found', 'Could not find any contacts in the image. Try typing them manually.');
                }
            } catch (err) {
                console.error('Photo parse error:', err);
                showErrorModal('Image Error', err.message || 'Failed to read image. Please try again or type contacts manually.');
            } finally {
                if (cameraBtn) cameraBtn.style.opacity = '1';
                event.target.value = '';
            }
        }
        
        function dialerShowScreen(screenId) {
            ['startScreen', 'dialerActiveScreen', 'dialerCompleteScreen'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.toggle('active', id === screenId);
            });
        }
        
        async function dialerStart() {
            const textarea = document.getElementById('dialerContactsInput');
            
            // Show error animation if no contacts
            if (dialerState.contacts.length === 0) {
                textarea.classList.remove('error');
                void textarea.offsetWidth; // Force reflow to restart animation
                textarea.classList.add('error');
                textarea.focus();
                return;
            }
            
            dialerState.index = 0;
            dialerState.appointments = 0;
            dialerState.startTime = Date.now();
            
            // Set up script
            document.getElementById('dialerScriptBody').innerHTML = dialerState.script;
            
            // Show active screen
            dialerShowScreen('dialerActiveScreen');
            dialerUpdateProgress();
            dialerShowContact();
            dialerSetStatus('waiting', 'Calling you...');
            
            // Initialize appointment date
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('dialerApptDate').value = tomorrow.toISOString().split('T')[0];
            
            try {
                const res = await fetch('/api/dialer/start-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        agent_phone: state.agentPhone,
                        list_type: 'referrals',
                        contacts: dialerState.contacts
                    })
                });
                const data = await res.json();
                if (data.success) {
                    dialerState.sessionId = data.session_id;
                    dialerSetStatus('ringing', 'Answer phone');
                }
            } catch (e) {
                console.error('Dialer start error:', e);
            }
        }
        
        function dialerShowContact() {
            const contact = dialerState.contacts[dialerState.index];
            if (contact) {
                document.getElementById('dialerContactName').textContent = contact.name;
                document.getElementById('dialerContactPhone').textContent = formatPhone(contact.phone);
                const sponsorEl = document.getElementById('dialerContactSponsor');
                if (contact.sponsor) {
                    sponsorEl.textContent = `Referred by ${contact.sponsor}`;
                    sponsorEl.style.display = 'block';
                } else {
                    sponsorEl.style.display = 'none';
                }
            }
        }
        
        function dialerSetStatus(type, text) {
            document.getElementById('dialerCallStatus').className = `dialer-call-status ${type}`;
            document.getElementById('dialerStatusText').textContent = text;
        }
        
        function dialerUpdateProgress() {
            const percent = dialerState.contacts.length ? (dialerState.index / dialerState.contacts.length) * 100 : 0;
            document.getElementById('dialerProgressFill').style.width = `${percent}%`;
            document.getElementById('dialerProgressText').textContent = `${dialerState.index}/${dialerState.contacts.length}`;
        }
        
        function dialerToggleScript() {
            document.getElementById('dialerScriptToggle').classList.toggle('open');
            document.getElementById('dialerScriptBody').classList.toggle('open');
        }
        
        async function dialerDial() {
            if (!dialerState.sessionId) return;
            
            dialerSetStatus('ringing', 'Dialing...');
            document.getElementById('dialerDialBtn').disabled = true;
            document.getElementById('dialerCallActions').style.display = 'flex';
            document.getElementById('dialerDispSection').classList.remove('active');
            
            try {
                const res = await fetch('/api/dialer/dial-next', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: dialerState.sessionId })
                });
                const data = await res.json();
                if (data.success) {
                    setTimeout(() => {
                        dialerSetStatus('connected', 'Connected');
                        document.getElementById('dialerCallActions').style.display = 'none';
                        document.getElementById('dialerDispSection').classList.add('active');
                    }, 2000);
                } else if (data.complete) {
                    dialerEnd();
                }
            } catch (e) {
                console.error('Dial error:', e);
            }
        }
        
        async function dialerSkip() {
            if (dialerState.sessionId) {
                try {
                    await fetch('/api/dialer/skip', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ session_id: dialerState.sessionId })
                    });
                } catch (e) {}
            }
            
            dialerState.index++;
            dialerUpdateProgress();
            
            if (dialerState.index >= dialerState.contacts.length) {
                dialerEnd();
            } else {
                dialerShowContact();
                dialerResetUI();
            }
        }
        
        function dialerDisp(type) {
            if (type === 'appointment') {
                document.getElementById('dialerModal').classList.add('open');
            } else {
                dialerSaveDisp(type);
            }
        }
        
        async function dialerSaveDisp(type, date, time) {
            const contact = dialerState.contacts[dialerState.index];
            
            try {
                await fetch('/api/dialer/disposition', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: dialerState.sessionId,
                        contact_id: contact.id,
                        disposition: type,
                        scheduled_date: date,
                        scheduled_time: time
                    })
                });
            } catch (e) {}
            
            if (type === 'appointment') dialerState.appointments++;
            
            dialerState.index++;
            dialerUpdateProgress();
            
            if (dialerState.index >= dialerState.contacts.length) {
                dialerEnd();
            } else {
                dialerShowContact();
                dialerResetUI();
            }
        }
        
        function dialerResetUI() {
            document.getElementById('dialerCallActions').style.display = 'flex';
            document.getElementById('dialerDispSection').classList.remove('active');
            document.getElementById('dialerDialBtn').disabled = false;
            dialerSetStatus('waiting', 'Ready');
        }
        
        function dialerCloseModal() {
            document.getElementById('dialerModal').classList.remove('open');
        }
        
        function dialerSaveAppt() {
            dialerCloseModal();
            dialerSaveDisp('appointment', document.getElementById('dialerApptDate').value, document.getElementById('dialerApptTime').value);
        }
        
        async function dialerEnd() {
            if (dialerState.sessionId) {
                try {
                    await fetch('/api/dialer/end-session', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ session_id: dialerState.sessionId })
                    });
                } catch (e) {}
            }
            
            const seconds = Math.floor((Date.now() - dialerState.startTime) / 1000);
            document.getElementById('dialerStatCalls').textContent = dialerState.index;
            document.getElementById('dialerStatAppts').textContent = dialerState.appointments;
            document.getElementById('dialerStatTime').textContent = `${Math.floor(seconds/60)}:${(seconds%60).toString().padStart(2,'0')}`;
            
            dialerShowScreen('dialerCompleteScreen');
        }
        
        function dialerReset() {
            dialerState.sessionId = null;
            dialerState.contacts = [];
            dialerState.index = 0;
            dialerState.appointments = 0;
            dialerState.startTime = null;
            
            const textarea = document.getElementById('dialerContactsInput');
            textarea.value = '';
            textarea.classList.remove('error');
            document.getElementById('dialerCount').textContent = ' 0 contacts';
            
            dialerShowScreen('startScreen');
        }
        
        // ==================== PUBLIC API ====================
        return {
            startCall,
            cancelCall,
            endCall,
            dismissGuidance,
            startNewCall,
            goHome,
            handleBack,
            saveIdentity,
            changeAgent,
            setCallType,
            closeErrorModal,
            toggleTranscript,
            // History panel
            toggleHistory,
            toggleMobileHistory,
            // Verification
            setVerifyMethod,
            sendVerifyCode,
            handleCodeInput,
            confirmVerifyCode,
            resendCode,
            showVerifyState,
            closeVerifyModal,
            // New nav methods
            toggleSlidePanel,
            toggleBottomSheet,
            closeBottomSheet,
            // Mode switching
            switchMode,
            // Power Dialer
            parseDialerContacts,
            clearDialerContacts,
            dialerPhoto,
            dialerStart,
            dialerDial,
            dialerSkip,
            dialerDisp,
            dialerToggleScript,
            dialerCloseModal,
            dialerSaveAppt,
            dialerEnd,
            dialerReset,
            getState: () => state
        };
    })();
    
    function handleBack() {
        Coachd.handleBack();
    }
    </script>
</body>
</html>
